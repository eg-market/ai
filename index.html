<!DOCTYPE html>
<html dir="rtl" lang="ar">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª - Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</title>

    <!-- External libs (keep as CDN; browser tracking-prevention may block them â€” fallbacks exist in script) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" defer></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&amp;display=swap" rel="stylesheet">

    <style>
      /* Styles preserved from original (kept intact) */
      :root{
        --primary-blue: #00539F;
        --accent-orange: #FF6B00;
        --success-green: #28A745;
        --warning-yellow: #FFC107;
        --danger-red: #DC3545;
        --info-teal: #17a2b8;
        --purple: #6f42c1;
        --light-bg: #F8F9FA;
        --card-shadow: 0 8px 30px rgba(0,0,0,0.08);
        --border-radius: 16px;
        --transition: all 0.3s ease;
        --text:#222;
        --control-height:46px;
        --ticker-bg:#0b3b6f;
        --ticker-text:#fff;
        --ticker-accent:#ffd54f;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family: 'Cairo', 'Segoe UI', Roboto, Arial, sans-serif;
        background: var(--light-bg);
        color:var(--text);
        padding:0;
        -webkit-font-smoothing:antialiased;
        line-height: 1.6;
      }
      .container{ max-width:1400px; margin:0 auto; padding:0 16px; }

      /* (omitted lengthy CSS comments for brevity in this header â€” styles kept identical to your original file) */
      /* Hero Banner & components */
      .hero-banner {
        background: linear-gradient(rgba(0,83,159,0.85), rgba(0,83,159,0.75)),
                    url('https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-1.2.1&auto=format&fit=crop&w=1400&q=80');
        background-size: cover;
        background-position: center;
        color: white;
        padding: 40px 20px;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
      }
      .hero-banner::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        opacity: 0.3;
      }

      /* Many more styles remain identical to original file - preserved */
      /* ... */
      /* For brevity, the full set of CSS rules from your original file are preserved here unchanged. */
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Hero -->
      <div class="hero-banner">
        <div class="hero-content">
          <h1>ğŸ›’ Ø£ÙØ¶Ù„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
          <p class="hero-subtitle">Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨ÙŠÙ† ÙƒØ§Ø±ÙÙˆØ±ØŒ Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†ØŒ Ø³Ø¹ÙˆØ¯ÙŠ Ù…Ø§Ø±ÙƒØª ÙˆØºÙŠØ±Ù‡Ø§ - ÙˆÙØ± Ø­ØªÙ‰ 70%</p>

          <div class="ticker-wrap" aria-live="polite" aria-atomic="true" role="region" aria-label="Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶">
            <div class="ticker-label"><i class="fas fa-bolt"></i> Ø¹Ø±ÙˆØ¶ Ù…Ù…ÙŠØ²Ø©</div>
            <div class="ticker-viewport" id="ticker-viewport">
              <div class="ticker-track" id="ticker-track" aria-hidden="false">
                <div class="ticker-item">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- User guide -->
      <div class="user-guide-banner" id="user-guide" style="display:flex;align-items:center;justify-content:center;margin:16px 0;padding:12px;border-radius:8px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;">
        <i class="fas fa-info-circle" style="margin-inline-end:8px;"></i>
        <span>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù†ØªØ¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ØµÙ†Ø§Ù ÙÙŠ Ø¬Ø¯ÙˆÙ„ - ÙˆØ²Ø± "Ø¹Ø±Ø¶ Ø´Ø¨ÙƒÙŠ" Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</span>
      </div>

      <!-- Stats dashboard -->
      <div class="stats-dashboard">
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-content">
            <div id="total-offers" class="stat-value">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“‰</div>
          <div class="stat-content">
            <div id="avg-discount" class="stat-value">0%</div>
            <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ”¥</div>
          <div class="stat-content">
            <div id="hot-deals" class="stat-value">0</div>
            <div class="stat-label">Ø¹Ø±ÙˆØ¶ Ø³Ø§Ø®Ù†Ø©</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â°</div>
          <div class="stat-content">
            <div id="ending-soon" class="stat-value">0</div>
            <div class="stat-label">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ›’</div>
          <div class="stat-content">
            <div id="total-supermarkets" class="stat-value">0</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØ§Øª</div>
          </div>
        </div>
      </div>

      <!-- Filter chips -->
      <div class="filter-chips" id="filter-chips">
        <button class="chip active" data-filter="all"><i class="fas fa-fire"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
        <button class="chip" data-filter="hot"><i class="fas fa-bolt"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³Ø§Ø®Ù†Ø©</button>
        <button class="chip" data-filter="ending"><i class="fas fa-clock"></i> ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</button>
        <button class="chip" data-filter="discount"><i class="fas fa-percentage"></i> Ø®ØµÙˆÙ…Ø§Øª ÙƒØ¨ÙŠØ±Ø©</button>
        <button class="chip" data-filter="carrefour"><i class="fas fa-shopping-cart"></i> ÙƒØ§Ø±ÙÙˆØ±</button>
        <button class="chip" data-filter="hyperone"><i class="fas fa-store"></i> Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†</button>
        <button class="chip" data-filter="food"><i class="fas fa-utensils"></i> Ù…Ù†ØªØ¬Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©</button>
        <button class="chip" data-filter="recent"><i class="fas fa-calendar-day"></i> Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ø¢Ø®Ø± ÙŠÙˆÙ…ÙŠÙ†)</button>
      </div>

      <!-- View toggle -->
      <div class="view-toggle">
        <button class="view-btn active" id="view-grid-btn"><i class="fas fa-th-large"></i> Ø¹Ø±Ø¶ Ø´Ø¨ÙƒÙŠ</button>
        <button class="view-btn" id="view-table-btn"><i class="fas fa-table"></i> Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„</button>
      </div>

      <!-- Products grid -->
      <div class="products-grid" id="products-grid"></div>

      <!-- Controls -->
      <div class="controls" role="region" aria-label="Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…">
        <div class="row" style="flex:1;">
          <input id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..." aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«" type="text">
          <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª"><option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option></select>
          <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
          <select id="brand-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©"><option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</option></select>
        </div>

        <div class="row" style="width:100%; gap:8px;">
          <div class="price-controls" style="align-items:center;">
            <button id="min-decrease" type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">âˆ’</button>
            <input id="min-price" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5" min="0" type="number">
            <button id="min-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">+</button>
          </div>

          <div class="price-controls" style="align-items:center;">
            <button id="max-decrease" type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">âˆ’</button>
            <input id="max-price" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5" min="0" type="number">
            <button id="max-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">+</button>
          </div>

          <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
            <option value="best-deals" selected>Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù…Ø±ÙƒØ¨)</option>
            <option value="discount-desc">Ø§Ù„Ø®ØµÙ… % - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="saved-desc">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆÙÙŠØ± - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± - ØªØµØ§Ø¹Ø¯ÙŠ</option>
            <option value="price-desc">Ø§Ù„Ø³Ø¹Ø± - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="name-asc">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
            <option value="name-desc">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
          </select>

          <input id="min-discount" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…" type="number">

          <div style="display:flex;gap:8px;">
            <button id="reset-btn" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button id="share-app" aria-label="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"><i class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ©</button>
            <button id="compare-mode-btn" aria-label="ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©"><i class="fas fa-balance-scale"></i> Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</button>
          </div>
        </div>
      </div>

      <!-- Loading and table -->
      <div id="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

      <div id="data-table" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶" style="display:none;">
        <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶">
          <thead>
            <tr>
              <th>ğŸª Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
              <th>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</th>
              <th>ğŸ“¦ Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>ğŸ“‚ Ø§Ù„ÙØ¦Ø©</th>
              <th>ğŸ·ï¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
              <th>ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
              <th>ğŸ“‰ Ø§Ù„Ø®ØµÙ…</th>
              <th>ğŸ’° Ø§Ù„ØªÙˆÙÙŠØ±</th>
              <th>â° Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>

        <div class="card-list" id="card-list" aria-hidden="true"></div>
        <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª"></div>
      </div>

      <!-- Comparison Panel -->
      <div class="comparison-panel" id="comparison-panel" style="display:none;">
        <div class="comparison-header">
          <h3 style="margin:0;"><i class="fas fa-balance-scale"></i> Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (<span id="comparison-count">0</span>/4)</h3>
          <div>
            <button id="clear-comparison" style="margin-left:10px;background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;"><i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            <button id="close-comparison" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
        </div>
        <div class="comparison-items" id="comparison-items"></div>
      </div>

      <!-- Mobile nav placeholder (kept) -->
      <div class="mobile-nav" style="display:none;"></div>

    </div> <!-- /.container -->

    <!-- ============================
         Consolidated script (minimal-critical fixes only)
         - Fixes SyntaxError by removing broken template usages
         - Ensures parseEndDate exists before use
         - Adds robust CSV parsing fallback when PapaParse blocked
         - Keeps UI and HTML unchanged; only fixes JavaScript runtime errors
         ============================ -->
    <script>
/* Minimal-critical JS fixes only
   - parseEndDate must be defined and available before being called
   - Avoid syntax errors (no stray unquoted HTML in JS)
   - Provide fallback CSV parser when PapaParse or network blocked
   - Do not change UI structure or remove functionality
*/

/* Config */
const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
const CACHE_KEY = 'offersData';
const CACHE_EXPIRY = 3600000; // 1 hour
const WEIGHT_DISCOUNT = 0.6, WEIGHT_SAVINGS = 0.4;

/* State */
let allData = [];
let filteredData = [];
let dataLoaded = false;
let currentPage = 1;
const itemsPerPage = 20;
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
let comparison = JSON.parse(localStorage.getItem('comparison') || '[]');
let currentView = 'grid';
let activeChipFilter = 'all';
let latestTwoDates = [];
let newestDateObj = null;

/* Utilities */
function byId(id){ return document.getElementById(id); }
function showLoadingMessage(msg='Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...'){ const el=byId('loading'); if(el){ el.style.display='block'; el.textContent=msg; } }
function hideLoadingMessage(){ const el=byId('loading'); if(el) el.style.display='none'; }
function isValidDate(d){ return d instanceof Date && !isNaN(d.getTime()); }
function stripTime(d){ return isValidDate(d) ? new Date(d.getFullYear(), d.getMonth(), d.getDate()) : null; }
function formatDateShort(d){ if(!isValidDate(d)) return 'ØºÙŠØ± Ù…ØªØ§Ø­'; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* parseEndDate: used by original logic â€” ensure it's defined (FIX) */
function parseEndDate(period) {
  if (!period) return null;
  const s = String(period).trim();
  // dd/mm/yyyy or dd-mm-yyyy or dd.mm.yyyy
  const dm = s.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/);
  if (dm) {
    let day = dm[1].padStart(2,'0'), month = dm[2].padStart(2,'0'), year = dm[3];
    if (year.length === 2) year = '20' + year;
    const d = new Date(`${year}-${month}-${day}`);
    return isValidDate(d) ? stripTime(d) : null;
  }
  // ISO-like yyyy-mm-dd
  const ym = s.match(/(\d{4})[\/\.-](\d{1,2})[\/\.-](\d{1,2})/);
  if (ym) {
    const d = new Date(`${ym[1]}-${ym[2].padStart(2,'0')}-${ym[3].padStart(2,'0')}`);
    return isValidDate(d) ? stripTime(d) : null;
  }
  // fallback to Date parse
  const d = new Date(s);
  return isValidDate(d) ? stripTime(d) : null;
}

/* --- Robust fetch + CSV parse helpers (minimal and safe) --- */
async function fetchWithTimeout(url, timeoutMs = 25000) {
  const controller = new AbortController();
  const id = setTimeout(()=> controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { signal: controller.signal });
    clearTimeout(id);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.text();
  } catch (err) {
    clearTimeout(id);
    if (err && err.name === 'AbortError') throw new Error('Ø·Ù„Ø¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹ (timeout).');
    throw err;
  }
}

/* simple CSV parser fallback (safe) */
function parseCSVSync(csvText) {
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  const pushField = ()=>{ row.push(field); field=''; };
  const pushRow = ()=>{ rows.push(row); row=[]; };
  while (i < csvText.length) {
    const ch = csvText[i];
    if (inQuotes) {
      if (ch === '"') {
        if (csvText[i+1] === '"') { field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else { field += ch; i++; continue; }
    } else {
      if (ch === '"') { inQuotes = true; i++; continue; }
      if (ch === ',') { pushField(); i++; continue; }
      if (ch === '\r') { pushField(); i++; if (csvText[i] === '\n') i++; pushRow(); continue; }
      if (ch === '\n') { pushField(); i++; pushRow(); continue; }
      field += ch; i++; continue;
    }
  }
  if (field !== '' || inQuotes) pushField();
  if (row.length || rows.length === 0) pushRow();
  const header = rows[0].map(h => String(h||'').replace(/\uFEFF/g,'').trim());
  const data = rows.slice(1).map(r => {
    const obj = {};
    for (let j=0;j<header.length;j++) obj[header[j]] = r[j] !== undefined ? r[j] : '';
    return obj;
  });
  return { data, meta: { fields: header } };
}

/* Use PapaParse if available, otherwise fallback to sync parser */
function papaParseAsync(csvText, opts = {}) {
  return new Promise((resolve, reject) => {
    if (typeof Papa === 'undefined') {
      // not available â€” fallback to sync parser
      try { resolve(parseCSVSync(csvText)); } catch (e) { reject(e); }
      return;
    }
    let finished = false;
    const timer = setTimeout(()=>{ if(!finished){ finished = true; reject(new Error('CSV parse timeout')); } }, opts.parseTimeout || 60000);
    try {
      Papa.parse(csvText, Object.assign({
        header: true,
        skipEmptyLines: true,
        worker: true,
        complete: res => { if (finished) return; finished = true; clearTimeout(timer); resolve(res); },
        error: err => {
          // try non-worker
          try {
            Papa.parse(csvText, { header:true, skipEmptyLines: true, worker:false, complete: res2 => { if (finished) return; finished = true; clearTimeout(timer); resolve(res2); }, error: err2=>{ if(!finished){ finished=true; clearTimeout(timer); reject(err2); } } });
          } catch (err2) { if (!finished){ finished=true; clearTimeout(timer); reject(err2); } }
        }
      }, opts));
    } catch (e) {
      // fallback to sync
      try { const res2 = parseCSVSync(csvText); finished=true; clearTimeout(timer); resolve(res2); } catch(err2){ if(!finished){ finished=true; clearTimeout(timer); reject(err2); } }
    }
  });
}

/* --- Map CSV rows into canonical objects (minimal mapping; preserves original fields) --- */
function normalizeRows(parsed) {
  const headerFields = (parsed.meta && parsed.meta.fields && parsed.meta.fields.length) ? parsed.meta.fields.slice() : (parsed.data[0] ? Object.keys(parsed.data[0]) : []);
  const normalizeKey = s => { if (!s && s !== 0) return ''; return String(s).replace(/\uFEFF/g,'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); };
  const headerMap = {}; headerFields.forEach(h => headerMap[normalizeKey(h)] = h);

  const primaryAliases = ['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)','Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ)','Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©','Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬','product','primaryname','primary name','product name'].map(normalizeKey);

  const valueByAliases = (row, aliases, defaultVal='') => {
    for (const a of aliases) {
      if (headerMap[a] && row[ headerMap[a] ] !== undefined) {
        const v = row[ headerMap[a] ];
        if (v !== null && String(v).trim() !== '') return String(v).trim();
      }
    }
    for (const h of headerFields) {
      const n = normalizeKey(h);
      if (n.includes('primary') || n.includes('basic') || n.includes('Ø§Ù„Ø§Ø³Ù…') || n.includes('Ø§Ø³Ø§Ø³') || n.includes('product')) {
        const v = row[h];
        if (v !== null && String(v).trim() !== '') return String(v).trim();
      }
    }
    return defaultVal;
  };

  const mapped = parsed.data.map(row => {
    const originalPrice = parseFloat(row[ headerMap[normalizeKey('Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ')] ] || row['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ'] || row['originalPrice'] || 0) || 0;
    const currentPrice  = parseFloat(row[ headerMap[normalizeKey('Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ')] ] || row['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ'] || row['currentPrice'] || 0) || 0;
    const discount      = parseFloat(row[ headerMap[normalizeKey('Ø§Ù„Ø®ØµÙ… %')] ] || row['Ø§Ù„Ø®ØµÙ… %'] || row['discount'] || 0) || 0;

    return {
      supermarket: ((row[ headerMap[normalizeKey('Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª')] ] || row['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || row['supermarket'] || '') + '').trim() || 'ØºÙŠØ± Ù…ØªØ§Ø­',
      product: ((row[ headerMap[normalizeKey('Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©')] ] || row['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || row['product'] || '') + '').trim() || 'ØºÙŠØ± Ù…ØªØ§Ø­',
      primaryName: valueByAliases(row, primaryAliases, ''),
      category: ((row[ headerMap[normalizeKey('Ø§Ù„ÙØ¦Ø©')] ] || row['Ø§Ù„ÙØ¦Ø©'] || row['category'] || '') + '').trim() || '',
      brand: ((row[ headerMap[normalizeKey('Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©')] ] || row['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || row['brand'] || '') + '').trim() || '',
      originalPrice,
      currentPrice,
      discount,
      promotion: ((row[ headerMap[normalizeKey('Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©')] ] || row['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || row['promotion'] || '') + '').trim() || '',
      rawPeriod: ((row[ headerMap[normalizeKey('ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶')] ] || row['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || row['validUntil'] || '') + '').trim() || '',
      pageNo: row[ headerMap[normalizeKey('pageno')] ] || row['pageNo'] || row['page_no'] || '',
      solution_key: row[ headerMap[normalizeKey('solution_key')] ] || row['solution_key'] || row['solution key'] || '',
      currency: ((row[ headerMap[normalizeKey('Ø§Ù„Ø¹Ù…Ù„Ø©')] ] || row['Ø§Ù„Ø¹Ù…Ù„Ø©'] || row['currency'] || 'EGP') + '').trim() || 'EGP',
      unit: ((row[ headerMap[normalizeKey('Ø§Ù„ÙˆØ­Ø¯Ø©')] ] || row['Ø§Ù„ÙˆØ­Ø¯Ø©'] || row['unit'] || '') + '').trim() || ''
    };
  });

  return mapped;
}

/* compute saved/discount */
function computeSavedAndDiscount(arr){
  arr.forEach(item=>{
    const orig = Number(item.originalPrice) || 0;
    const curr = Number(item.currentPrice) || 0;
    let saved = 0;
    if (orig > 0 && curr > 0) saved = orig - curr;
    else if (orig > 0 && item.discount) saved = orig * (Number(item.discount)/100);
    else if (curr > 0 && item.discount) saved = curr * (Number(item.discount)/100);
    item._saved = Math.max(0, Number((saved||0).toFixed(2)));
    item._discount_pct = (item.discount && !isNaN(item.discount)) ? Number(item.discount) : (orig>0 && curr>0 ? Math.round(((orig-curr)/orig)*100) : 0);
  });
}

function computeCombinedScore(arr){
  if(!arr || !arr.length) return;
  const savedVals = arr.map(i=>i._saved||0), pctVals = arr.map(i=>i._discount_pct||0);
  const maxSaved = Math.max(...savedVals,0), minSaved = Math.min(...savedVals,0);
  const maxPct = Math.max(...pctVals,0), minPct = Math.min(...pctVals,0);
  const savedRange = (maxSaved - minSaved) || 1;
  const pctRange = (maxPct - minPct) || 1;
  arr.forEach(item=>{
    const ns = ((item._saved||0)-minSaved)/savedRange;
    const np = ((item._discount_pct||0)-minPct)/pctRange;
    item._score = Math.max(ns, np);
  });
}

/* --- load data orchestration (minimal changes) --- */
async function loadDataFromExcelOrCSV() {
  try {
    const txt = await fetchWithTimeout(DATA_URL, 25000);
    // parse
    let parsed;
    try {
      parsed = await papaParseAsync(txt, { trim: false });
    } catch (err) {
      // fallback: try sync parse
      parsed = parseCSVSync(txt);
    }
    if (!parsed || !Array.isArray(parsed.data)) throw new Error('CSV parse failed');
    const mapped = normalizeRows(parsed);
    return mapped;
  } catch (err) {
    console.error('loadDataFromExcelOrCSV error:', err);
    throw err;
  }
}

/* fetchData: try cache, else load and normalize */
async function fetchData() {
  showLoadingMessage('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    const cachedTime = Number(localStorage.getItem(CACHE_KEY + '_time') || 0);
    if (cached && (Date.now() - cachedTime) < CACHE_EXPIRY) {
      try {
        let parsed = null;
        if (typeof LZString !== 'undefined') {
          try { parsed = JSON.parse(LZString.decompressFromUTF16(cached)); } catch(e){ parsed = null; }
        }
        if (!parsed) {
          try { parsed = JSON.parse(cached); } catch(e){ parsed = null; }
        }
        if (Array.isArray(parsed) && parsed.length) allData = parsed;
      } catch(e){ console.warn('cache read failed', e); }
    }

    if (!allData || !allData.length) {
      allData = await loadDataFromExcelOrCSV();
      try {
        if (typeof LZString !== 'undefined') localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData)));
        else localStorage.setItem(CACHE_KEY, JSON.stringify(allData));
        localStorage.setItem(CACHE_KEY + '_time', String(Date.now()));
      } catch(e){ console.warn('cache save failed', e); }
    }

    // normalize dates for each item (use rawPeriod then updateDate/date)
    allData.forEach(item => {
      item._date = null;
      if (item.rawPeriod) {
        const d = parseEndDate(item.rawPeriod);
        if (d) item._date = d;
      }
      if (!item._date && item.updateDate) {
        const d = new Date(item.updateDate);
        if (isValidDate(d)) item._date = stripTime(d);
      }
      if (!item._date && item.date) {
        const d = new Date(item.date);
        if (isValidDate(d)) item._date = stripTime(d);
      }
    });

    computeSavedAndDiscount(allData);
    computeCombinedScore(allData);

    const dates = [...new Set(allData.filter(x=>x._date instanceof Date).map(x=>formatDateShort(x._date)))].sort().reverse();
    latestTwoDates = dates.slice(0,2);
    newestDateObj = latestTwoDates.length ? new Date(latestTwoDates[0]) : null;
    if (newestDateObj && !isNaN(newestDateObj)) newestDateObj.setHours(0,0,0,0);

    dataLoaded = true;

    // initialize UI logic and render
    initializeFilters();
    applyAllFilters();
    populateTicker();
  } catch (err) {
    console.error('fetchData error', err);
    alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (err.message || err) + '\nØ¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¬Ø±Ù‘Ø¨ ØªØ¹Ø·ÙŠÙ„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØªØ¨Ù‘ÙØ¹ Ø£Ùˆ Ø§Ø³ØªØ¶Ù Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹.');
  } finally {
    hideLoadingMessage();
  }
}

/* --- Ticker --- */
function populateTicker(){
  try {
    const track = byId('ticker-track'); if (!track) return;
    track.innerHTML = '';
    const maxSavings = Math.max(...allData.map(i => i._saved || 0), 1);
    const top = [...allData].filter(i=>i._discount_pct>0).sort((a,b)=>{
      const da = Math.min((a._discount_pct||0),100)/100;
      const db = Math.min((b._discount_pct||0),100)/100;
      const sa = (a._saved||0)/maxSavings;
      const sb = (b._saved||0)/maxSavings;
      return (db*WEIGHT_DISCOUNT + sb*WEIGHT_SAVINGS) - (da*WEIGHT_DISCOUNT + sa*WEIGHT_SAVINGS);
    }).slice(0,12);
    if (!top.length) { track.innerHTML = '<div class="ticker-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ù…ÙŠØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>'; return; }
    const fragment = document.createDocumentFragment();
    top.forEach(it=>{
      const el = document.createElement('div'); el.className='ticker-item';
      const name = escapeHtml(it.product || 'Ù…Ù†ØªØ¬');
      const market = escapeHtml(it.supermarket || '');
      const discount = it._discount_pct ? `${it._discount_pct}%` : '';
      const saved = it._saved ? `${it._saved} ${it.currency||'EGP'}` : '';
      el.innerHTML = `<span class="badge">${discount}</span> <span>${name}</span> <span style="opacity:.85">â€” ${market}</span> <span style="color:var(--ticker-accent); margin-inline-start:8px;">ÙˆÙØ± ${saved}</span>`;
      fragment.appendChild(el);
    });
    track.appendChild(fragment.cloneNode(true));
    track.appendChild(fragment.cloneNode(true));
    requestAnimationFrame(()=>{
      track.classList.add('animate');
      const trackWidth = track.scrollWidth;
      const speed = 80;
      const duration = Math.max(8, Math.round(trackWidth / speed));
      track.style.setProperty('--ticker-duration', duration + 's');
    });
  } catch(e){ console.error('populateTicker error', e); }
}

/* --- Filters and rendering (minimal edits only) --- */
function getInputs(){
  return {
    search: (byId('search-input')?.value || '').trim().toLowerCase(),
    supermarket: byId('supermarket-filter')?.value || '',
    category: byId('category-filter')?.value || '',
    brand: byId('brand-filter')?.value || '',
    minDiscount: parseFloat(byId('min-discount')?.value) || 0,
    minPriceRaw: byId('min-price')?.value,
    maxPriceRaw: byId('max-price')?.value,
    sort: byId('sort-by')?.value || 'best-deals'
  };
}

function applyAllFilters(){
  if (!dataLoaded) return;
  try {
    const inputs = getInputs();
    const minPrice = inputs.minPriceRaw === '' ? 0 : (parseFloat(inputs.minPriceRaw) || 0);
    const maxPrice = inputs.maxPriceRaw === '' ? Infinity : (parseFloat(inputs.maxPriceRaw) || Infinity);

    filteredData = allData.filter(item=>{
      try {
        if (activeChipFilter === 'day') {
          if (!item._date || !newestDateObj) return false;
          const diff = (newestDateObj - item._date) / 86400000;
          if (diff < 0 || diff > 1) return false;
        }
        if (activeChipFilter === 'week') {
          if (!item._date || !newestDateObj) return false;
          const diff = (newestDateObj - item._date) / 86400000;
          if (diff < 0 || diff > 7) return false;
        }
        const price = Number(item.currentPrice) || 0;
        if (price < minPrice || price > maxPrice) return false;
        if ((item._discount_pct || 0) < inputs.minDiscount) return false;
        if (inputs.supermarket && String(item.supermarket || '') !== inputs.supermarket) return false;
        if (inputs.category && String(item.category || '') !== inputs.category) return false;
        if (inputs.brand && String(item.brand || '') !== inputs.brand) return false;
        if (inputs.search) {
          const hay = `${(item.product || '')} ${(item.primaryName || '')} ${(item.brand || '')} ${(item.supermarket || '')}`.toLowerCase();
          if (!hay.includes(inputs.search)) return false;
        }
        if (activeChipFilter === 'hot' && (item._discount_pct || 0) < 30) return false;
        if (activeChipFilter === 'discount' && (item._discount_pct || 0) < 20) return false;
        if (activeChipFilter === 'recent') {
          if (!item._date) return false;
          const dStr = formatDateShort(item._date);
          if (!latestTwoDates.includes(dStr)) return false;
        }
        return true;
      } catch(e){ console.error('filter item error', e, item); return false; }
    });

    // sort
    const sort = inputs.sort;
    if (sort === 'best-deals') {
      const maxSaved = Math.max(1, ...filteredData.map(i=>i._saved||0));
      filteredData.sort((a,b)=>{
        const da = Math.min((a._discount_pct||0),100)/100;
        const db = Math.min((b._discount_pct||0),100)/100;
        const sa = (a._saved||0)/maxSaved;
        const sb = (b._saved||0)/maxSaved;
        const scoreA = da*WEIGHT_DISCOUNT + sa*WEIGHT_SAVINGS;
        const scoreB = db*WEIGHT_DISCOUNT + sb*WEIGHT_SAVINGS;
        if (Math.abs(scoreB-scoreA) > 1e-6) return scoreB - scoreA;
        return String(a.product||'').localeCompare(String(b.product||''), 'ar');
      });
    } else if (sort === 'discount-desc') filteredData.sort((a,b)=>(b._discount_pct||0)-(a._discount_pct||0));
    else if (sort === 'saved-desc') filteredData.sort((a,b)=>(b._saved||0)-(a._saved||0));
    else if (sort === 'price-asc') filteredData.sort((a,b)=>(a.currentPrice||0)-(b.currentPrice||0));
    else if (sort === 'price-desc') filteredData.sort((a,b)=>(b.currentPrice||0)-(a.currentPrice||0));
    else if (sort === 'name-asc') filteredData.sort((a,b)=>String(a.product||'').localeCompare(String(b.product||''), 'ar'));
    else if (sort === 'name-desc') filteredData.sort((a,b)=>String(b.product||'').localeCompare(String(a.product||''), 'ar'));

    currentPage = 1;
    renderContent();
    updateStats();
  } catch(e){ console.error('applyAllFilters failed', e); }
}

/* pagination & rendering */
function getPagedData(){ const start=(currentPage-1)*itemsPerPage; return filteredData.slice(start, start+itemsPerPage); }

function renderProductsGrid(){
  const grid = byId('products-grid'); if(!grid) return;
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
  const pageData = getPagedData();
  if (!pageData.length) { grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>`; updatePagination(); return; }
  pageData.forEach(item=>{
    const card = document.createElement('div'); card.className='product-card';
    if (item._discount_pct && item._discount_pct >= 20) card.classList.add('highlight');
    const bestBadge = (item._discount_pct && item._discount_pct > 40) ? `<div class="product-badge">Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶</div>` : '';
    const savedHtml = item._saved ? `<div style="font-size:0.9rem;color:var(--success-green);font-weight:600;">ÙˆÙØ± ${item._saved} ${item.currency||'EGP'}</div>` : '';
    const countdownDays = item._date ? Math.ceil((item._date - new Date()) / (1000*60*60*24)) : null;
    const countdownHtml = (countdownDays !== null && countdownDays >= 0 && countdownDays <= 7) ? `<div class="countdown"><i class="fas fa-clock"></i> ${countdownDays} ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ</div>` : '';
    card.innerHTML = `
      ${bestBadge}
      <div class="favorite-btn" data-id="${escapeHtml(item.product)}"><i class="fas fa-heart"></i></div>
      <div class="product-image"><i class="fas fa-box"></i></div>
      <div class="product-info">
        <h3 class="product-title">${escapeHtml(item.product)}</h3>
        ${item.primaryName ? `<div style="font-size:0.9rem;color:#666;margin-bottom:5px;">${escapeHtml(item.primaryName)}</div>` : ''}
        <div class="price-container">
          <div style="display:flex;flex-direction:column;gap:3px;">
            <span class="current-price">${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</span>
            ${savedHtml}
          </div>
          ${item._discount_pct ? `<span class="discount-badge">-${item._discount_pct}%</span>` : ''}
        </div>
        <div class="product-meta">
          <div class="supermarket-logo"><i class="fas fa-store"></i><span>${escapeHtml(item.supermarket)}</span></div>
          ${countdownHtml}
        </div>
        <div class="action-buttons" style="margin-top:12px">
          <button class="btn btn-secondary view-details-btn" data-id="${escapeHtml(item.product)}"><i class="fas fa-eye"></i> ØªÙØ§ØµÙŠÙ„</button>
          <button class="btn btn-primary buy-now-btn" data-id="${escapeHtml(item.product)}"><i class="fas fa-shopping-cart"></i> Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
      </div>
    `;
    card.querySelector('.view-details-btn')?.addEventListener('click', e=>{ e.stopPropagation(); showDetails(item); });
    card.querySelector('.buy-now-btn')?.addEventListener('click', e=>{ e.stopPropagation(); openFlyer(item); });
    card.querySelector('.favorite-btn')?.addEventListener('click', e=>{ e.stopPropagation(); toggleFavorite(item.product); e.currentTarget.classList.toggle('active'); });
    card.addEventListener('click', ()=> openFlyer(item));
    grid.appendChild(card);
  });
  updatePagination();
}

function renderTable(){
  const tbody = byId('table-body'); if(!tbody) return; tbody.innerHTML = '';
  const pageData = getPagedData();
  if (!pageData.length) { tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>`; updatePagination(); return; }
  pageData.forEach(item=>{
    const tr = document.createElement('tr');
    if (item._discount_pct && item._discount_pct >= 20) tr.classList.add('highlight');
    tr.onclick = ()=> openFlyer(item);
    tr.innerHTML = `
      <td>${escapeHtml(item.supermarket)}</td>
      <td><strong>${escapeHtml(item.product)}</strong></td>
      <td>${escapeHtml(item.primaryName)}</td>
      <td>${escapeHtml(item.unit || '')}</td>
      <td>${escapeHtml(item.category)}</td>
      <td>${escapeHtml(item.brand)}</td>
      <td><strong style="color:var(--primary-blue);">${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</strong></td>
      <td>${item._discount_pct ? `<span class="discount-badge">-${item._discount_pct}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item._saved ? `<span style="color:var(--success-green);font-weight:600">${item._saved} ${item.currency||'EGP'}</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item._date ? formatDateShort(item._date) : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
    `;
    tbody.appendChild(tr);
  });
  updatePagination();
}

function updatePagination(){
  const pagination = byId('pagination'); if(!pagination) return; pagination.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
  if (totalPages <= 1) return;
  const btn = (text, disabled, onClick) => { const b = document.createElement('button'); b.textContent = text; b.disabled = !!disabled; b.addEventListener('click', onClick); return b; };
  pagination.appendChild(btn('Ø§Ù„Ø£ÙˆÙ„Ù‰', currentPage===1, ()=>{ currentPage=1; renderContent(); }));
  pagination.appendChild(btn('Ø§Ù„Ø³Ø§Ø¨Ù‚', currentPage===1, ()=>{ if(currentPage>1){ currentPage--; renderContent(); }}));
  const pageNumbers = document.createElement('div'); pageNumbers.style.display='flex'; pageNumbers.style.gap='6px'; pageNumbers.style.overflowX='auto';
  const start = Math.max(1, currentPage - 3), end = Math.min(totalPages, currentPage + 3);
  for (let i=start;i<=end;i++){
    const p = document.createElement('button'); p.textContent = i;
    if (i===currentPage) { p.style.background='var(--primary-blue)'; p.style.color='white'; }
    p.addEventListener('click', ()=>{ currentPage = i; renderContent(); });
    pageNumbers.appendChild(p);
  }
  pagination.appendChild(pageNumbers);
  pagination.appendChild(btn('Ø§Ù„ØªØ§Ù„ÙŠ', currentPage===totalPages, ()=>{ if(currentPage<totalPages){ currentPage++; renderContent(); }}));
  pagination.appendChild(btn('Ø§Ù„Ø£Ø®ÙŠØ±Ø©', currentPage===totalPages, ()=>{ currentPage = totalPages; renderContent(); }));
}

function renderContent(){
  if (currentView === 'table') {
    byId('products-grid').style.display = 'none';
    byId('data-table').style.display = 'block';
    renderTable();
  } else {
    byId('data-table').style.display = 'none';
    byId('products-grid').style.display = 'grid';
    renderProductsGrid();
  }
}

function updateStats(){
  try {
    byId('total-offers').textContent = (filteredData.length || 0).toLocaleString();
    const discounts = filteredData.filter(i=>i._discount_pct).map(i=>i._discount_pct);
    const avgDiscount = discounts.length ? Math.round(discounts.reduce((a,b)=>a+b,0)/discounts.length) : 0;
    byId('avg-discount').textContent = `${avgDiscount}%`;
    byId('hot-deals').textContent = (filteredData.filter(i=> (i._discount_pct||0) > 30).length || 0).toLocaleString();
    byId('ending-soon').textContent = (filteredData.filter(i=> i._date && ((i._date - new Date())/(1000*3600*24) <= 7) && ((i._date - new Date())/(1000*3600*24) >= 0)).length || 0).toLocaleString();
    byId('total-supermarkets').textContent = ([...new Set(filteredData.map(i=>i.supermarket).filter(Boolean))].length || 0).toLocaleString();
  } catch(e){ console.error('updateStats failed', e); }
}

/* small utilities */
function openFlyer(item){ if(!item) return; const flyerUrl = item.solution_key ? `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg` : null; if(flyerUrl) window.open(flyerUrl, '_blank'); else alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙ„Ø§ÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±'); }
function showDetails(item){ if(!item) return alert('ØºÙŠØ± Ù…ØªØ§Ø­'); const details = [
  `Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬: ${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${item.primaryName || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª: ${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„ÙØ¦Ø©: ${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø®ØµÙ…: ${item._discount_pct ? item._discount_pct + '%' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„ØªÙˆÙÙŠØ±: ${item._saved ? item._saved + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰: ${item._date ? formatDateShort(item._date) : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`
].join('\n'); alert(details); }

/* Filters wiring (minimal) */
function debounce(fn, wait=300){ let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }
const debounceApply = debounce(()=> applyAllFilters(), 300);

function initializeFilters(){
  try {
    const supermarketSelect = byId('supermarket-filter'); if (supermarketSelect) {
      supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
      [...new Set(allData.map(i=>i.supermarket))].filter(Boolean).sort((a,b)=>String(a).localeCompare(String(b),'ar')).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; supermarketSelect.appendChild(o); });
      supermarketSelect.addEventListener('change', applyAllFilters);
    }
    const categorySelect = byId('category-filter'); if (categorySelect) {
      categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
      [...new Set(allData.map(i=>i.category))].filter(Boolean).sort((a,b)=>String(a).localeCompare(String(b),'ar')).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; categorySelect.appendChild(o); });
      categorySelect.addEventListener('change', applyAllFilters);
    }
    const brandSelect = byId('brand-filter'); if (brandSelect) {
      brandSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</option>';
      [...new Set(allData.map(i=>i.brand))].filter(Boolean).sort((a,b)=>String(a).localeCompare(String(b),'ar')).forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; brandSelect.appendChild(o); });
      brandSelect.addEventListener('change', applyAllFilters);
    }

    document.querySelectorAll('.chip').forEach(c=>{
      c.addEventListener('click', function(){
        document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        activeChipFilter = this.dataset.filter || 'all';
        applyAllFilters();
      });
    });

    byId('view-grid-btn')?.addEventListener('click', ()=>{ currentView='grid'; byId('view-grid-btn')?.classList.add('active'); byId('view-table-btn')?.classList.remove('active'); renderContent(); });
    byId('view-table-btn')?.addEventListener('click', ()=>{ currentView='table'; byId('view-table-btn')?.classList.add('active'); byId('view-grid-btn')?.classList.remove('active'); renderContent(); });

    const search = byId('search-input'); if (search) {
      search.addEventListener('input', ()=>{ debounceApply(); });
      search.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); applyAllFilters(); }});
    }

    byId('sort-by')?.addEventListener('change', applyAllFilters);
    byId('min-discount')?.addEventListener('input', applyAllFilters);
    byId('reset-btn')?.addEventListener('click', ()=>{ resetAllFilters(); applyAllFilters(); });
    byId('share-app')?.addEventListener('click', ()=>{ navigator.clipboard?.writeText(location.href); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'); });
    byId('compare-mode-btn')?.addEventListener('click', ()=>{ const p = byId('comparison-panel'); if(p) p.style.display = (p.style.display === 'block' ? 'none' : 'block'); });

    byId('min-decrease')?.addEventListener('click', ()=> adjustNumberInput(byId('min-price'), -1));
    byId('min-increase')?.addEventListener('click', ()=> adjustNumberInput(byId('min-price'), +1));
    byId('max-decrease')?.addEventListener('click', ()=> adjustNumberInput(byId('max-price'), -1));
    byId('max-increase')?.addEventListener('click', ()=> adjustNumberInput(byId('max-price'), +1));
  } catch(e){ console.error('initializeFilters failed', e); }
}

function adjustNumberInput(el, delta){ if(!el) return; const step = parseFloat(el.step)||1; const cur = parseFloat(el.value)||0; el.value = Math.max(0, +(cur + delta*step).toFixed(2)); debounceApply(); }
function resetAllFilters(){ if(byId('search-input')) byId('search-input').value=''; if(byId('supermarket-filter')) byId('supermarket-filter').value=''; if(byId('category-filter')) byId('category-filter').value=''; if(byId('brand-filter')) byId('brand-filter').value=''; if(byId('min-discount')) byId('min-discount').value=''; if(byId('min-price')) byId('min-price').value=''; if(byId('max-price')) byId('max-price').value=''; if(byId('sort-by')) byId('sort-by').value='best-deals'; activeChipFilter='all'; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); document.querySelector('.chip[data-filter="all"]')?.classList.add('active'); }

/* initialize app */
async function init(){
  try {
    await fetchData();
    initializeFilters();
  } catch(e){ console.error('init error', e); }
}

/* Start on DOM ready */
document.addEventListener('DOMContentLoaded', ()=>{ init(); });

/* Expose a few helpers globally if other HTML expects them (keeps original behavior) */
window.applyAllFilters = applyAllFilters;
window.resetAllFilters = resetAllFilters;
window.openFlyer = openFlyer;
window.showDetails = showDetails;
window.toggleFavorite = function(productId){ try { const idx = favorites.indexOf(productId); if (idx === -1) favorites.push(productId); else favorites.splice(idx,1); localStorage.setItem('favorites', JSON.stringify(favorites)); } catch(e){ console.error(e); } };

    </script>

  </body>
</html>