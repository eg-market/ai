<!DOCTYPE html>
<html dir="rtl" lang="ar">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª - Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</title>
    <!-- External libs used by original file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"

defer="defer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"

defer="defer"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts for Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&amp;display=swap"

      rel="stylesheet">
    <style>
      /* --- Styles kept from your file (cleaned and preserved) --- */
      :root{
        --primary-blue: #00539F;
        --accent-orange: #FF6B00;
        --success-green: #28A745;
        --warning-yellow: #FFC107;
        --danger-red: #DC3545;
        --info-teal: #17a2b8;
        --purple: #6f42c1;
        --pink: #e83e8c;
        --light-bg: #F8F9FA;
        --card-shadow: 0 8px 30px rgba(0,0,0,0.08);
        --border-radius: 16px;
        --transition: all 0.3s ease;
        --bg-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        --card-bg:#fff;
        --muted:#666;
        --accent:#4caf50;
        --danger:#ff4444;
        --gap:12px;
        --radius:12px;
        --text:#222;
        --control-height:46px;
        --base-font:15px;
        --ticker-bg:#0b3b6f;
        --ticker-text:#fff;
        --ticker-accent:#ffd54f;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family: 'Cairo', 'Segoe UI', Roboto, Arial, sans-serif;
        background: var(--light-bg);
        color:var(--text);
        padding:0;
        -webkit-font-smoothing:antialiased;
        line-height: 1.6;
      }
      .container{ max-width:1400px; margin:0 auto; padding:0 16px; }

      /* Hero Banner */
      .hero-banner {
        background: linear-gradient(rgba(0,83,159,0.85), rgba(0,83,159,0.75)),
                    url('https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-1.2.1&auto=format&fit=crop&w=1400&q=80');
        background-size: cover;
        background-position: center;
        color: white;
        padding: 40px 20px;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
      }
      .hero-banner::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        opacity: 0.3;
      }
      .hero-content { position: relative; z-index: 2; }
      .hero-banner h1 { margin: 0 0 10px 0; font-size: 2.5rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .hero-subtitle { font-size: 1.2rem; opacity: 0.9; margin-bottom: 25px; }

      /* Stats Dashboard */
      .stats-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin: 25px 0;
      }
      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        border: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 12px;
        min-height: 80px;
      }
      .stat-icon { font-size: 1.8rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
      .stat-content { display: flex; flex-direction: column; justify-content: center; flex: 1; min-width: 0; }
      .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary-blue); margin-bottom: 2px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .stat-label { font-size: 0.8rem; color: var(--muted); line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

      /* Quick Filter Chips */
      .filter-chips { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; padding: 10px 0; }
      .chip {
        padding: 10px 18px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        font-family: 'Cairo', sans-serif;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }
      .chip > * { position: relative; z-index: 1; }
      .chip:hover { border-color: currentColor; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .chip.active { color: white; border-color: transparent; }
      .chip.active::after { opacity: 1; }

      /* Colors for chips */
      .chip[data-filter="all"] { color: var(--primary-blue); }
      .chip[data-filter="hot"] { color: var(--danger-red); }
      .chip[data-filter="ending"] { color: var(--warning-yellow); }
      .chip[data-filter="discount"] { color: var(--success-green); }
      .chip[data-filter="carrefour"] { color: #004080; }
      .chip[data-filter="hyperone"] { color: var(--accent-orange); }
      .chip[data-filter="food"] { color: var(--info-teal); }
      .chip[data-filter="recent"] { color: var(--purple); }

      /* View Toggle */
      .view-toggle { display: flex; background: white; border-radius: 12px; padding: 5px; width: fit-content; margin: 20px 0; box-shadow: var(--card-shadow); border: 1px solid #f0f0f0; overflow: hidden; }
      .view-btn {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        font-family: 'Cairo', sans-serif;
        font-weight: 600;
        cursor: pointer;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--primary-blue);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      .view-btn.active { color: white; border-color: transparent; }
      #view-grid-btn { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
      #view-table-btn { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: none; }

      /* Products Grid */
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
        margin: 25px 0;
      }
      .product-card {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        position: relative;
        border: 1px solid #f0f0f0;
      }
      .product-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
      .product-badge { position: absolute; top: 15px; right: 15px; background: var(--danger-red); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; z-index: 2; }
      .product-image { height: 180px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
      .product-image i { font-size: 4rem; color: rgba(0,0,0,0.1); }
      .product-info { padding: 20px; }
      .product-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 10px 0; color: #333; height: 52px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
      .product-unit { font-size: 0.85rem; color: var(--muted); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
      .price-container { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; }
      .current-price { font-size: 1.5rem; font-weight: 800; color: var(--primary-blue); }
      .discount-badge { background: var(--danger-red); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; }
      .product-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
      .supermarket-logo { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #555; }
      .countdown { background: rgba(255,107,0,0.1); color: var(--accent-orange); padding: 5px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
      .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
      .btn { padding: 10px 15px; border-radius: 8px; border: none; font-family: 'Cairo', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition); flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
      .btn-primary { background: var(--primary-blue); color: white; }
      .btn-secondary { background: #f0f0f0; color: #555; }
      .favorite-btn { position: absolute; top: 15px; left: 15px; background: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #ccc; cursor: pointer; z-index: 2; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: var(--transition); }
      .favorite-btn:hover, .favorite-btn.active { color: var(--danger-red); }
      .ticker-wrap{ width:100%; background:var(--ticker-bg); color:var(--ticker-text); border-radius:10px; overflow:hidden; display:flex; align-items:center; padding:6px 12px; box-shadow:0 6px 18px rgba(0,0,0,0.12); margin-top:8px; }
      .ticker-label{ flex:0 0 auto; font-weight:700; margin-left:12px; color:var(--ticker-accent); background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:8px; display:flex; align-items:center; gap: 8px; }
      .ticker-viewport{ flex:1 1 auto; overflow:hidden; position:relative; height:36px; display:flex; align-items:center; }
      .ticker-track{ display:inline-flex; white-space:nowrap; will-change:transform; align-items:center; gap:28px; }
      .ticker-item{ display:inline-flex; gap:12px; align-items:center; padding:6px 10px; background:transparent; color:var(--ticker-text); font-size:15px; }
      .ticker-item .badge{ background:var(--ticker-accent); color:#000; padding:4px 8px; border-radius:6px; font-weight:700; }

      .ticker-track.animate{ animation: ticker-scroll linear infinite; animation-duration: var(--ticker-duration, 18s); }
      @keyframes ticker-scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }

      .controls{ background: white; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--card-shadow); border: 1px solid #f0f0f0; }
      .controls .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 15px; }
      input,select,button{ height:var(--control-height); padding:0 16px; border-radius:10px; border:2px solid #e0e0e0; background:white; font-size:15px; font-family: 'Cairo', sans-serif; transition: var(--transition); }
      input:focus, select:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(0,83,159,0.1); }
      #search-input { flex: 1; min-width: 200px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 16px; padding-right: 45px; }
      button{ cursor:pointer; font-weight: 600; background: var(--primary-blue); color: white; border: none; }
      #reset-btn { background: #f0f0f0; color: #666; display: flex; align-items: center; gap: 8px; }
      .price-controls{ display:flex; gap:8px; align-items:center; background: #f8f9fa; padding: 5px; border-radius: 10px; }
      .price-controls button{ width:36px; height:36px; padding:0; font-size:18px; line-height:1; background: white; color: #333; border: 1px solid #ddd; }
      #data-table{ background:white; border-radius:var(--border-radius); box-shadow:var(--card-shadow); overflow:hidden; margin-top:20px; padding:0; border: 1px solid #f0f0f0; }
      table{ width:100%; border-collapse:collapse; font-size:14px; }
      thead th{ background:var(--primary-blue); color:#fff; padding:16px; text-align:right; position:sticky; top:0; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.1); }
      tbody td{ padding:14px 16px; border-bottom:1px solid #f0f0f0; }
      tbody tr:hover { background: #f8f9fa; }
      .highlight{ background:#fff3b0 !important; }
      .card-list{ display:none }
      #loading{ text-align:center; padding:40px; color:#666; font-size:1.2rem; }
      #autocomplete-list{ position:absolute; z-index:9999; background:white; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); max-height:240px; overflow:auto; border: 1px solid #e0e0e0; }
      #autocomplete-list div { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: var(--transition); }
      #autocomplete-list div:hover { background: #f8f9fa; }

      /* Responsive */
      @media (max-width: 900px){
        .container { padding: 0 12px; }
        .hero-banner { padding: 30px 15px; margin-bottom: 20px; }
        .hero-banner h1 { font-size: 1.8rem; }
        .hero-subtitle { font-size: 1rem; }
        .stats-dashboard { grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .products-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
        .controls .row { flex-direction: column; align-items: stretch; }
        #data-table { overflow-x: auto; display: block; }
        table { min-width: 800px; }
      }
      @media (max-width: 600px){
        .products-grid { grid-template-columns: 1fr; }
        .stat-card { padding: 12px 10px; gap: 10px; min-height: 70px; }
        .filter-chips { overflow-x: auto; padding-bottom: 10px; flex-wrap: nowrap; }
      }
    </style>
  </head>
  <body>
    <div class="container"> <!-- Hero Banner -->
      <div class="hero-banner">
        <div class="hero-content">
          <h1>ğŸ›’ Ø£ÙØ¶Ù„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
          <p class="hero-subtitle">Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨ÙŠÙ† ÙƒØ§Ø±ÙÙˆØ±ØŒ Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†ØŒ Ø³Ø¹ÙˆØ¯ÙŠ
            Ù…Ø§Ø±ÙƒØª ÙˆØºÙŠØ±Ù‡Ø§ - ÙˆÙØ± Ø­ØªÙ‰ 70%</p>
          <!-- Ticker banner -->
          <div class="ticker-wrap" aria-live="polite" aria-atomic="true" role="region"

            aria-label="Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶">
            <div class="ticker-label"><i class="fas fa-bolt"></i> Ø¹Ø±ÙˆØ¶ Ù…Ù…ÙŠØ²Ø©</div>
            <div class="ticker-viewport" id="ticker-viewport">
              <div class="ticker-track" id="ticker-track" aria-hidden="false">
                <div class="ticker-item">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- User Guide Banner -->
      <div class="user-guide-banner" id="user-guide"> <i class="fas fa-info-circle"></i>
        <span>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù†ØªØ¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„" Ù„Ø¹Ø±Ø¶
          Ø§Ù„Ø§ØµÙ†Ø§Ù ÙÙŠ Ø¬Ø¯ÙˆÙ„ - ÙˆØ²Ø± "Ø¹Ø±Ø¶ Ø´Ø¨ÙƒÙŠ" Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</span> </div>
      <!-- Stats Dashboard -->
      <div class="stats-dashboard">
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-content">
            <div id="total-offers" class="stat-value">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“‰</div>
          <div class="stat-content">
            <div id="avg-discount" class="stat-value">0%</div>
            <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ”¥</div>
          <div class="stat-content">
            <div id="hot-deals" class="stat-value">0</div>
            <div class="stat-label">Ø¹Ø±ÙˆØ¶ Ø³Ø§Ø®Ù†Ø©</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â°</div>
          <div class="stat-content">
            <div id="ending-soon" class="stat-value">0</div>
            <div class="stat-label">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ›’</div>
          <div class="stat-content">
            <div id="total-supermarkets" class="stat-value">0</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØ§Øª</div>
          </div>
        </div>
      </div>
      <!-- Quick Filter Chips -->
      <div class="filter-chips" id="filter-chips"> <button class="chip active"

          data-filter="all"><i class="fas fa-fire"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶</button> <button

          class="chip" data-filter="hot"><i class="fas fa-bolt"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶
          Ø§Ù„Ø³Ø§Ø®Ù†Ø©</button> <button class="chip" data-filter="ending"><i class="fas fa-clock"></i>
          ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</button> <button class="chip" data-filter="discount"><i

            class="fas fa-percentage"></i> Ø®ØµÙˆÙ…Ø§Øª ÙƒØ¨ÙŠØ±Ø©</button> <button class="chip"

          data-filter="carrefour"><i class="fas fa-shopping-cart"></i> ÙƒØ§Ø±ÙÙˆØ±</button>
        <button class="chip" data-filter="hyperone"><i class="fas fa-store"></i>
          Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†</button> <button class="chip" data-filter="food"><i class="fas fa-utensils"></i>
          Ù…Ù†ØªØ¬Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©</button> <button class="chip" data-filter="recent"><i class="fas fa-calendar-day"></i>
          Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ø¢Ø®Ø± ÙŠÙˆÙ…ÙŠÙ†)</button> </div>
      <!-- View Toggle -->
      <div class="view-toggle"> <button class="view-btn active" id="view-grid-btn"><i

            class="fas fa-th-large"></i> Ø¹Ø±Ø¶ Ø´Ø¨ÙƒÙŠ</button> <button class="view-btn"

          id="view-table-btn"><i class="fas fa-table"></i> Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„</button> </div>
      <!-- Products Grid -->
      <div class="products-grid" id="products-grid"></div>
      <!-- Controls -->
      <div class="controls" role="region" aria-label="Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…">
        <div class="row" style="flex:1;"> <input id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..."

            aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«" type="text">
          <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª">
            <option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
          </select>
          <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©">
            <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
          </select>
          <select id="brand-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©">
            <option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</option>
          </select>
        </div>
        <div class="row" style="width:100%; gap:8px;">
          <div class="price-controls" style="align-items:center;"> <button id="min-decrease"

              type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">âˆ’</button> <input id="min-price"

              placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5"

              min="0" type="number"> <button id="min-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">+</button>
          </div>
          <div class="price-controls" style="align-items:center;"> <button id="max-decrease"

              type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">âˆ’</button> <input id="max-price"

              placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5"

              min="0" type="number"> <button id="max-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">+</button>
          </div>
          <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
            <option value="best-deals" selected="selected">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù…Ø±ÙƒØ¨)</option>
            <option value="discount-desc">Ø§Ù„Ø®ØµÙ… % - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="saved-desc">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆÙÙŠØ± - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± - ØªØµØ§Ø¹Ø¯ÙŠ</option>
            <option value="price-desc">Ø§Ù„Ø³Ø¹Ø± - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="name-asc">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
            <option value="name-desc">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
          </select>
          <input id="min-discount" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…"

            type="number">
          <div style="display:flex;gap:8px;"> <button id="reset-btn" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†">ğŸ”„
              Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button> <button id="share-app" aria-label="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"><i

                class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ©</button> <button id="compare-mode-btn"

              aria-label="ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©"><i class="fas fa-balance-scale"></i>
              Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</button> </div>
        </div>
      </div>
      <!-- Data Table -->
      <div id="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
      <div id="data-table" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶" style="display:none;">
        <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶">
          <thead>
            <tr>
              <th>ğŸª Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
              <th>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</th>
              <th>ğŸ“¦ Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>ğŸ“‚ Ø§Ù„ÙØ¦Ø©</th>
              <th>ğŸ·ï¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
              <th>ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
              <th>ğŸ“‰ Ø§Ù„Ø®ØµÙ…</th>
              <th>ğŸ’° Ø§Ù„ØªÙˆÙÙŠØ±</th>
              <th>â° Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
            </tr>
          </thead>
          <tbody id="table-body">
          </tbody>
        </table>
        <div class="card-list" id="card-list" aria-hidden="true"></div>
        <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª"></div>
      </div>
      <!-- Comparison Panel -->
      <div class="comparison-panel" id="comparison-panel" style="display:none;">
        <div class="comparison-header">
          <h3 style="margin:0;"><i class="fas fa-balance-scale"></i> Ù…Ù‚Ø§Ø±Ù†Ø©
            Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (<span id="comparison-count">0</span>/4)</h3>
          <div> <button id="clear-comparison" style="margin-left:10px; background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;"><i

                class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button> <button id="close-comparison"

              style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;"><i

                class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button> </div>
        </div>
        <div class="comparison-items" id="comparison-items"></div>
      </div>
      <!-- Mobile Navigation -->
      <div class="mobile-nav" style="display:none;"> <a href="#" class="mobile-nav-item active"><i

            class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a> <a href="#" class="mobile-nav-item"><i

            class="fas fa-percentage"></i><span>Ø§Ù„Ø¹Ø±ÙˆØ¶</span></a> <a href="#" class="mobile-nav-item"><i

            class="fas fa-search"></i><span>Ø¨Ø­Ø«</span></a> <a href="#" class="mobile-nav-item"><i

            class="fas fa-heart"></i><span>Ø§Ù„Ù…ÙØ¶Ù„Ø©</span></a> <a href="#" class="mobile-nav-item"><i

            class="fas fa-user"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></a> </div>
    </div>
    <!-- ============================
         Cleaned & consolidated JavaScript         (replaces the broken script in the original index.html)         ============================ -->
    <script>
/* ============================
  Robust consolidated script
  - safe fetch + CSV parse (PapaParse if available, else fallback)
  - fixes template errors and innerHTML usage
  - initialize UI, filters, render grid & table
  Paste this entire <script> block replacing your broken one.
  ============================ */

const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
const CACHE_KEY = 'offersData';
const CACHE_EXPIRY = 3600000; // 1 hour
const WEIGHT_DISCOUNT = 0.6, WEIGHT_SAVINGS = 0.4;

let allData = [];
let filteredData = [];
let dataLoaded = false;
let currentPage = 1;
const itemsPerPage = 20;
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
let comparison = JSON.parse(localStorage.getItem('comparison') || '[]');
let currentView = 'grid';
let activeChipFilter = 'all';
let latestTwoDates = [];
let newestDateObj = null;

/* --- Helpers --- */
function byId(id){ return document.getElementById(id); }
function showLoadingMessage(msg='Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...'){ const el = byId('loading'); if(el){ el.style.display='block'; el.textContent = msg; } }
function hideLoadingMessage(){ const el = byId('loading'); if(el) el.style.display='none'; }
function isValidDate(d){ return d instanceof Date && !isNaN(d.getTime()); }
function stripTime(d){ return isValidDate(d) ? new Date(d.getFullYear(), d.getMonth(), d.getDate()) : null; }
function formatDateShort(d){ if(!isValidDate(d)) return 'ØºÙŠØ± Ù…ØªØ§Ø­'; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function escapeHtml(s){ if (s===null || s===undefined) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* --- Fetch + parse helpers --- */
async function fetchWithTimeout(url, timeoutMs = 25000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { signal: controller.signal });
    clearTimeout(id);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.text();
  } catch (err) {
    clearTimeout(id);
    if (err && err.name === 'AbortError') {
      throw new Error('Ø·Ù„Ø¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹ (timeout).');
    }
    throw err;
  }
}

// Try PapaParse worker -> fallback -> fallback to built-in parser
function papaParseAsync(csvText, opts = {}) {
  return new Promise((resolve, reject) => {
    if (typeof Papa === 'undefined') return reject(new Error('PapaParse not available'));
    let finished = false;
    const timer = setTimeout(()=>{ if(!finished){ finished=true; reject(new Error('CSV parse timeout')); } }, opts.parseTimeout || 60000);

    try {
      Papa.parse(csvText, Object.assign({
        header: true,
        skipEmptyLines: true,
        worker: true,
        complete: res => { if (finished) return; finished=true; clearTimeout(timer); resolve(res); },
        error: err => {
          console.warn('Papa worker error, retrying without worker', err);
          try {
            Papa.parse(csvText, Object.assign({
              header: true,
              skipEmptyLines: true,
              worker: false,
              complete: res2 => { if (finished) return; finished=true; clearTimeout(timer); resolve(res2); },
              error: err2 => { if (finished) return; finished=true; clearTimeout(timer); reject(err2); }
            }, opts));
          } catch (err2) { if (!finished) { finished=true; clearTimeout(timer); reject(err2); } }
        }
      }, opts));
    } catch (e) {
      console.warn('Papa.parse threw, trying non-worker fallback', e);
      try {
        Papa.parse(csvText, Object.assign({
          header: true,
          skipEmptyLines: true,
          worker: false,
          complete: res2 => { if (finished) return; finished=true; clearTimeout(timer); resolve(res2); },
          error: err2 => { if (finished) return; finished=true; clearTimeout(timer); reject(err2); }
        }, opts));
      } catch (err3) {
        if (!finished) { finished=true; clearTimeout(timer); reject(err3); }
      }
    }
  });
}

// Simple CSV parser fallback (handles quoted fields)
function parseCSVSync(csvText){
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  const pushField = ()=>{ row.push(field); field=''; };
  const pushRow = ()=>{ rows.push(row); row=[]; };

  while(i<csvText.length){
    const ch = csvText[i];
    if(inQuotes){
      if(ch === '"'){
        if(csvText[i+1] === '"'){ field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else { field += ch; i++; continue; }
    } else {
      if(ch === '"'){ inQuotes = true; i++; continue; }
      if(ch === ','){ pushField(); i++; continue; }
      if(ch === '\r'){ pushField(); i++; if(csvText[i] === '\n') i++; pushRow(); continue; }
      if(ch === '\n'){ pushField(); i++; pushRow(); continue; }
      field += ch; i++; continue;
    }
  }
  if(field !== '' || inQuotes) pushField();
  if(row.length || rows.length === 0) pushRow();
  const header = rows[0].map(h => String(h||'').replace(/\uFEFF/g,'').trim());
  const data = rows.slice(1).map(r => {
    const obj = {};
    for(let j=0;j<header.length;j++) obj[header[j]] = r[j] !== undefined ? r[j] : '';
    return obj;
  });
  return { data, meta: { fields: header } };
}

/* ---------- Loader: fetch CSV and map rows to canonical objects ---------- */
async function loadDataFromExcelOrCSV() {
  try {
    const txt = await fetchWithTimeout(DATA_URL, 25000);
    let parsed;
    if (typeof Papa !== 'undefined') {
      try {
        parsed = await papaParseAsync(txt, { trim: false });
      } catch (err) {
        console.warn('Papa async failed, trying Papa.parse non-worker', err);
        try { parsed = Papa.parse(txt, { header: true, skipEmptyLines: true, worker: false }); }
        catch (e){ console.warn('Papa.parse non-worker failed, using built-in parser', e); parsed = parseCSVSync(txt); }
      }
    } else {
      parsed = parseCSVSync(txt);
    }

    if (!parsed || !Array.isArray(parsed.data)) throw new Error('CSV parse failed');

    const headerFields = (parsed.meta && parsed.meta.fields && parsed.meta.fields.length) ? parsed.meta.fields.slice() : (parsed.data[0] ? Object.keys(parsed.data[0]) : []);
    const normalizeKey = s => { if (!s && s !== 0) return ''; return String(s).replace(/\uFEFF/g,'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim().toLowerCase(); };
    const headerMap = {}; headerFields.forEach(h => headerMap[normalizeKey(h)] = h);

    const primaryAliases = ['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)','Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ)','Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©','Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬','product','primaryname','primary name','product name'].map(normalizeKey);

    const valueByAliases = (row, aliases, defaultVal='') => {
      for (const a of aliases) {
        if (headerMap[a] && row[headerMap[a]] !== undefined) {
          const v = row[headerMap[a]];
          if (v !== null && String(v).trim() !== '') return String(v).trim();
        }
      }
      for (const h of headerFields) {
        const n = normalizeKey(h);
        if (n.includes('primary') || n.includes('basic') || n.includes('Ø§Ù„Ø§Ø³Ù…') || n.includes('Ø§Ø³Ø§Ø³') || n.includes('product')) {
          const v = row[h];
          if (v !== null && String(v).trim() !== '') return String(v).trim();
        }
      }
      return defaultVal;
    };

    const mapped = parsed.data.map(row => {
      const originalPrice = parseFloat(row[headerMap[normalizeKey('Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ')]] || row['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ'] || row['originalPrice'] || 0) || 0;
      const currentPrice = parseFloat(row[headerMap[normalizeKey('Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ')]] || row['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ'] || row['currentPrice'] || 0) || 0;
      const discount = parseFloat(row[headerMap[normalizeKey('Ø§Ù„Ø®ØµÙ… %')]] || row['Ø§Ù„Ø®ØµÙ… %'] || row['discount'] || 0) || 0;

      return {
        supermarket: (row[headerMap[normalizeKey('Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª')]] || row['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || row['supermarket'] || '').trim() || 'ØºÙŠØ± Ù…ØªØ§Ø­',
        product: (row[headerMap[normalizeKey('Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©')]] || row['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || row['product'] || '').trim() || 'ØºÙŠØ± Ù…ØªØ§Ø­',
        primaryName: valueByAliases(row, primaryAliases, ''),
        category: (row[headerMap[normalizeKey('Ø§Ù„ÙØ¦Ø©')]] || row['Ø§Ù„ÙØ¦Ø©'] || row['category'] || '').trim() || '',
        brand: (row[headerMap[normalizeKey('Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©')]] || row['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || row['brand'] || '').trim() || '',
        originalPrice,
        currentPrice,
        discount,
        promotion: (row[headerMap[normalizeKey('Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©')]] || row['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || row['promotion'] || '').trim() || '',
        rawPeriod: (row[headerMap[normalizeKey('ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶')]] || row['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || row['validUntil'] || '').trim() || '',
        pageNo: row[headerMap[normalizeKey('pageno')]] || row['pageNo'] || row['page_no'] || '',
        solution_key: row[headerMap[normalizeKey('solution_key')]] || row['solution_key'] || row['solution key'] || '',
        currency: (row[headerMap[normalizeKey('Ø§Ù„Ø¹Ù…Ù„Ø©')]] || row['Ø§Ù„Ø¹Ù…Ù„Ø©'] || row['currency'] || 'EGP').trim() || 'EGP',
        unit: (row[headerMap[normalizeKey('Ø§Ù„ÙˆØ­Ø¯Ø©')]] || row['Ø§Ù„ÙˆØ­Ø¯Ø©'] || row['unit'] || '').trim() || ''
      };
    });

    return mapped;
  } catch (err) {
    console.error('loadDataFromExcelOrCSV error:', err);
    throw err;
  }
}

/* --- compute helpers --- */
function computeSavedAndDiscount(arr){
  arr.forEach(item=>{
    const orig = Number(item.originalPrice) || 0;
    const curr = Number(item.currentPrice) || 0;
    let saved = 0;
    if (orig > 0 && curr > 0) saved = orig - curr;
    else if (orig > 0 && item.discount) saved = orig * (Number(item.discount)/100);
    else if (curr > 0 && item.discount) saved = curr * (Number(item.discount)/100);
    item._saved = Math.max(0, Number((saved||0).toFixed(2)));
    item._discount_pct = (item.discount && !isNaN(item.discount)) ? Number(item.discount) : (orig>0 && curr>0 ? Math.round(((orig-curr)/orig)*100) : 0);
  });
}
function computeCombinedScore(arr){
  if(!arr || !arr.length) return;
  const savedVals = arr.map(i=>i._saved||0), pctVals = arr.map(i=>i._discount_pct||0);
  const maxSaved = Math.max(...savedVals,0), minSaved = Math.min(...savedVals,0);
  const maxPct = Math.max(...pctVals,0), minPct = Math.min(...pctVals,0);
  const savedRange = (maxSaved - minSaved) || 1;
  const pctRange = (maxPct - minPct) || 1;
  arr.forEach(item=>{
    const ns = ((item._saved||0)-minSaved)/savedRange;
    const np = ((item._discount_pct||0)-minPct)/pctRange;
    item._score = Math.max(ns, np);
  });
}

      function parseEndDate(value) {
  if (!value || typeof value !== 'string') return null;

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
  value = value.trim();

  // ØµÙŠØº Ù…ØªÙˆÙ‚Ø¹Ø©: 2025-01-15 Ø£Ùˆ 15/01/2025
  let d;

  // YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
    d = new Date(value);
  }

  // DD/MM/YYYY
  else if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
    const [day, month, year] = value.split('/');
    d = new Date(`${year}-${month}-${day}`);
  }

  if (!d || isNaN(d.getTime())) return null;
  return d;
}

      
/* --- main fetchData orchestration --- */
async function fetchData() {
  showLoadingMessage('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
  try {
    // cache
    const cached = localStorage.getItem(CACHE_KEY);
    const cachedTime = Number(localStorage.getItem(CACHE_KEY + '_time') || 0);
    if (cached && (Date.now() - cachedTime) < CACHE_EXPIRY) {
      try {
        let parsed = null;
        if (typeof LZString !== 'undefined') {
          try { parsed = JSON.parse(LZString.decompressFromUTF16(cached)); } catch(e){ parsed = null; }
        }
        if (!parsed) {
          try { parsed = JSON.parse(cached); } catch(e){ parsed = null; }
        }
        if (Array.isArray(parsed) && parsed.length) allData = parsed;
      } catch(e){ console.warn('cache read failed', e); }
    }

    if (!allData || !allData.length){
      allData = await loadDataFromExcelOrCSV();
      try {
        if (typeof LZString !== 'undefined') localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData)));
        else localStorage.setItem(CACHE_KEY, JSON.stringify(allData));
        localStorage.setItem(CACHE_KEY + '_time', String(Date.now()));
      } catch(e){ console.warn('cache save failed', e); }
    }

    // normalize dates
    allData.forEach(item=>{
      item._date = null;
      if (item.rawPeriod) {
        const d = parseEndDate(item.rawPeriod);
        if (d) item._date = d;
      }
      if (!item._date && item.updateDate) { const d = new Date(item.updateDate); if (isValidDate(d)) item._date = stripTime(d); }
      if (!item._date && item.date) { const d = new Date(item.date); if (isValidDate(d)) item._date = stripTime(d); }
    });

    computeSavedAndDiscount(allData);
    computeCombinedScore(allData);

    const dates = [...new Set(allData.filter(x=>x._date instanceof Date).map(x=>formatDateShort(x._date)))].sort().reverse();
    latestTwoDates = dates.slice(0,2);
    newestDateObj = latestTwoDates.length ? new Date(latestTwoDates[0]) : null;
    if (newestDateObj && !isNaN(newestDateObj)) newestDateObj.setHours(0,0,0,0);

    dataLoaded = true;
    initializeFilters();
    applyAllFilters();
    populateTicker();
  } catch(err){
    console.error('fetchData error', err);
    alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (err.message || err) + '\nØ¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¬Ø±Ù‘Ø¨ ØªØ¹Ø·ÙŠÙ„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØªØ¨Ù‘ÙØ¹ Ø£Ùˆ Ø§Ø³ØªØ¶Ù Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹.');
  } finally {
    hideLoadingMessage();
  }
}

/* --- populate ticker --- */
function populateTicker(){
  try {
    const track = byId('ticker-track');
    if (!track) return;
    track.innerHTML = '';
    const maxSavings = Math.max(...allData.map(i => i._saved || 0), 1);
    const top = [...allData].filter(i=>i._discount_pct>0).sort((a,b)=>{
      const da = Math.min((a._discount_pct||0),100)/100;
      const db = Math.min((b._discount_pct||0),100)/100;
      const sa = (a._saved||0)/maxSavings;
      const sb = (b._saved||0)/maxSavings;
      return (db*WEIGHT_DISCOUNT + sb*WEIGHT_SAVINGS) - (da*WEIGHT_DISCOUNT + sa*WEIGHT_SAVINGS);
    }).slice(0,12);

    if (!top.length) { track.innerHTML = '<div class="ticker-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ù…ÙŠØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>'; return; }

    const fragment = document.createDocumentFragment();
    top.forEach(it=>{
      const el = document.createElement('div');
      el.className = 'ticker-item';
      const name = escapeHtml(it.product || 'Ù…Ù†ØªØ¬');
      const market = escapeHtml(it.supermarket || '');
      const discount = it._discount_pct ? `${it._discount_pct}%` : '';
      const saved = it._saved ? `${it._saved} ${it.currency||'EGP'}` : '';
      el.innerHTML = `<span class="badge">${discount}</span> <span>${name}</span> <span style="opacity:.85">â€” ${market}</span> <span style="color:var(--ticker-accent); margin-inline-start:8px;">ÙˆÙØ± ${saved}</span>`;
      fragment.appendChild(el);
    });

    track.appendChild(fragment.cloneNode(true));
    track.appendChild(fragment.cloneNode(true));
    requestAnimationFrame(()=>{
      track.classList.add('animate');
      const viewport = byId('ticker-viewport');
      const trackWidth = track.scrollWidth;
      const speed = 80;
      const duration = Math.max(8, Math.round(trackWidth / speed));
      track.style.setProperty('--ticker-duration', duration + 's');
    });
  } catch(e){ console.error('populateTicker error', e); }
}

/* --- Filters & rendering --- */
function getInputs(){
  return {
    search: (byId('search-input')?.value || '').trim().toLowerCase(),
    supermarket: byId('supermarket-filter')?.value || '',
    category: byId('category-filter')?.value || '',
    brand: byId('brand-filter')?.value || '',
    minDiscount: parseFloat(byId('min-discount')?.value) || 0,
    minPriceRaw: byId('min-price')?.value,
    maxPriceRaw: byId('max-price')?.value,
    sort: byId('sort-by')?.value || 'best-deals'
  };
}

function applyAllFilters(){
  if (!dataLoaded) return;
  try {
    const inputs = getInputs();
    const minPrice = inputs.minPriceRaw === '' ? 0 : (parseFloat(inputs.minPriceRaw) || 0);
    const maxPrice = inputs.maxPriceRaw === '' ? Infinity : (parseFloat(inputs.maxPriceRaw) || Infinity);

    filteredData = allData.filter(item=>{
      try {
        // chip date filters
        if (activeChipFilter === 'one_day') {
          if (!item._date || !newestDateObj) return false;
          const diff = (newestDateObj - item._date) / 86400000;
          if (diff < 0 || diff > 1) return false;
        }
        if (activeChipFilter === 'week') {
          if (!item._date || !newestDateObj) return false;
          const diff = (newestDateObj - item._date) / 86400000;
          if (diff < 0 || diff > 7) return false;
        }

        const price = Number(item.currentPrice) || 0;
        if (price < minPrice || price > maxPrice) return false;
        if ((item._discount_pct || 0) < inputs.minDiscount) return false;
        if (inputs.supermarket && String(item.supermarket || '') !== inputs.supermarket) return false;
        if (inputs.category && String(item.category || '') !== inputs.category) return false;
        if (inputs.brand && String(item.brand || '') !== inputs.brand) return false;
        if (inputs.search) {
          const hay = `${(item.product || '')} ${(item.primaryName || '')} ${(item.brand || '')} ${(item.supermarket || '')}`.toLowerCase();
          if (!hay.includes(inputs.search)) return false;
        }
        if (activeChipFilter === 'hot' && (item._discount_pct || 0) < 30) return false;
        if (activeChipFilter === 'discount' && (item._discount_pct || 0) < 20) return false;
        if (activeChipFilter === 'recent') {
          if (!item._date) return false;
          const dStr = formatDateShort(item._date);
          if (!latestTwoDates.includes(dStr)) return false;
        }
        return true;
      } catch(e){ console.error('filter item error', e, item); return false; }
    });

    // Sorting
    const sort = inputs.sort;
    if (sort === 'best-deals') {
      const maxSaved = Math.max(1, ...filteredData.map(i=>i._saved||0));
      filteredData.sort((a,b)=>{
        const da = Math.min((a._discount_pct||0),100)/100;
        const db = Math.min((b._discount_pct||0),100)/100;
        const sa = (a._saved||0)/maxSaved;
        const sb = (b._saved||0)/maxSaved;
        const scoreA = da*WEIGHT_DISCOUNT + sa*WEIGHT_SAVINGS;
        const scoreB = db*WEIGHT_DISCOUNT + sb*WEIGHT_SAVINGS;
        if (Math.abs(scoreB-scoreA) > 1e-6) return scoreB - scoreA;
        return String(a.product||'').localeCompare(String(b.product||''), 'ar');
      });
    } else if (sort === 'discount-desc') filteredData.sort((a,b)=>(b._discount_pct||0)-(a._discount_pct||0));
    else if (sort === 'saved-desc') filteredData.sort((a,b)=>(b._saved||0)-(a._saved||0));
    else if (sort === 'price-asc') filteredData.sort((a,b)=>(a.currentPrice||0)-(b.currentPrice||0));
    else if (sort === 'price-desc') filteredData.sort((a,b)=>(b.currentPrice||0)-(a.currentPrice||0));
    else if (sort === 'name-asc') filteredData.sort((a,b)=>String(a.product||'').localeCompare(String(b.product||''), 'ar'));
    else if (sort === 'name-desc') filteredData.sort((a,b)=>String(b.product||'').localeCompare(String(a.product||''), 'ar'));

    currentPage = 1;
    renderContent();
    updateStats();
  } catch(e){ console.error('applyAllFilters failed', e); }
}

/* --- pagination & rendering --- */
function getPagedData(){ const start = (currentPage -1)*itemsPerPage; return filteredData.slice(start, start+itemsPerPage); }

function renderProductsGrid(){
  const grid = byId('products-grid'); if(!grid) return;
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
  const pageData = getPagedData();
  if (!pageData.length) { grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>`; updatePagination(); return; }
  pageData.forEach(item=>{
    const card = document.createElement('div'); card.className = 'product-card';
    if(item._discount_pct && item._discount_pct >= 20) card.classList.add('highlight');
    const bestBadge = (item._discount_pct && item._discount_pct > 40) ? `<div class="product-badge">Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶</div>` : '';
    const savedHtml = item._saved ? `<div style="font-size:0.9rem;color:var(--success-green);font-weight:600;">ÙˆÙØ± ${item._saved} ${item.currency||'EGP'}</div>` : '';
    const countdownDays = item._date ? Math.ceil((item._date - new Date()) / (1000*60*60*24)) : null;
    const countdownHtml = (countdownDays !== null && countdownDays >= 0 && countdownDays <= 7) ? `<div class="countdown"><i class="fas fa-clock"></i> ${countdownDays} ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ</div>` : '';
    card.innerHTML = `
      ${bestBadge}
      <div class="favorite-btn" data-id="${escapeHtml(item.product)}"><i class="fas fa-heart"></i></div>
      <div class="product-image"><i class="fas fa-box"></i></div>
      <div class="product-info">
        <h3 class="product-title">${escapeHtml(item.product)}</h3>
        ${item.primaryName ? `<div style="font-size:0.9rem;color:#666;margin-bottom:5px;">${escapeHtml(item.primaryName)}</div>` : ''}
        <div class="price-container">
          <div style="display:flex;flex-direction:column;gap:3px;">
            <span class="current-price">${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</span>
            ${savedHtml}
          </div>
          ${item._discount_pct ? `<span class="discount-badge">-${item._discount_pct}%</span>` : ''}
        </div>
        <div class="product-meta">
          <div class="supermarket-logo"><i class="fas fa-store"></i><span>${escapeHtml(item.supermarket)}</span></div>
          ${countdownHtml}
        </div>
        <div class="action-buttons" style="margin-top:12px">
          <button class="btn btn-secondary view-details-btn" data-id="${escapeHtml(item.product)}"><i class="fas fa-eye"></i> ØªÙØ§ØµÙŠÙ„</button>
          <button class="btn btn-primary buy-now-btn" data-id="${escapeHtml(item.product)}"><i class="fas fa-shopping-cart"></i> Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
        </div>
      </div>
    `;
    card.querySelector('.view-details-btn')?.addEventListener('click', e=>{ e.stopPropagation(); showDetails(item); });
    card.querySelector('.buy-now-btn')?.addEventListener('click', e=>{ e.stopPropagation(); openFlyer(item); });
    card.querySelector('.favorite-btn')?.addEventListener('click', e=>{ e.stopPropagation(); toggleFavorite(item.product); e.currentTarget.classList.toggle('active'); });
    card.addEventListener('click', ()=> openFlyer(item));
    grid.appendChild(card);
  });
  updatePagination();
}

function renderTable(){
  const tbody = byId('table-body'); if(!tbody) return;
  tbody.innerHTML = '';
  const pageData = getPagedData();
  if (!pageData.length) { tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>`; updatePagination(); return; }
  pageData.forEach(item=>{
    const tr = document.createElement('tr');
    if(item._discount_pct && item._discount_pct >= 20) tr.classList.add('highlight');
    tr.onclick = ()=> openFlyer(item);
    tr.innerHTML = `
      <td>${escapeHtml(item.supermarket)}</td>
      <td><strong>${escapeHtml(item.product)}</strong></td>
      <td>${escapeHtml(item.primaryName)}</td>
      <td>${escapeHtml(item.unit || '')}</td>
      <td>${escapeHtml(item.category)}</td>
      <td>${escapeHtml(item.brand)}</td>
      <td><strong style="color:var(--primary-blue);">${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</strong></td>
      <td>${item._discount_pct ? `<span class="discount-badge">-${item._discount_pct}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item._saved ? `<span style="color:var(--success-green);font-weight:600">${item._saved} ${item.currency||'EGP'}</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item._date ? formatDateShort(item._date) : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
    `;
    tbody.appendChild(tr);
  });
  updatePagination();
}

function updatePagination(){
  const pagination = byId('pagination'); if(!pagination) return;
  pagination.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
  if (totalPages <= 1) return;
  const btn = (text, disabled, onClick) => { const b=document.createElement('button'); b.textContent = text; b.disabled = !!disabled; b.addEventListener('click', onClick); return b; };
  pagination.appendChild(btn('Ø§Ù„Ø£ÙˆÙ„Ù‰', currentPage===1, ()=>{ currentPage=1; renderContent(); }));
  pagination.appendChild(btn('Ø§Ù„Ø³Ø§Ø¨Ù‚', currentPage===1, ()=>{ if(currentPage>1){ currentPage--; renderContent(); }}));
  const pageNumbers = document.createElement('div'); pageNumbers.style.display='flex'; pageNumbers.style.gap='6px'; pageNumbers.style.overflowX='auto';
  const start = Math.max(1, currentPage - 3), end = Math.min(totalPages, currentPage + 3);
  for (let i=start;i<=end;i++){
    const p = document.createElement('button'); p.textContent = i;
    if (i===currentPage){ p.style.background='var(--primary-blue)'; p.style.color='white'; }
    p.addEventListener('click', ()=>{ currentPage = i; renderContent(); });
    pageNumbers.appendChild(p);
  }
  pagination.appendChild(pageNumbers);
  pagination.appendChild(btn('Ø§Ù„ØªØ§Ù„ÙŠ', currentPage===totalPages, ()=>{ if(currentPage<totalPages){ currentPage++; renderContent(); }}));
  pagination.appendChild(btn('Ø§Ù„Ø£Ø®ÙŠØ±Ø©', currentPage===totalPages, ()=>{ currentPage = totalPages; renderContent(); }));
}

function renderContent(){ if (currentView === 'table'){ byId('products-grid').style.display='none'; byId('data-table').style.display='block'; renderTable(); } else { byId('data-table').style.display='none'; byId('products-grid').style.display='grid'; renderProductsGrid(); } }

function updateStats(){
  try {
    byId('total-offers').textContent = (filteredData.length || 0).toLocaleString();
    const discounts = filteredData.filter(i=>i._discount_pct).map(i=>i._discount_pct);
    const avgDiscount = discounts.length ? Math.round(discounts.reduce((a,b)=>a+b,0)/discounts.length) : 0;
    byId('avg-discount').textContent = `${avgDiscount}%`;
    byId('hot-deals').textContent = (filteredData.filter(i=> (i._discount_pct||0) > 30).length || 0).toLocaleString();
    byId('ending-soon').textContent = (filteredData.filter(i=> i._date && ((i._date - new Date())/(1000*3600*24) <= 7) && ((i._date - new Date())/(1000*3600*24) >= 0)).length || 0).toLocaleString();
    byId('total-supermarkets').textContent = ([...new Set(filteredData.map(i=>i.supermarket).filter(Boolean))].length || 0).toLocaleString();
  } catch(e){ console.error('updateStats failed', e); }
}

/* --- small utilities --- */
function openFlyer(item){ if(!item) return; const flyerUrl = item.solution_key ? `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg` : null; if(flyerUrl) window.open(flyerUrl, '_blank'); else alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙ„Ø§ÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±'); }
function showDetails(item){ if(!item) return alert('ØºÙŠØ± Ù…ØªØ§Ø­'); const details = [
  `Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬: ${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ${item.primaryName || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª: ${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„ÙØ¦Ø©: ${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„Ø®ØµÙ…: ${item._discount_pct ? item._discount_pct + '%' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø§Ù„ØªÙˆÙÙŠØ±: ${item._saved ? item._saved + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`,
  `Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰: ${item._date ? formatDateShort(item._date) : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`
].join('\n'); alert(details); }

/* --- filters wiring --- */
function debounce(fn, wait=300){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }
const debounceApply = debounce(()=> applyAllFilters(), 300);

function initializeFilters(){
  try {
    const supermarketSelect = byId('supermarket-filter'); if (supermarketSelect) {
      supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
      [...new Set(allData.map(i=>i.supermarket))].filter(Boolean).sort((a,b)=>String(a).localeCompare(String(b),'ar')).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; supermarketSelect.appendChild(o); });
      supermarketSelect.addEventListener('change', applyAllFilters);
    }
    const categorySelect = byId('category-filter'); if(categorySelect){
      categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
      [...new Set(allData.map(i=>i.category))].filter(Boolean).sort((a,b)=>String(a).localeCompare(String(b),'ar')).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; categorySelect.appendChild(o); });
      categorySelect.addEventListener('change', applyAllFilters);
    }
    const brandSelect = byId('brand-filter'); if(brandSelect){
      brandSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</option>';
      [...new Set(allData.map(i=>i.brand))].filter(Boolean).sort((a,b)=>String(a).localeCompare(String(b),'ar')).forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; brandSelect.appendChild(o); });
      brandSelect.addEventListener('change', applyAllFilters);
    }

    document.querySelectorAll('.chip').forEach(c=>{
      c.addEventListener('click', function(){
        document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        activeChipFilter = this.dataset.filter || 'all';
        applyAllFilters();
      });
    });

    byId('view-grid-btn')?.addEventListener('click', ()=>{ currentView='grid'; byId('view-grid-btn')?.classList.add('active'); byId('view-table-btn')?.classList.remove('active'); renderContent(); });
    byId('view-table-btn')?.addEventListener('click', ()=>{ currentView='table'; byId('view-table-btn')?.classList.add('active'); byId('view-grid-btn')?.classList.remove('active'); renderContent(); });

    const search = byId('search-input'); if (search){
      search.addEventListener('input', ()=>{ debounceApply(); });
      search.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); applyAllFilters(); }});
    }

    byId('sort-by')?.addEventListener('change', applyAllFilters);
    byId('min-discount')?.addEventListener('input', applyAllFilters);
    byId('reset-btn')?.addEventListener('click', ()=>{ resetAllFilters(); applyAllFilters(); });
    byId('share-app')?.addEventListener('click', ()=>{ navigator.clipboard?.writeText(location.href); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'); });
    byId('compare-mode-btn')?.addEventListener('click', ()=>{ const p = byId('comparison-panel'); if(p) p.style.display = (p.style.display === 'block' ? 'none' : 'block'); });

    byId('min-decrease')?.addEventListener('click', ()=> adjustNumberInput(byId('min-price'), -1));
    byId('min-increase')?.addEventListener('click', ()=> adjustNumberInput(byId('min-price'), +1));
    byId('max-decrease')?.addEventListener('click', ()=> adjustNumberInput(byId('max-price'), -1));
    byId('max-increase')?.addEventListener('click', ()=> adjustNumberInput(byId('max-price'), +1));
  } catch(e){ console.error('initializeFilters failed', e); }
}

function adjustNumberInput(el, delta){ if(!el) return; const step = parseFloat(el.step)||1; const cur = parseFloat(el.value)||0; el.value = Math.max(0, +(cur + delta*step).toFixed(2)); debounceApply(); }
function resetAllFilters(){ byId('search-input').value=''; byId('supermarket-filter').value=''; byId('category-filter').value=''; byId('brand-filter').value=''; byId('min-discount').value=''; byId('min-price').value=''; byId('max-price').value=''; byId('sort-by').value='best-deals'; activeChipFilter='all'; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); document.querySelector('.chip[data-filter="all"]')?.classList.add('active'); }

/* --- init --- */
async function init(){
  try {
    await fetchData();
    initializeFilters();
    // wire autocomplete minimal: show list on input (kept simple)
    const search = byId('search-input');
    if (search) search.addEventListener('input', ()=>{ /* leave built-in behaviour */ });
  } catch(e){ console.error('init error', e); }
}

    
    
document.addEventListener('DOMContentLoaded', ()=>{ init(); });

</script>
    
    <script>
/* =========================
   BOOTSTRAP (ONE TIME ONLY)
========================= */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await init();
    handleUrlParams();
    renderMiniCarousel();
    renderComparison();
    const main = byId('main-content');
    if (main) main.style.display = 'block';
  } catch (e) {
    console.error('Init error', e);
  }
});

/* =========================
   PAGINATION
========================= */
function renderPagination() {
  const p = byId('pagination');
  if (!p) return;

  p.innerHTML = '';

  const totalPages = Math.max(
    1,
    Math.ceil((filteredData.length || 0) / itemsPerPage)
  );

  if (totalPages <= 1) return;

  const makeBtn = (txt, disabled, cb) => {
    const b = document.createElement('button');
    b.textContent = txt;
    b.disabled = !!disabled;
    b.addEventListener('click', cb);
    return b;
  };

  p.appendChild(
    makeBtn('Ø§Ù„Ø£ÙˆÙ„Ù‰', currentPage === 1, () => {
      currentPage = 1;
      renderContent();
    })
  );

  p.appendChild(
    makeBtn('Ø§Ù„Ø³Ø§Ø¨Ù‚', currentPage === 1, () => {
      if (currentPage > 1) {
        currentPage--;
        renderContent();
      }
    })
  );

  const start = Math.max(1, currentPage - 2);
  const end = Math.min(totalPages, currentPage + 2);

  for (let i = start; i <= end; i++) {
    const btn = makeBtn(i, false, () => {
      currentPage = i;
      renderContent();
    });
    if (i === currentPage) {
      btn.style.background = 'var(--accent)';
      btn.style.color = '#fff';
    }
    p.appendChild(btn);
  }

  p.appendChild(
    makeBtn('Ø§Ù„ØªØ§Ù„ÙŠ', currentPage === totalPages, () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderContent();
      }
    })
  );

  p.appendChild(
    makeBtn('Ø§Ù„Ø£Ø®ÙŠØ±Ø©', currentPage === totalPages, () => {
      currentPage = totalPages;
      renderContent();
    })
  );
}

/* =========================
   STATS
========================= */
function updateStats() {
  try {
    byId('total-offers').textContent =
      (filteredData.length || 0).toLocaleString();

    const discounts = filteredData
      .map(i => i._discount_pct)
      .filter(v => typeof v === 'number');

    const avg = discounts.length
      ? Math.round(discounts.reduce((a, b) => a + b, 0) / discounts.length)
      : 0;

    byId('avg-discount').textContent = `${avg}%`;

    byId('total-supermarkets').textContent =
      [...new Set(filteredData.map(i => i.supermarket).filter(Boolean))].length;

    byId('category-count').textContent =
      [...new Set(filteredData.map(i => i.category).filter(Boolean))].length;
  } catch (e) {
    console.error('Stats error', e);
  }
}

/* =========================
   FAVORITES
========================= */
function toggleFavoriteFromCard(e) {
  e.stopPropagation();
  const card = e.currentTarget.closest('.product-card');
  if (!card) return;
  const title = card.querySelector('.product-title')?.textContent;
  if (!title) return;
  toggleFavorite(title);
  applyAllFilters();
}

/* =========================
   COMPARISON
========================= */
function addToCompareFromCard(e) {
  e.stopPropagation();
  const card = e.currentTarget.closest('.product-card');
  if (!card) return;

  const title = card.querySelector('.product-title')?.textContent;
  const item = allData.find(x => x.product === title);
  if (!item) return;

  const idx = comparison.findIndex(c => c.product === item.product);

  if (idx === -1) {
    if (comparison.length >= 4) {
      alert('ÙŠÙ…ÙƒÙ† Ù…Ù‚Ø§Ø±Ù†Ø© 4 Ù…Ù†ØªØ¬Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰');
      return;
    }
    comparison.push(item);
  } else {
    comparison.splice(idx, 1);
  }

  localStorage.setItem('comparison', JSON.stringify(comparison));
  renderComparison();
}

function renderComparison() {
  const container = byId('comparison-items');
  if (!container) return;

  container.innerHTML = '';
  byId('comparison-count').textContent = comparison.length;

  comparison.forEach(it => {
    const box = document.createElement('div');
    box.style.minWidth = '180px';
    box.style.padding = '10px';
    box.style.border = '1px solid #eee';
    box.style.borderRadius = '8px';
    box.style.background = '#fff';

    box.innerHTML = `
      <div style="font-weight:800">${escapeHtml(it.product)}</div>
      <div style="color:#666;font-size:13px">${escapeHtml(it.supermarket || '')}</div>
      <div style="margin-top:6px;color:var(--accent)">
        ${it.currentPrice ? it.currentPrice + ' ' + (it.currency || 'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}
      </div>
    `;

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'Ø¥Ø²Ø§Ù„Ø©';
    btn.style.marginTop = '8px';
    btn.onclick = () => {
      comparison = comparison.filter(c => c.product !== it.product);
      localStorage.setItem('comparison', JSON.stringify(comparison));
      renderComparison();
    };

    box.appendChild(btn);
    container.appendChild(box);
  });

  byId('comparison-panel').style.display =
    comparison.length > 0 ? 'block' : 'none';
}

/* =========================
   MINI CAROUSEL
========================= */
function renderMiniCarousel() {
  const inner = byId('mini-inner');
  if (!inner) return;

  inner.innerHTML = '';
  const candidates = allData.filter(i => i._saved > 0).slice(0, 8);

  if (!candidates.length) {
    inner.innerHTML = '<div class="mini-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶</div>';
    return;
  }

  candidates.forEach(it => {
    const div = document.createElement('div');
    div.className = 'mini-item';
    div.innerHTML = `
      <strong>${escapeHtml(it.product)}</strong>
      <span style="color:var(--muted);font-size:13px">
        â€” ${escapeHtml(it.supermarket || '')}
      </span>`;
    inner.appendChild(div);
  });

  let idx = 0;
  clearInterval(window._miniInterval);
  window._miniInterval = setInterval(() => {
    idx = (idx + 1) % inner.children.length;
    inner.style.transform = `translateX(-${idx * 100}%)`;
  }, 3200);
}

/* =========================
   URL PARAMS
========================= */
function handleUrlParams() {
  const params = new URLSearchParams(window.location.search);

  const q = params.get('q');
  if (q) byId('search-input').value = decodeURIComponent(q);

  const disc = params.get('discount');
  if (disc) byId('min-discount').value = disc;

  if (params.get('one_day')) activeChipFilter = 'recent_day';
  if (params.get('week_percent')) activeChipFilter = 'recent';

  applyAllFilters();
}

/* =========================
   EXPORT GLOBALS
========================= */
window.addToCompareFromCard = addToCompareFromCard;
window.toggleFavoriteFromCard = toggleFavoriteFromCard;
window.applyFilters = applyAllFilters;
</script>

  </body>
</html>
