<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª â€” Ù…ØµØ­Ø­</title>

<!-- External libs used by original file -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" defer></script>

<style>
  :root{
    --bg-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    --card-bg:#fff;
    --muted:#666;
    --accent:#4caf50;
    --danger:#ff4444;
    --gap:12px;
    --radius:12px;
    --text:#222;
    --control-height:46px;
    --base-font:15px;
    --highlight-yellow:#fff3b0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background:var(--bg-1);
    color:var(--text);
    padding:16px;
    -webkit-font-smoothing:antialiased;
  }
  .container{ max-width:1200px; margin:0 auto; }
  header{ background:rgba(255,255,255,0.95); border-radius:12px; padding:12px; text-align:center; margin-bottom:12px; box-shadow:0 8px 20px rgba(0,0,0,0.12); }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
  input,select,button{ height:var(--control-height); padding:0 12px; border-radius:10px; border:2px solid #eee; background:white; font-size:15px; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #data-table{ background:var(--card-bg); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.12); overflow:hidden; margin-top:12px; padding:8px; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  thead th{ background:var(--accent); color:#fff; padding:12px; text-align:left; position:sticky; top:0; }
  tbody td{ padding:10px 12px; border-bottom:1px solid #f0f0f0; }
  .card-list{ display:none }
  .highlight{ background:var(--highlight-yellow) !important; }
  #loading{ text-align:center; padding:18px; color:#fff; }
  #autocomplete-list{ position:absolute; z-index:9999; background:white; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); max-height:240px; overflow:auto; }
  .price-controls{ display:flex; gap:8px; align-items:center; }
  .price-controls button{ width:36px; height:36px; padding:0; font-size:18px; line-height:1; }
  @media (max-width:900px){
    .card-list{ display:flex; flex-direction:column }
    table{ display:none }
    .controls{ flex-direction:column; align-items:stretch }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ğŸ›’ Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª â€” Ù…ØµØ­Ø­</h1>
    <p>Ø¥ØµØ¯Ø§Ø± Ù…ÙØ¹Ø¯Ù‘Ù„: Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ø­Ø« ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø¹Ø±</p>
  </header>

  <div class="controls" role="region" aria-label="Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…">
    <div class="row" style="flex:1;">
      <input id="search-input" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..." aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«" />
      <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª"><option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option></select>
      <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
    </div>

    <div class="row" style="width:100%; gap:6px;">
      <!-- Min price with controls -->
      <div class="price-controls" style="align-items:center;">
        <button id="min-decrease" type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">âˆ’</button>
        <input id="min-price" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5" min="0" />
        <button id="min-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">+</button>
      </div>

      <!-- Max price with controls -->
      <div class="price-controls" style="align-items:center;">
        <button id="max-decrease" type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">âˆ’</button>
        <input id="max-price" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5" min="0" />
        <button id="max-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">+</button>
      </div>

      <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
        <option value="">ÙØ±Ø² Ø­Ø³Ø¨</option>
        <option value="discount-desc">Ø§Ù„Ø®ØµÙ… % - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
        <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± - ØªØµØ§Ø¹Ø¯ÙŠ</option>
      </select>

      <input id="min-discount" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…" />

      <div style="display:flex;gap:8px;">
        <!-- Apply button removed as requested -->
        <button id="reset-btn" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
    </div>
  </div>

  <div class="stats" style="display:flex;gap:12px;margin-bottom:12px;">
    <div style="background:var(--card-bg);padding:10px;border-radius:10px;min-width:120px;">
      <div style="font-size:13px;color:var(--muted)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
      <div id="total-offers" style="font-weight:700;font-size:18px">0</div>
    </div>
    <div style="background:var(--card-bg);padding:10px;border-radius:10px;min-width:120px;">
      <div style="font-size:13px;color:var(--muted)">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</div>
      <div id="avg-discount" style="font-weight:700;font-size:18px">0%</div>
    </div>
  </div>

  <div id="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

  <div id="data-table" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶" style="display:none;">
    <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
          <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„ÙØ¦Ø©</th>
          <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</th>
          <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ø®ØµÙ…</th>
          <th>Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>

    <div class="card-list" id="card-list" aria-hidden="true"></div>
    <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª"></div>
  </div>
</div>

<script>
/* ================= Configuration ================= */
const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
const CACHE_KEY = 'offersData';
const CACHE_EXPIRY = 3600000; // 1 hour
/* ================================================= */

let allData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;
let debounceTimer = null;

/* Debounce helper */
function debounce(fn, wait=250){
  return function(...args){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>fn.apply(this,args), wait);
  };
}

/* Date parsing helpers */
function parseEndDate(period){
  if (!period) return null;
  const s = String(period);
  const parts = s.split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).map(p=>p.trim()).filter(Boolean);
  let candidate = parts.length>1 ? parts[parts.length-1] : parts[0];
  candidate = candidate.replace(/^(Ù…Ù†|Ø¥Ù„Ù‰|Ø­ØªÙ‰)\s*/i,'').trim();
  let d = new Date(candidate);
  if (isNaN(d)) {
    const dm = candidate.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/);
    if (dm){
      let day=dm[1].padStart(2,'0'), month=dm[2].padStart(2,'0'), year=dm[3];
      if (year.length===2) year='20'+year;
      d = new Date(`${year}-${month}-${day}`);
    } else {
      const ym = candidate.match(/(\d{4})[\/\.-](\d{1,2})[\/\.-](\d{1,2})/);
      if (ym) d = new Date(`${ym[1]}-${ym[2].padStart(2,'0')}-${ym[3].padStart(2,'0')}`);
    }
  }
  return (d instanceof Date && !isNaN(d.getTime())) ? d : null;
}
function isValidDate(d){ return d instanceof Date && !isNaN(d.getTime()); }
function formatDateShort(d){ if(!isValidDate(d)) return 'ØºÙŠØ± Ù…ØªØ§Ø­'; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

/* Compute saved & discount */
function computeSavedAndDiscount(arr){
  arr.forEach(item=>{
    const orig = Number(item.originalPrice) || 0;
    const curr = Number(item.currentPrice) || 0;
    let saved = 0;
    if (orig>0 && curr>0) saved = orig - curr;
    else if (orig>0 && item.discount) saved = orig * (Number(item.discount)/100);
    else if (curr>0 && item.discount) saved = curr * (Number(item.discount)/100);
    item._saved = Math.max(0, Number((saved||0).toFixed(2)));
    item._discount_pct = (item.discount && !isNaN(item.discount)) ? Number(item.discount) : (orig>0 && curr>0 ? Math.round(((orig-curr)/orig)*100) : 0);
  });
}
function computeCombinedScore(arr){
  if(!arr || !arr.length) return;
  const savedVals = arr.map(i=>i._saved||0), pctVals = arr.map(i=>i._discount_pct||0);
  const maxSaved = Math.max(...savedVals,0), minSaved = Math.min(...savedVals,0);
  const maxPct = Math.max(...pctVals,0), minPct = Math.min(...pctVals,0);
  const savedRange = (maxSaved - minSaved) || 1;
  const pctRange = (maxPct - minPct) || 1;
  arr.forEach(item=>{
    const ns = ((item._saved||0)-minSaved)/savedRange;
    const np = ((item._discount_pct||0)-minPct)/pctRange;
    item._score = Math.max(ns, np);
  });
}

/* Rendering functions */
function renderTable(){
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  const start = (currentPage-1)*itemsPerPage;
  const pageData = filteredData.slice(start, start+itemsPerPage);
  pageData.forEach(item=>{
    const tr = document.createElement('tr');
    const url = item.solution_key ? `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg` : '#';
    if(url && url!=='#'){ tr.style.cursor='pointer'; tr.title='Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶'; tr.onclick = ()=>window.open(url, '_blank'); }
    if(item._discount_pct && item._discount_pct >= 20) tr.classList.add('highlight');
    tr.innerHTML = `
      <td>${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.originalPrice ? item.originalPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item._discount_pct ? `<span class="discount-badge">${item._discount_pct}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.validUntil || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
    `;
    tbody.appendChild(tr);
  });
  updatePagination();
}

function updatePagination(){
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
  const btn = (text, disabled, onClick) => { const b = document.createElement('button'); b.textContent = text; b.disabled = !!disabled; b.addEventListener('click', onClick); return b; };
  pagination.appendChild(btn('Ø§Ù„Ø£ÙˆÙ„Ù‰', currentPage===1, ()=>{ currentPage=1; renderTable(); }));
  pagination.appendChild(btn('Ø§Ù„Ø³Ø§Ø¨Ù‚', currentPage===1, ()=>{ if(currentPage>1){ currentPage--; renderTable(); }}));
  const pageNumbers = document.createElement('div'); pageNumbers.style.display='flex'; pageNumbers.style.gap='6px'; pageNumbers.style.overflowX='auto';
  for(let i=1;i<=totalPages;i++){
    const p = document.createElement('button'); p.textContent = i;
    if(i===currentPage){ p.style.background = 'var(--accent)'; p.style.color='white'; }
    p.addEventListener('click', ()=>{ currentPage=i; renderTable(); });
    pageNumbers.appendChild(p);
  }
  pagination.appendChild(pageNumbers);
  pagination.appendChild(btn('Ø§Ù„ØªØ§Ù„ÙŠ', currentPage===totalPages, ()=>{ if(currentPage<totalPages){ currentPage++; renderTable(); }}));
  pagination.appendChild(btn('Ø§Ù„Ø£Ø®ÙŠØ±Ø©', currentPage===totalPages, ()=>{ currentPage=totalPages; renderTable(); }));
}

/* Stats */
function updateStats(){
  document.getElementById('total-offers').textContent = filteredData.length;
  const discounts = filteredData.filter(i=>i._discount_pct).map(i=>i._discount_pct);
  const avgDiscount = discounts.length ? Math.round(discounts.reduce((a,b)=>a+b,0)/discounts.length) : 0;
  document.getElementById('avg-discount').textContent = `${avgDiscount}%`;
}

/* Autocomplete */
function clearAutocomplete(){
  const list = document.getElementById('autocomplete-list');
  if(list) list.remove();
}
function showAutocomplete(){
  clearAutocomplete();
  const val = document.getElementById('search-input').value.trim().toLowerCase();
  if(!val) return;
  const list = document.createElement('div');
  list.id = 'autocomplete-list';
  document.body.appendChild(list);
  const suggestions = [...new Set(allData.map(i=>i.product).concat(allData.map(i=>i.primaryName||'')))]
    .filter(s=>s && s.toLowerCase().includes(val)).slice(0,8);
  suggestions.forEach(s=>{
    const d = document.createElement('div');
    d.textContent = s;
    d.style.padding='8px 10px';
    d.style.cursor='pointer';
    d.addEventListener('click', ()=>{
      document.getElementById('search-input').value = s;
      clearAutocomplete();
      debouncedApplyFilters();
    });
    list.appendChild(d);
  });
  const rect = document.getElementById('search-input').getBoundingClientRect();
  list.style.left = `${Math.max(8, rect.left + window.scrollX)}px`;
  list.style.top = `${rect.bottom + window.scrollY}px`;
  list.style.minWidth = `${rect.width}px`;
}

/* Core filtering function */
function applyFilters(){
  const search = (document.getElementById('search-input').value || '').trim().toLowerCase();
  const supermarket = document.getElementById('supermarket-filter').value || '';
  const category = document.getElementById('category-filter').value || '';
  const minDiscount = parseFloat(document.getElementById('min-discount').value) || 0;
  const minPriceRaw = document.getElementById('min-price').value;
  const maxPriceRaw = document.getElementById('max-price').value;
  const minPrice = minPriceRaw === '' ? 0 : (parseFloat(minPriceRaw) || 0);
  const maxPrice = maxPriceRaw === '' ? Infinity : (parseFloat(maxPriceRaw) || Infinity);
  const sort = document.getElementById('sort-by').value || '';

  // Normalize min/max: if min > max, swap to keep consistent UX
  if(isFinite(minPrice) && isFinite(maxPrice) && minPrice > maxPrice){
    const tmp = document.getElementById('min-price').value;
    document.getElementById('min-price').value = document.getElementById('max-price').value;
    document.getElementById('max-price').value = tmp;
  }

  filteredData = allData.filter(item=>{
    const prod = (item.product||'').toString().toLowerCase();
    const primary = (item.primaryName||'').toString().toLowerCase();
    const brand = (item.brand||'').toString().toLowerCase();
    const supermarketMatch = !supermarket || (item.supermarket === supermarket);
    const categoryMatch = !category || (item.category === category);
    const priceVal = Number(item.currentPrice) || 0;
    const priceMatch = priceVal >= minPrice && priceVal <= maxPrice;
    const discountMatch = (item._discount_pct||0) >= minDiscount;
    const textMatch = !search || prod.includes(search) || primary.includes(search) || brand.includes(search) || (item.supermarket||'').toString().toLowerCase().includes(search);
    return supermarketMatch && categoryMatch && priceMatch && discountMatch && textMatch;
  });

  if(sort === 'discount-desc') filteredData.sort((a,b)=> (b._discount_pct||0)-(a._discount_pct||0));
  else if(sort === 'price-asc') filteredData.sort((a,b)=> (a.currentPrice||0)-(b.currentPrice||0));

  currentPage = 1;
  renderTable();
  updateStats();
}

/* Debounced wrapper */
const debouncedApplyFilters = debounce(()=>applyFilters(), 250);

/* Price controls wiring and helpers */
function parseNumberInput(el){
  const v = parseFloat(el.value);
  return isFinite(v) ? v : NaN;
}
function adjustNumberInput(el, delta){
  const step = parseFloat(el.step) || 1;
  const cur = parseNumberInput(el);
  const base = isNaN(cur) ? 0 : cur;
  const next = Math.max(0, +(base + delta * step).toFixed(2));
  el.value = next;
  debouncedApplyFilters();
}
function normalizeMinMax(minEl, maxEl){
  const minV = parseNumberInput(minEl);
  const maxV = parseNumberInput(maxEl);
  if(!isNaN(minV) && !isNaN(maxV) && minV > maxV){
    const tmp = minEl.value;
    minEl.value = maxEl.value;
    maxEl.value = tmp;
  }
}
function wirePriceControls(){
  const minEl = document.getElementById('min-price');
  const maxEl = document.getElementById('max-price');
  const minDec = document.getElementById('min-decrease');
  const minInc = document.getElementById('min-increase');
  const maxDec = document.getElementById('max-decrease');
  const maxInc = document.getElementById('max-increase');

  minDec.addEventListener('click', ()=>{ adjustNumberInput(minEl, -1); });
  minInc.addEventListener('click', ()=>{ adjustNumberInput(minEl, +1); });
  maxDec.addEventListener('click', ()=>{ adjustNumberInput(maxEl, -1); });
  maxInc.addEventListener('click', ()=>{ adjustNumberInput(maxEl, +1); });

  ['input','change','keyup'].forEach(evt=>{
    minEl.addEventListener(evt, ()=>{
      normalizeMinMax(minEl, maxEl);
      debouncedApplyFilters();
    });
    maxEl.addEventListener(evt, ()=>{
      normalizeMinMax(minEl, maxEl);
      debouncedApplyFilters();
    });
  });

  minEl.addEventListener('blur', ()=>{ if(parseNumberInput(minEl) < 0 || isNaN(parseNumberInput(minEl))) minEl.value=''; debouncedApplyFilters(); });
  maxEl.addEventListener('blur', ()=>{ if(parseNumberInput(maxEl) < 0 || isNaN(parseNumberInput(maxEl))) maxEl.value=''; debouncedApplyFilters(); });
}

/* Initialize filters and event wiring */
function initializeFilters(){
  const supermarketSelect = document.getElementById('supermarket-filter');
  supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
  const supermarkets = [...new Set(allData.map(i=>i.supermarket))].filter(Boolean);
  supermarkets.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; supermarketSelect.appendChild(o); });

  const categorySelect = document.getElementById('category-filter');
  categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
  const categories = [...new Set(allData.map(i=>i.category))].filter(Boolean);
  categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; categorySelect.appendChild(o); });

  const search = document.getElementById('search-input');
  search.addEventListener('input', ()=>{ showAutocomplete(); debouncedApplyFilters(); });
  search.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); clearAutocomplete(); applyFilters(); } });

  document.addEventListener('click', (e)=>{
    const list = document.getElementById('autocomplete-list');
    const input = document.getElementById('search-input');
    if(!list) return;
    if(e.target.closest && (e.target.closest('#autocomplete-list') || e.target === input)) return;
    clearAutocomplete();
  });

  supermarketSelect.addEventListener('change', debouncedApplyFilters);
  categorySelect.addEventListener('change', debouncedApplyFilters);
  document.getElementById('sort-by').addEventListener('change', debouncedApplyFilters);
  document.getElementById('min-discount').addEventListener('input', debouncedApplyFilters);

  document.getElementById('reset-btn').addEventListener('click', ()=>{ resetFilters(); });

  wirePriceControls();
}

/* Reset filters */
function resetFilters(){
  document.getElementById('search-input').value='';
  document.getElementById('supermarket-filter').value='';
  document.getElementById('category-filter').value='';
  document.getElementById('min-discount').value='';
  document.getElementById('min-price').value='';
  document.getElementById('max-price').value='';
  document.getElementById('sort-by').value='';
  applyFilters();
}

/* Fetch and prepare data */
async function fetchData(){
  try{
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading').textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

    const cached = localStorage.getItem(CACHE_KEY);
    const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
    if(cached && cachedTime && (Date.now() - cachedTime) < CACHE_EXPIRY){
      try{ allData = JSON.parse(LZString.decompressFromUTF16(cached)) || []; } catch(e){ console.warn('cache parse failed', e); allData = []; }
    }

    if(!allData || !allData.length){
      const res = await fetch(DATA_URL);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true, trim:true, dynamicTyping:true });
      allData = parsed.data.map(item=>{
        const raw = item['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || item['Validity Period'] || '';
        const end = parseEndDate(String(raw));
        const validUntilStr = end ? formatDateShort(end) : (String(raw).split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).slice(-1)[0]||'ØºÙŠØ± Ù…ØªØ§Ø­');
        return {
          supermarket: item['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || item['supermarket'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          product: item['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          primaryName: item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || '',
          category: item['Ø§Ù„ÙØ¦Ø©'] || item['category'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          brand: item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || item['brand'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          originalPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ']) || 0,
          currentPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0,
          discount: parseFloat(item['Ø§Ù„Ø®ØµÙ… %']) || 0,
          promotion: item['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || '',
          rawPeriod: raw,
          endDate: end,
          validUntil: validUntilStr,
          currency: item['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP',
          solution_key: (item['solution_key']||item['solution key']||item['Solution_key']||item['solutionKey']||'')
        };
      });
      try{ localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData))); localStorage.setItem(`${CACHE_KEY}_time`, Date.now()); } catch(e){ console.warn('cache save failed', e); }
    }

    computeSavedAndDiscount(allData);
    computeCombinedScore(allData);
    allData.sort((a,b)=>{ if((b._score||0)!==(a._score||0)) return (b._score||0)-(a._score||0); if((b._saved||0)!==(a._saved||0)) return (b._saved||0)-(a._saved||0); return (b._discount_pct||0)-(a._discount_pct||0); });

    initializeFilters();
    applyFilters();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('data-table').style.display = 'block';
  } catch(err){
    console.error(err);
    document.getElementById('loading').textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}`;
  }
}

/* Kick off */
document.addEventListener('DOMContentLoaded', fetchData);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ /* re-render if needed */ } });

</script>
</body>
</html>
