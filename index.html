<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #222;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        h1 { color: #333; margin-bottom: 6px; font-size: 20px; }

        /* Top area: left small minimized frame + banner ticker on the right */
        .top-frames {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 14px;
        }

        /* Minimized first frame (small width) */
        .carousel {
            width: 240px;                /* minimized width */
            min-width: 180px;
            height: 56px;               /* small height */
            overflow: hidden;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            position: relative;
            padding: 6px;
            direction: rtl;
        }

        .carousel-inner {
            display: flex;
            transition: transform 0.45s ease;
            width: 100%;
            height: 100%;
            align-items: center;
        }

        .carousel-item {
            min-width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            padding: 0 6px;
            font-size: 13px;
        }

        .carousel-item .product-title { font-weight: 600; font-size: 13px; color: #111; }
        .carousel-item .meta { color: #666; font-size: 12px; margin-left: 6px; }

        .carousel-prev, .carousel-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.12);
            color: #fff;
            border: none;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 6px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .carousel-prev { left: 6px; }
        .carousel-next { right: 6px; }

        /* Banner ticker (kept as-is) */
        .banner-ticker {
            flex: 1;                    /* occupy remaining space */
            height: 64px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            direction: ltr; /* keep LTR for the scrolling animation */
            padding: 6px 10px;
        }

        .ticker-viewport { width: 100%; overflow: hidden; }
        .ticker-track {
            display: flex;
            gap: 48px;
            align-items: center;
            padding: 0 12px;
            will-change: transform;
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
            font-size: 15px;
            color: #111;
        }

        .ticker-item a { color: inherit; text-decoration: none; display: inline-flex; gap: 8px; align-items: center; }
        .ticker-item .badge { background: #ff4444; color: #fff; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 13px; }
        .ticker-item .price { font-weight: 700; color: #0b66a3; }
        .ticker-item .saved { background:#ffd54d; color:#333; padding:3px 6px; border-radius:6px; font-weight:700; font-size:12px; }

        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); } /* duplicated content for seamless loop */
        }

        .ticker-track.scrolling {
            animation-name: scroll-left;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        /* controls and rest of UI */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin: 8px 0 18px;
        }

        select, input, button { padding: 10px 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background: white; }
        /* keep generic buttons styling for controls */
        .controls button { background: #4CAF50; color: white; border: none; cursor: pointer; transition: background 0.2s; }
        .controls button:hover { background: #45a049; }
        #search-input { width: 100%; max-width: 300px; direction: rtl; }

        .stats { display: flex; flex-wrap: wrap; gap: 12px; margin: 12px 0; }
        .stat-card { flex: 1; min-width: 160px; background: white; padding: 12px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
        .stat-card h3 { color: #666; font-size: 13px; margin-bottom: 6px; }
        .stat-card .value { font-size: 20px; font-weight: 700; color: #333; }

        #chart-container { margin: 16px 0; display: none; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }

        #data-table { width: 100%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-top: 16px; }
        #data-table table { width: 100%; border-collapse: collapse; }
        #data-table th { background: #4CAF50; color: white; padding: 12px; text-align: left; position: sticky; top: 0; }
        #data-table td { padding: 10px 12px; border-bottom: 1px solid #eee; }
        #data-table tr:hover { background: #f0f8ff; cursor: pointer; }

        .highlight { background: #fff7d6 !important; }
        .discount-badge { background: #ff4444; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; animation: pulse 1s infinite; }
        @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)} }

        /* pagination improvements:
           - ensure control buttons (First / Prev / Next / Last) are always visible
           - page numbers occupy remaining space and are horizontally scrollable
           - explicit text color so numbers are visible (avoids being white on white)
        */
        .pagination {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
            padding: 8px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            justify-content: center;
            overflow: visible; /* allow children to be visible */
        }
        .pagination .control-btn {
            min-width: 52px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            padding: 6px 10px;
            font-size: 14px;
            color: #333; /* ensure visible number color */
            flex: 0 0 auto;
        }
        .pagination .control-btn[disabled] { opacity: 0.5; cursor: not-allowed; }

        .pagination .page-numbers {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px;
            -webkit-overflow-scrolling: touch;
            flex: 1 1 auto;    /* take remaining space */
            min-width: 120px;
        }
        .pagination .page-numbers button {
            min-width: 44px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            padding: 6px 10px;
            font-size: 14px;
            white-space: nowrap;
            color: #333; /* ensure numbers visible */
            flex: 0 0 auto;
        }
        .pagination .page-numbers button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* small scrollbar styling so user sees scroll area */
        .pagination .page-numbers::-webkit-scrollbar { height: 8px; }
        .pagination .page-numbers::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 8px; }

        .loading { text-align:center; padding: 24px; color: #fff; font-size: 16px; }

        @media (max-width: 900px) {
            .top-frames { flex-direction: column; align-items: stretch; }
            .carousel { width: 100%; height: 56px; }
            .banner-ticker { height: 56px; }
            .pagination .page-numbers { max-width: 60%; }
        }
    </style>
</head>
<body dir="rtl">
    <div class="container">
        <header>
            <h1>ğŸ›’ Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</h1>
            <p>Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Google</p>
        </header>

        <!-- TOP: minimized first frame on the left + banner on the right -->
        <div class="top-frames" role="region" aria-label="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¹Ù„ÙˆÙŠØ©">
            <!-- Minimized first frame -->
            <div class="carousel" id="carousel" aria-hidden="false">
                <div class="carousel-inner" id="carousel-inner"></div>
                <button class="carousel-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚" onclick="prevSlide()">â€¹</button>
                <button class="carousel-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ" onclick="nextSlide()">â€º</button>
            </div>

            <!-- Banner ticker (kept as is) -->
            <div class="banner-ticker" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù…ÙŠØ²Ø©">
                <div class="ticker-viewport" id="ticker-viewport" aria-live="polite">
                    <div class="ticker-track" id="ticker-track"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..." aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«">
            <div id="autocomplete-list" role="listbox" aria-label="Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø¨Ø­Ø«"></div>

            <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª">
                <option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
            </select>

            <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©">
                <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
            </select>

            <div id="price-range">
                <input type="number" id="min-price" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±">
                <input type="number" id="max-price" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±">
            </div>

            <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
                <option value="">ÙØ±Ø² Ø­Ø³Ø¨</option>
                <option value="discount-desc">Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø£ÙƒØ¨Ø± Ù„Ù„Ø£ØµØºØ±</option>
                <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰</option>
            </select>

            <input type="number" id="min-discount" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…">

            <div style="display:flex;gap:8px;">
                <button onclick="applyFilters()">ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
            </div>
        </div>

        <div class="stats" role="region" aria-label="Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">
            <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</h3><div class="value" id="total-offers">0</div></div>
            <div class="stat-card"><h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</h3><div class="value" id="avg-discount">0%</div></div>
            <div class="stat-card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</h3><div class="value" id="supermarket-count">0</div></div>
            <div class="stat-card"><h3>Ø§Ù„ÙØ¦Ø§Øª</h3><div class="value" id="category-count">0</div></div>
        </div>

        <div id="chart-container" aria-label="Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"><canvas id="stats-chart"></canvas></div>

        <div class="loading" id="loading" role="alert">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Google...</div>

        <div id="data-table" style="display: none;" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶">
            <table id="offers-table">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„ÙØ¦Ø©</th>
                        <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
                        <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</th>
                        <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                        <th>Ø§Ù„Ø®ØµÙ…</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</th>
                        <th>Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
                    </tr>
                </thead>
                <tbody id="table-body"><!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ --></tbody>
            </table>

            <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª">
                <!-- JS injects: First / Prev / page numbers (scrollable) / Next / Last -->
            </div>
        </div>
    </div>

    <script>
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
        const CACHE_KEY = 'offersData';
        const CACHE_EXPIRY = 3600000;

        const supermarketUrls = {
            "2B": "https://2b.com.eg/",
            "Ø§Ù„Ø±Ø§ÙŠØ©": "https://www.facebook.com/AlRayahMarketEg/",
            "Ø§Ù„Ø±Ø§ÙŠØ© Ù…Ø§Ø±ÙƒØª": "https://www.facebook.com/AlRayahMarketEg/",
            "Ø§Ù„Ø±Ø§ÙŠÙ‡ Ù…Ø§Ø±ÙƒØª": "https://www.facebook.com/AlRayahMarketEg/",
            "Al Rayah": "https://www.facebook.com/AlRayahMarketEg/",
            "Al Rayah Market": "https://www.facebook.com/AlRayahMarketEg/",
            "Raya Market": "https://www.facebook.com/AlRayahMarketEg/",
            "Alfa Market": "https://www.facebook.com/AlfaMarketeg//",
            "Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨": "https://awladragab.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø©": "https://beitelgomla.com/",
            "BIM": "https://www.bim.eg/",
            "Carrefour": "https://www.carrefouregypt.com/mafegy/ar",
            "Carrefour Market": "https://www.carrefouregypt.com/mafegy/ar",
            // ... other mappings kept as before
        };

        function parseEndDate(period) {
            if (!period) return null;
            const parts = String(period).split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).map(p => p.trim()).filter(Boolean);
            let candidate = parts.length > 1 ? parts[parts.length - 1] : parts[0];
            candidate = candidate.replace(/^(Ù…Ù†|Ø¥Ù„Ù‰|Ø­ØªÙ‰)\s*/i, '').trim();
            let d = new Date(candidate);
            if (!isValidDate(d)) {
                const dm = candidate.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/);
                if (dm) {
                    let day = dm[1].padStart(2, '0'), month = dm[2].padStart(2, '0'), year = dm[3];
                    if (year.length === 2) year = '20' + year;
                    d = new Date(`${year}-${month}-${day}`);
                    if (!isValidDate(d)) d = null;
                } else {
                    const ym = candidate.match(/(\d{4})[\/\.-](\d{1,2})[\/\.-](\d{1,2})/);
                    if (ym) {
                        d = new Date(`${ym[1]}-${ym[2].padStart(2,'0')}-${ym[3].padStart(2,'0')}`);
                        if (!isValidDate(d)) d = null;
                    } else d = null;
                }
            }
            return isValidDate(d) ? d : null;
        }
        function isValidDate(d) { return d instanceof Date && !isNaN(d.getTime()); }
        function isSameDate(a,b){ if(!isValidDate(a)||!isValidDate(b)) return false; return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
        function formatDateShort(d){ if(!isValidDate(d)) return 'ØºÙŠØ± Ù…ØªØ§Ø­'; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

        let allData = [], filteredData = [], currentPage = 1;
        const itemsPerPage = 20;
        let chart = null, carouselIndex = 0;

        function computeSavedAndDiscount(arr){
            // compute numeric saved and normalized discount percent for each item
            arr.forEach(item=>{
                const orig = Number(item.originalPrice) || 0;
                const curr = Number(item.currentPrice) || 0;
                let saved = 0;
                if(orig > 0 && curr > 0) saved = orig - curr;
                else if(orig > 0 && item.discount) saved = orig * (Number(item.discount)/100);
                else if(curr > 0 && item.discount) saved = curr * (Number(item.discount)/100);
                saved = Math.max(0, Number(saved.toFixed(2)));
                item._saved = saved;
                // normalized discount percentage
                item._discount_pct = (item.discount && !isNaN(item.discount)) ? Number(item.discount) : (orig>0 && curr>0 ? Math.round(((orig-curr)/orig)*100) : 0);
            });
        }

        function computeCombinedScore(arr){
            // normalize _saved and _discount_pct into 0..1 and compute score = max(norm_saved, norm_pct)
            const savedValues = arr.map(i=>i._saved||0);
            const pctValues = arr.map(i=>i._discount_pct||0);

            const maxSaved = Math.max(...savedValues, 0);
            const minSaved = Math.min(...savedValues, 0);
            const maxPct = Math.max(...pctValues, 0);
            const minPct = Math.min(...pctValues, 0);

            const savedRange = (maxSaved - minSaved) || 1;
            const pctRange = (maxPct - minPct) || 1;

            arr.forEach(item=>{
                const normSaved = ((item._saved||0) - minSaved) / savedRange;
                const normPct = ((item._discount_pct||0) - minPct) / pctRange;
                // score selects the stronger signal between absolute saving and percentage saving
                item._score = Math.max(normSaved, normPct);
            });
        }

        async function fetchData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Google...';
                const cached = localStorage.getItem(CACHE_KEY);
                const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
                if (cached && cachedTime && Date.now() - cachedTime < CACHE_EXPIRY) {
                    allData = JSON.parse(LZString.decompressFromUTF16(cached));
                } else {
                    const response = await fetch(DATA_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const dataText = await response.text();
                    const parsed = Papa.parse(dataText, { header:true, skipEmptyLines:true, trim:true, dynamicTyping:true });
                    const data = parsed.data;
                    allData = data.map(item => {
                        const rawPeriod = item['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || item['Validity Period'] || '';
                        const endDateObj = parseEndDate(String(rawPeriod));
                        const validUntilStr = endDateObj ? formatDateShort(endDateObj) : (String(rawPeriod).split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).slice(-1)[0] || 'ØºÙŠØ± Ù…ØªØ§Ø­');
                        return {
                            supermarket: item['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            product: item['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            primaryName: item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            category: item['Ø§Ù„ÙØ¦Ø©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            brand: item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            originalPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ']) || 0,
                            currentPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0,
                            discount: parseFloat(item['Ø§Ù„Ø®ØµÙ… %']) || 0,
                            promotion: item['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            rawPeriod, endDate: endDateObj, validUntil: validUntilStr,
                            currency: item['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP',
                            solution_key: (item['solution_key'] || item['solution key'] || item['Solution_key'] || item['solutionKey'] || '') 
                        };
                    });
                    try { localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData))); localStorage.setItem(`${CACHE_KEY}_time`, Date.now()); }
                    catch(e){ console.log('Caching failed', e); }
                }

                // compute saved & discount
                computeSavedAndDiscount(allData);
                // compute combined score that picks the stronger signal (amount or percent)
                computeCombinedScore(allData);

                // Sort by combined score desc, then by absolute saved, then by percent
                allData.sort((a,b)=>{
                    if((b._score||0) !== (a._score||0)) return (b._score||0) - (a._score||0);
                    if((b._saved||0) !== (a._saved||0)) return (b._saved||0) - (a._saved||0);
                    return (b._discount_pct||0) - (a._discount_pct||0);
                });

                initializeFilters();
                applyFilters(); // renders table + pagination + banner + carousel
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-table').style.display = 'block';
            } catch (err) {
                console.error(err);
                document.getElementById('loading').textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}`;
            }
        }

        // small left carousel (minimized width)
        function renderCarousel() {
            const inner = document.getElementById('carousel-inner');
            inner.innerHTML = '';
            // use sorted allData by _score so carousel shows best items first
            let candidates = [...allData].filter(i => (i._score && i._score > 0) || (i._saved && i._saved>0));
            const today = new Date();
            candidates.sort((a,b) => {
                const aToday = isSameDate(a.endDate, today) ? 1 : 0;
                const bToday = isSameDate(b.endDate, today) ? 1 : 0;
                if (aToday !== bToday) return bToday - aToday;
                // primary: _score (already sorted), ensure stable ordering
                if((b._score||0) !== (a._score||0)) return (b._score||0) - (a._score||0);
                if((b._saved||0) !== (a._saved||0)) return (b._saved||0) - (a._saved||0);
                return (b._discount_pct||0) - (a._discount_pct||0);
            });
            candidates = candidates.slice(0, 8);
            if (candidates.length === 0) {
                inner.innerHTML = `<div class="carousel-item"><div class="product-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹</div></div>`;
                return;
            }
            candidates.forEach(item=>{
                const div = document.createElement('div');
                div.className = 'carousel-item';
                div.innerHTML = `<span class="product-title">${item.product}</span><span class="meta">${item.supermarket} â€” ${item._discount_pct}%</span>`;
                const url = item.solution_key ? `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg` : (supermarketUrls[item.supermarket] || (item.supermarket && supermarketUrls[item.supermarket.trim()]));
                if(url) div.onclick = ()=>window.open(url,'_blank');
                inner.appendChild(div);
            });
            if (window._carouselInterval) clearInterval(window._carouselInterval);
            window._carouselInterval = setInterval(()=>{
                carouselIndex = (carouselIndex + 1) % Math.max(1, inner.children.length);
                inner.style.transform = `translateX(-${carouselIndex * 100}%)`;
            }, 3500);
        }

        // Choose banner items by combined score (top 20)
        function renderBanner() {
            const track = document.getElementById('ticker-track');
            if(!track) return;
            track.classList.remove('scrolling');
            track.style.animationDuration = '';
            const today = new Date();

            // pick top 20 by _score
            const items = [...allData].filter(i=>i.product).sort((a,b)=>{
                if((b._score||0)!==(a._score||0)) return (b._score||0)-(a._score||0);
                if((b._saved||0)!==(a._saved||0)) return (b._saved||0)-(a._saved||0);
                return (b._discount_pct||0)-(a._discount_pct||0);
            }).slice(0,20);

            if(items.length===0){ track.innerHTML = `<div class="ticker-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>`; return; }

            const parts = items.map(it=>{
                const url = it.solution_key ? `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(it.solution_key)}&c=eg` : (supermarketUrls[it.supermarket] || (it.supermarket && supermarketUrls[it.supermarket.trim()]) || '#');
                const priceText = (it.currentPrice && !isNaN(it.currentPrice) && it.currentPrice>0) ? `${Number(it.currentPrice).toFixed(2)} ${it.currency||'EGP'}` : 'ØºÙŠØ± Ù…ØªØ§Ø­';
                const savedText = (it._saved && !isNaN(it._saved) && it._saved > 0) ? `${Number(it._saved).toFixed(2)} ${it.currency||'EGP'}` : '';
                const badge = it._discount_pct ? `<span class="badge">${it._discount_pct}%</span>` : '';
                const savedBadge = savedText ? `<span class="saved">${savedText}</span>` : '';
                const title = `${it.product} â€” ${it.supermarket} â€” Ø§Ù„Ø¢Ù† ${priceText} â€” Ø®ØµÙ… ${it._discount_pct||0}% â€” ÙˆÙØ± ${savedText||'ØºÙŠØ± Ù…ØªØ§Ø­'}`;
                return `<div class="ticker-item"><a href="${url}" target="_blank" rel="noreferrer noopener" title="${title}"><span class="price">${priceText}</span> <span>${it.product} â€” ${it.supermarket}</span> ${badge}${savedBadge}</a></div>`;
            });

            track.innerHTML = parts.join('') + parts.join('');
            const duration = Math.min(35, Math.max(8, items.length * 0.9 + 10));
            track.style.animationDuration = `${duration}s`;
            setTimeout(()=>track.classList.add('scrolling'), 50);
        }

        // pagination, filters, table rendering unchanged except table already shows primaryName column
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));

            const firstBtn = document.createElement('button');
            firstBtn.className = 'control-btn';
            firstBtn.textContent = 'Ø§Ù„Ø£ÙˆÙ„Ù‰';
            firstBtn.disabled = currentPage === 1;
            firstBtn.onclick = ()=>{ if(currentPage!==1){ currentPage=1; renderTable(); updatePagination(); centerActivePageButton(); } };
            pagination.appendChild(firstBtn);

            const prevBtn = document.createElement('button');
            prevBtn.className = 'control-btn';
            prevBtn.textContent = 'Ø§Ù„Ø³Ø§Ø¨Ù‚';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = ()=>{ if(currentPage>1){ currentPage--; renderTable(); updatePagination(); centerActivePageButton(); } };
            pagination.appendChild(prevBtn);

            const pageNumbers = document.createElement('div');
            pageNumbers.className = 'page-numbers';
            pageNumbers.id = 'page-numbers';

            for(let i=1;i<=totalPages;i++){
                const btn = document.createElement('button');
                btn.textContent = i;
                if(i===currentPage) btn.classList.add('active');
                btn.onclick = ((p)=>()=>{ if(currentPage!==p){ currentPage=p; renderTable(); updatePagination(); centerActivePageButton(); } })(i);
                pageNumbers.appendChild(btn);
            }

            pagination.appendChild(pageNumbers);

            const nextBtn = document.createElement('button');
            nextBtn.className = 'control-btn';
            nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = ()=>{ if(currentPage<totalPages){ currentPage++; renderTable(); updatePagination(); centerActivePageButton(); } };
            pagination.appendChild(nextBtn);

            const lastBtn = document.createElement('button');
            lastBtn.className = 'control-btn';
            lastBtn.textContent = 'Ø§Ù„Ø£Ø®ÙŠØ±Ø©';
            lastBtn.disabled = currentPage === totalPages;
            lastBtn.onclick = ()=>{ if(currentPage!==totalPages){ currentPage=totalPages; renderTable(); updatePagination(); centerActivePageButton(); } };
            pagination.appendChild(lastBtn);

            setTimeout(centerActivePageButton, 80);
        }

        function centerActivePageButton(){
            const container = document.getElementById('page-numbers');
            if(!container) return;
            const active = container.querySelector('button.active');
            if(!active) return;
            const containerRect = container.getBoundingClientRect();
            const activeRect = active.getBoundingClientRect();
            const offset = (activeRect.left + activeRect.right)/2 - (containerRect.left + containerRect.right)/2;
            container.scrollBy({ left: offset, behavior: 'smooth' });
        }

        function initializeFilters(){
            const supermarketSelect = document.getElementById('supermarket-filter');
            supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
            const supermarkets = [...new Set(allData.map(i=>i.supermarket))].filter(Boolean);
            supermarkets.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; supermarketSelect.appendChild(o); });
            const categorySelect = document.getElementById('category-filter');
            categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
            const categories = [...new Set(allData.map(i=>i.category))].filter(Boolean);
            categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; categorySelect.appendChild(o); });

            document.getElementById('search-input').addEventListener('input', showAutocomplete);
            document.addEventListener('click', (e)=>{ const list=document.getElementById('autocomplete-list'); if(!e.target.closest('#autocomplete-list') && e.target.id!=='search-input') list.innerHTML=''; });
            document.getElementById('sort-by').addEventListener('change', applyFilters);
        }

        function showAutocomplete(){
            const val = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';
            if(!val) return;
            const suggestions = [...new Set(allData.map(i=>i.product).concat(allData.map(i=>i.brand)))].filter(s=>s && s.toLowerCase().includes(val)).slice(0,10);
            suggestions.forEach(s=>{ const div=document.createElement('div'); div.textContent=s; div.addEventListener('click',()=>{ document.getElementById('search-input').value=s; list.innerHTML=''; applyFilters(); }); list.appendChild(div); });
        }

        function applyFilters(){
            const search = document.getElementById('search-input').value.toLowerCase();
            const supermarket = document.getElementById('supermarket-filter').value;
            const category = document.getElementById('category-filter').value;
            const minDiscount = parseFloat(document.getElementById('min-discount').value) || 0;
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
            const sort = document.getElementById('sort-by').value;

            filteredData = allData.filter(item=>{
                const matchesSearch = !search || (item.product && item.product.toLowerCase().includes(search)) || (item.brand && item.brand.toLowerCase().includes(search));
                const matchesSupermarket = !supermarket || item.supermarket === supermarket;
                const matchesCategory = !category || item.category === category;
                const matchesDiscount = item._discount_pct >= minDiscount;
                const matchesPrice = item.currentPrice >= minPrice && item.currentPrice <= maxPrice;
                return matchesSearch && matchesSupermarket && matchesCategory && matchesDiscount && matchesPrice;
            });

            // Respect user sort selection. If user didn't select a sort, keep pre-sorted by _score.
            if(sort==='discount-desc') filteredData.sort((a,b)=>b._discount_pct-a._discount_pct);
            else if(sort==='price-asc') filteredData.sort((a,b)=>a.currentPrice-b.currentPrice);

            currentPage = 1;
            renderTable();
            updateStats();
            updatePagination();
            renderBanner();
            renderCarousel();
        }

        function resetFilters(){
            document.getElementById('search-input').value='';
            document.getElementById('supermarket-filter').value='';
            document.getElementById('category-filter').value='';
            document.getElementById('min-discount').value='';
            document.getElementById('min-price').value='';
            document.getElementById('max-price').value='';
            document.getElementById('sort-by').value='';
            applyFilters();
        }

        function renderTable(){
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            const start = (currentPage-1)*itemsPerPage;
            const pageData = filteredData.slice(start, start+itemsPerPage);
            pageData.forEach(item=>{
                const tr = document.createElement('tr');
                const url = item.solution_key ? `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg` : (supermarketUrls[item.supermarket] || (item.supermarket && supermarketUrls[item.supermarket.trim()]));
                if(url){ tr.style.cursor='pointer'; tr.title=`Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶`; tr.onclick = ()=>window.open(url,'_blank'); }
                tr.innerHTML = `
                    <td>${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.originalPrice ? item.originalPrice + ' ' + item.currency : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.currentPrice ? item.currentPrice + ' ' + item.currency : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item._discount_pct ? `<span class="discount-badge">${item._discount_pct}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.primaryName || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.validUntil || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                `;
                if(item._discount_pct && item._discount_pct>20) tr.classList.add('highlight');
                tbody.appendChild(tr);
            });
        }

        function updateStats(){
            document.getElementById('total-offers').textContent = filteredData.length;
            const discounts = filteredData.filter(i=>i._discount_pct).map(i=>i._discount_pct);
            const avgDiscount = discounts.length>0 ? Math.round(discounts.reduce((a,b)=>a+b)/discounts.length) : 0;
            document.getElementById('avg-discount').textContent = `${avgDiscount}%`;
            const supermarkets = [...new Set(filteredData.map(i=>i.supermarket).filter(Boolean))];
            document.getElementById('supermarket-count').textContent = supermarkets.length;
            const categories = [...new Set(filteredData.map(i=>i.category).filter(Boolean))];
            document.getElementById('category-count').textContent = categories.length;
        }

        function toggleChart(){
            const container = document.getElementById('chart-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            if(chart) chart.destroy();
            const ctx = document.getElementById('stats-chart').getContext('2d');
            const discountRanges = {'0-10%':0,'11-20%':0,'21-30%':0,'30+%':0};
            filteredData.forEach(i=>{
                if(i._discount_pct<=10) discountRanges['0-10%']++;
                else if(i._discount_pct<=20) discountRanges['11-20%']++;
                else if(i._discount_pct<=30) discountRanges['21-30%']++;
                else discountRanges['30+%']++;
            });
            chart = new Chart(ctx, { type:'pie', data:{ labels: Object.keys(discountRanges), datasets:[{ data: Object.values(discountRanges), backgroundColor:['#ff6384','#36a2eb','#ffce56','#4bc0c0'] }] }, options:{ responsive:true } });
        }

        function exportToCSV(){
            const headers = ['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª','Ø§Ù„Ù…Ù†ØªØ¬','Ø§Ù„ÙØ¦Ø©','Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ','Ø§Ù„Ø®ØµÙ…','Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)','Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰'];
            const csvData = [ headers.join(','), ...filteredData.map(item=>[
                item.supermarket,
                `"${(item.product||'').replace(/"/g,'""')}"`,
                item.category,
                item.brand,
                item.originalPrice,
                item.currentPrice,
                item._discount_pct,
                `"${(item.primaryName||'').replace(/"/g,'""')}"`,
                item.validUntil
            ].join(',')) ].join('\n');
            const blob = new Blob([csvData], { type:'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'supermarket_offers.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function prevSlide(){
            const inner = document.getElementById('carousel-inner');
            if(!inner) return;
            carouselIndex = (carouselIndex - 1 + inner.children.length) % Math.max(1, inner.children.length);
            inner.style.transform = `translateX(-${carouselIndex * 100}%)`;
        }
        function nextSlide(){
            const inner = document.getElementById('carousel-inner');
            if(!inner) return;
            carouselIndex = (carouselIndex + 1) % Math.max(1, inner.children.length);
            inner.style.transform = `translateX(-${carouselIndex * 100}%)`;
        }

        document.addEventListener('DOMContentLoaded', fetchData);
        document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ renderBanner(); renderCarousel(); } });
    </script>
</body>
</html>