<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª â€” Ù…Ø­Ø³Ù† Ù„Ù„Ù‡ÙˆØ§ØªÙ</title>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <style>
    /* ----------------------------------------
       CSS variables / theme
       ---------------------------------------- */
    :root{
      --bg-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --card-bg: #ffffff;
      --muted: #666;
      --accent: #4caf50;
      --danger: #ff4444;
      --glass: rgba(255,255,255,0.95);
      --gap: 12px;
      --radius: 12px;
      --text: #222;
      --max-width: 1200px;
      --control-height: 46px;
      --touch-size: 48px;
      --shadow: 0 8px 20px rgba(0,0,0,0.12);
      --small: 13px;
      --base-font: 15px;
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .ticker-track.scrolling { animation: none !important; }
      .carousel-inner { transition: none !important; }
    }

    /* Global reset */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-1);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-size:var(--base-font);
      line-height:1.35;
      padding:env(safe-area-inset-top) 16px 32px;
    }

    .container{
      max-width:var(--max-width);
      margin: 0 auto;
    }

    header{
      background: var(--glass);
      border-radius: var(--radius);
      padding: 12px 14px;
      box-shadow: var(--shadow);
      text-align:center;
      margin-bottom: var(--gap);
    }
    header h1{font-size:18px;margin-bottom:4px}
    header p{font-size:13px;color:var(--muted);margin:0}

    /* top frames */
    .top-frames{
      display:flex;
      gap:var(--gap);
      align-items:center;
      margin-bottom:var(--gap);
    }

    /* carousel (left small) */
    .carousel{
      width:220px;
      min-width:140px;
      height:56px;
      background:var(--card-bg);
      border-radius:10px;
      box-shadow:0 6px 14px rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      padding:6px;
      direction:rtl;
      position:relative;
      overflow:hidden;
    }
    .carousel-inner{ display:flex; transition:transform .35s ease; width:100%; align-items:center; height:100%;}
    .carousel-item{ min-width:100%; display:flex; align-items:center; gap:8px; padding:0 6px; font-size:13px; white-space:nowrap; overflow:hidden;}
    .carousel-item .product-title{ font-weight:600; color:#111}
    .carousel-prev, .carousel-next{
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,0.12); color:#fff; border:none;
      width:36px;height:36px;border-radius:8px; display:flex;align-items:center;justify-content:center;
      -webkit-tap-highlight-color: transparent;
    }
    .carousel-prev{ left:6px } .carousel-next{ right:6px }

    /* banner ticker */
    .banner-ticker{
      flex:1;
      height:64px;
      background:var(--card-bg);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,0.12);
      display:flex;
      align-items:center;
      padding:6px 8px;
      direction:ltr; /* needed for ticker animation */
    }
    .ticker-viewport{ width:100%; overflow:hidden }
    .ticker-track{ display:flex; gap:28px; align-items:center; padding:0 12px; will-change:transform; }
    .ticker-item{ display:inline-flex; align-items:center; gap:8px; font-size:14px; color:#111; white-space:nowrap; }
    .ticker-item a{ color:inherit; text-decoration:none; display:inline-flex; gap:8px; align-items:center; padding:8px; border-radius:8px;}
    .ticker-item .badge{ background:var(--danger); color:white; padding:4px 8px; border-radius:6px; font-weight:700 }
    .ticker-item .price{ font-weight:700; color:#0b66a3 }

    @keyframes scroll-left{ 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
    .ticker-track.scrolling{ animation-name:scroll-left; animation-timing-function:linear; animation-iteration-count:infinite }

    /* controls */
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin:12px 0;
    }
    .controls .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    select,input,button{ height:var(--control-height); padding:0 12px; border-radius:10px; border:2px solid #eee; background:white; font-size:15px; }
    select:focus,input:focus,button:focus{ outline:3px solid rgba(76,175,80,0.12) }
    .controls input#search-input{ direction:rtl; min-width:160px; max-width:320px; width:36vw; }
    .controls .actions{ display:flex; gap:8px }

    /* stats cards */
    .stats{ display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
    .stat-card{ background:var(--card-bg); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); min-width:130px; flex:1; }
    .stat-card h3{ font-size:13px; margin-bottom:8px; color:var(--muted) }
    .stat-card .value{ font-size:18px; font-weight:700; color:#333 }

    /* table & cards */
    #data-table{ background:var(--card-bg); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.12); overflow:hidden; margin-top:16px; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{ background:var(--accent); color:white; padding:12px; text-align:left; position:sticky; top:0; font-weight:600; font-size:13px; }
    tbody td{ padding:10px 12px; border-bottom:1px solid #f0f0f0; vertical-align:middle }
    tbody tr:hover{ background:#f7fff7; cursor:pointer }

    /* mobile-friendly card list (shown on small screens instead of table) */
    .card-list{ display:none; gap:12px; padding:12px; }
    .offer-card{
      display:flex; gap:12px; align-items:flex-start; background:linear-gradient(180deg,#fff,#fbfbfb);
      padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .offer-card .left{ flex:1; }
    .offer-card h4{ margin:0 0 6px 0; font-size:15px }
    .offer-meta{ font-size:13px; color:var(--muted) }
    .offer-price{ font-weight:700; color:#0b66a3 }
    .offer-saved{ background:#ffd54d; color:#333; padding:4px 8px; border-radius:6px; font-weight:700; margin-left:8px; }

    /* pagination */
    .pagination{ display:flex; gap:8px; align-items:center; justify-content:center; padding:10px; background:var(--glass); border-radius:10px; margin:12px 0 }
    .pagination button{ min-width:48px; height:40px; border-radius:8px; border:1px solid #ddd; background:white; }

    /* utilities */
    .hidden{ display:none !important }

    /* ----------------------------------------
       Responsive rules (mobile first)
       ---------------------------------------- */
    @media (max-width:900px){
      :root{ --max-width:1000px; --control-height:44px; }
      .top-frames{ flex-direction:column; align-items:stretch }
      .carousel{ width:100%; height:56px; min-width:unset }
      .banner-ticker{ height:56px; margin-top:6px }
      .controls{ justify-content:flex-start }
      .controls .actions{ width:100%; justify-content:flex-start }
      .stats{ gap:10px }
      /* show cards instead of table */
      table{ display:none }
      .card-list{ display:flex; flex-direction:column; padding:12px }
      #data-table{ padding:0 }
      .carousel-prev, .carousel-next{ width:40px;height:40px }
      .controls input#search-input{ width:100% }
      .ticker-item a{ padding:10px 12px; border-radius:8px }
      .carousel-item { font-size:14px }
      .pagination{ padding:6px }
      body{ padding-top:12px }
    }

    @media (min-width:901px){
      .card-list{ display:none }
      table{ display:table }
    }
  </style>
</head>
<body dir="rtl">
  <div class="container">
    <header>
      <h1>ğŸ›’ Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</h1>
      <p>Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ â€” Ù…ÙØ­Ø³Ù‘Ù† Ù„Ù„Ù‡ÙˆØ§ØªÙ ÙˆØ§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</p>
    </header>

    <!-- TOP -->
    <div class="top-frames" role="region" aria-label="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¹Ù„ÙˆÙŠØ©">
      <div class="carousel" id="carousel" aria-hidden="false">
        <div class="carousel-inner" id="carousel-inner" aria-live="polite"></div>
        <button class="carousel-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚" id="carousel-prev">â€¹</button>
        <button class="carousel-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ" id="carousel-next">â€º</button>
      </div>

      <div class="banner-ticker" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù…ÙŠØ²Ø©">
        <div class="ticker-viewport" id="ticker-viewport" aria-live="polite">
          <div class="ticker-track" id="ticker-track"></div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls" role="region" aria-label="Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…">
      <div class="row">
        <input id="search-input" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..." aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«" />
        <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª"><option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option></select>
        <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
      </div>

      <div class="row">
        <input id="min-price" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" />
        <input id="max-price" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" />
        <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
          <option value="">ÙØ±Ø² Ø­Ø³Ø¨</option>
          <option value="discount-desc">Ø§Ù„Ø®ØµÙ… % - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
          <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± - ØªØµØ§Ø¹Ø¯ÙŠ</option>
        </select>
        <input id="min-discount" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…" />
      </div>

      <div class="actions row">
        <button onclick="applyFilters()" aria-label="ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±">ğŸ” ØªØ·Ø¨ÙŠÙ‚</button>
        <button onclick="resetFilters()" aria-label="Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        <button onclick="exportToCSV()" aria-label="ØªØµØ¯ÙŠØ± CSV">ğŸ“¥ CSV</button>
        <button onclick="toggleChart()" aria-label="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø·Ø·">ğŸ“Š</button>
      </div>
    </div>

    <!-- stats -->
    <div class="stats" role="region" aria-label="Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">
      <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</h3><div class="value" id="total-offers">0</div></div>
      <div class="stat-card"><h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</h3><div class="value" id="avg-discount">0%</div></div>
      <div class="stat-card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</h3><div class="value" id="supermarket-count">0</div></div>
      <div class="stat-card"><h3>Ø§Ù„ÙØ¦Ø§Øª</h3><div class="value" id="category-count">0</div></div>
    </div>

    <!-- chart -->
    <div id="chart-container" style="display:none" aria-label="Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"><canvas id="stats-chart"></canvas></div>

    <div id="loading" class="loading" role="status" style="text-align:center;padding:18px;color:#fff">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <!-- DATA TABLE (desktop) + CARD LIST (mobile) -->
    <div id="data-table" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶">
      <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶">
        <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„ÙØ¦Ø©</th>
            <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
            <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</th>
            <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
            <th>Ø§Ù„Ø®ØµÙ…</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</th>
            <th>Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>

      <!-- mobile cards -->
      <div class="card-list" id="card-list" aria-hidden="true"></div>

      <!-- pagination -->
      <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª"></div>
    </div>
  </div>

  <script>
  /* ===============================
     App script (modernized + mobile)
     - Keeps previous behaviour and sorting:
       compute _saved and _discount_pct, compute combined _score,
       sort by _score desc (tie-breakers)
     - Renders table on desktop and card list on mobile
     - Improves touch targets and responsiveness
     =============================== */

  const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
  const CACHE_KEY = 'offersData';
  const CACHE_EXPIRY = 3600000;

  const supermarketUrls = {
    "2B": "https://2b.com.eg/",
    "Ø§Ù„Ø±Ø§ÙŠØ©": "https://www.facebook.com/AlRayahMarketEg/",
    "Ø§Ù„Ø±Ø§ÙŠØ© Ù…Ø§Ø±ÙƒØª": "https://www.facebook.com/AlRayahMarketEg/",
    "Ø§Ù„Ø±Ø§ÙŠÙ‡ Ù…Ø§Ø±ÙƒØª": "https://www.facebook.com/AlRayahMarketEg/",
    "Al Rayah": "https://www.facebook.com/AlRayahMarketEg/",
    "Al Rayah Market": "https://www.facebook.com/AlRayahMarketEg/",
    "Raya Market": "https://www.facebook.com/AlRayahMarketEg/",
    "Alfa Market": "https://www.facebook.com/AlfaMarketeg//",
    "Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨": "https://awladragab.com/",
    "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø©": "https://beitelgomla.com/",
    "BIM": "https://www.bim.eg/",
    "Carrefour": "https://www.carrefouregypt.com/mafegy/ar",
    "Carrefour Market": "https://www.carrefouregypt.com/mafegy/ar"
  };

  // state
  let allData = [], filteredData = [], currentPage = 1;
  const itemsPerPage = 20;
  let carouselIndex = 0, carouselInterval = null;

  // helpers
  function parseEndDate(period){
    if (!period) return null;
    const s = String(period);
    const parts = s.split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).map(p=>p.trim()).filter(Boolean);
    let candidate = parts.length>1 ? parts[parts.length-1] : parts[0];
    candidate = candidate.replace(/^(Ù…Ù†|Ø¥Ù„Ù‰|Ø­ØªÙ‰)\s*/i,'').trim();
    let d = new Date(candidate);
    if (isNaN(d)) {
      const dm = candidate.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/);
      if (dm){
        let day=dm[1].padStart(2,'0'), month=dm[2].padStart(2,'0'), year=dm[3];
        if (year.length===2) year='20'+year;
        d = new Date(`${year}-${month}-${day}`);
      } else {
        const ym = candidate.match(/(\d{4})[\/\.-](\d{1,2})[\/\.-](\d{1,2})/);
        if (ym) d = new Date(`${ym[1]}-${ym[2].padStart(2,'0')}-${ym[3].padStart(2,'0')}`);
      }
    }
    return (d instanceof Date && !isNaN(d.getTime())) ? d : null;
  }

  function isValidDate(d){ return d instanceof Date && !isNaN(d.getTime()); }
  function formatDateShort(d){ if(!isValidDate(d)) return 'ØºÙŠØ± Ù…ØªØ§Ø­'; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  // compute saved and discount percent
  function computeSavedAndDiscount(arr){
    arr.forEach(item=>{
      const orig = Number(item.originalPrice) || 0;
      const curr = Number(item.currentPrice) || 0;
      let saved = 0;
      if (orig>0 && curr>0) saved = orig - curr;
      else if (orig>0 && item.discount) saved = orig * (Number(item.discount)/100);
      else if (curr>0 && item.discount) saved = curr * (Number(item.discount)/100);
      item._saved = Math.max(0, Number((saved||0).toFixed(2)));
      item._discount_pct = (item.discount && !isNaN(item.discount)) ? Number(item.discount) : (orig>0 && curr>0 ? Math.round(((orig-curr)/orig)*100) : 0);
    });
  }

  // normalize and compute combined score: choose stronger signal (percent vs value)
  function computeCombinedScore(arr){
    if(!arr || !arr.length) return;
    const savedVals = arr.map(i=>i._saved||0), pctVals = arr.map(i=>i._discount_pct||0);
    const maxSaved = Math.max(...savedVals,0), minSaved = Math.min(...savedVals,0);
    const maxPct = Math.max(...pctVals,0), minPct = Math.min(...pctVals,0);
    const savedRange = (maxSaved - minSaved) || 1;
    const pctRange = (maxPct - minPct) || 1;
    arr.forEach(item=>{
      const ns = ((item._saved||0)-minSaved)/savedRange;
      const np = ((item._discount_pct||0)-minPct)/pctRange;
      item._score = Math.max(ns, np);
    });
  }

  // generate flyer URL (fallback to supermarket url)
  function flyerFor(item){
    if(item.solution_key) return `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg`;
    return supermarketUrls[item.supermarket] || '#';
  }

  /* ---------------------------
     Rendering
     - table (desktop)
     - card list (mobile)
     --------------------------- */
  function renderTable(){
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    const start = (currentPage-1)*itemsPerPage;
    const pageData = filteredData.slice(start, start+itemsPerPage);
    pageData.forEach(item=>{
      const tr = document.createElement('tr');
      const url = flyerFor(item);
      if(url && url!=='#'){ tr.style.cursor='pointer'; tr.title='Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶'; tr.onclick = ()=>window.open(url, '_blank'); }
      tr.innerHTML = `
        <td>${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item.originalPrice ? item.originalPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item._discount_pct ? `<span class="discount-badge">${item._discount_pct}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item.primaryName || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        <td>${item.validUntil || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      `;
      if(item._discount_pct && item._discount_pct>20) tr.classList.add('highlight');
      tbody.appendChild(tr);
    });
    renderCardList(); // keep both in sync
  }

  function renderCardList(){
    const list = document.getElementById('card-list');
    list.innerHTML = '';
    const start = (currentPage-1)*itemsPerPage;
    const pageData = filteredData.slice(start, start+itemsPerPage);
    pageData.forEach(item=>{
      const card = document.createElement('article');
      card.className = 'offer-card';
      const url = flyerFor(item);
      card.innerHTML = `
        <div class="left">
          <h4>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</h4>
          <div class="offer-meta">${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'} â€” ${item.category || ''}</div>
          <div style="margin-top:8px">
            <span class="offer-price">${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</span>
            ${item._saved ? `<span class="offer-saved">ÙˆÙØ± ${item._saved} ${item.currency||'EGP'}</span>` : ''}
            ${item._discount_pct ? `<span style="margin-left:8px" class="discount-badge">${item._discount_pct}%</span>` : ''}
          </div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">${item.primaryName || ''}</div>
        </div>
      `;
      if(url && url!=='#') card.addEventListener('click', ()=> window.open(url, '_blank'));
      card.addEventListener('touchstart', ()=>{}); // make clickable on mobile quickly
      list.appendChild(card);
    });
  }

  // Pagination UI
  function updatePagination(){
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
    const btn = (text, disabled, onClick) => {
      const b = document.createElement('button');
      b.textContent = text;
      b.disabled = !!disabled;
      b.addEventListener('click', onClick);
      return b;
    };
    pagination.appendChild(btn('Ø§Ù„Ø£ÙˆÙ„Ù‰', currentPage===1, ()=>{ currentPage=1; renderTable(); updatePagination(); }));
    pagination.appendChild(btn('Ø§Ù„Ø³Ø§Ø¨Ù‚', currentPage===1, ()=>{ if(currentPage>1){ currentPage--; renderTable(); updatePagination(); }}));

    // simple page numbers (mobile scrollable)
    const pageNumbers = document.createElement('div');
    pageNumbers.style.display='flex'; pageNumbers.style.gap='6px'; pageNumbers.style.overflowX='auto';
    for(let i=1;i<=totalPages;i++){
      const p = document.createElement('button');
      p.textContent = i;
      if(i===currentPage) p.style.background= 'var(--accent)', p.style.color='white';
      p.addEventListener('click', ()=>{ currentPage=i; renderTable(); updatePagination(); });
      pageNumbers.appendChild(p);
    }
    pagination.appendChild(pageNumbers);
    pagination.appendChild(btn('Ø§Ù„ØªØ§Ù„ÙŠ', currentPage===totalPages, ()=>{ if(currentPage<totalPages){ currentPage++; renderTable(); updatePagination(); }}));
    pagination.appendChild(btn('Ø§Ù„Ø£Ø®ÙŠØ±Ø©', currentPage===totalPages, ()=>{ currentPage=totalPages; renderTable(); updatePagination(); }));
  }

  // Stats
  function updateStats(){
    document.getElementById('total-offers').textContent = filteredData.length;
    const discounts = filteredData.filter(i=>i._discount_pct).map(i=>i._discount_pct);
    const avgDiscount = discounts.length ? Math.round(discounts.reduce((a,b)=>a+b,0)/discounts.length) : 0;
    document.getElementById('avg-discount').textContent = `${avgDiscount}%`;
    document.getElementById('supermarket-count').textContent = [...new Set(filteredData.map(i=>i.supermarket).filter(Boolean))].length;
    document.getElementById('category-count').textContent = [...new Set(filteredData.map(i=>i.category).filter(Boolean))].length;
  }

  // Banner & carousel (lightweight; uses CSS animation for ticker)
  function renderCarousel(){
    const inner = document.getElementById('carousel-inner');
    inner.innerHTML = '';
    const candidates = [...allData].filter(i=> (i._score && i._score>0) || (i._saved && i._saved>0)).slice(0,8);
    if(!candidates.length){ inner.innerHTML = `<div class="carousel-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹</div>`; return; }
    candidates.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'carousel-item';
      div.innerHTML = `<span class="product-title">${it.product}</span><span class="meta">${it.supermarket} â€” ${it._discount_pct}%</span>`;
      const url = flyerFor(it);
      if(url && url!=='#') div.addEventListener('click', ()=> window.open(url,'_blank'));
      inner.appendChild(div);
    });
    // start autoplay
    if(carouselInterval) clearInterval(carouselInterval);
    carouselIndex = 0;
    carouselInterval = setInterval(()=>{
      if(!inner.children.length) return;
      carouselIndex = (carouselIndex+1) % inner.children.length;
      inner.style.transform = `translateX(-${carouselIndex*100}%)`;
    }, 3500);
  }

  function renderBanner(){
    const track = document.getElementById('ticker-track');
    track.classList.remove('scrolling');
    track.style.animationDuration = '';
    const items = [...allData].filter(i=>i.product).slice(0,20);
    if(!items.length){ track.innerHTML = `<div class="ticker-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>`; return; }
    const parts = items.map(it=>{
      const url = flyerFor(it);
      const priceText = it.currentPrice ? `${Number(it.currentPrice).toFixed(2)} ${it.currency||'EGP'}` : 'ØºÙŠØ± Ù…ØªØ§Ø­';
      const savedText = it._saved ? `${it._saved} ${it.currency||'EGP'}` : '';
      const badge = it._discount_pct ? `<span class="badge">${it._discount_pct}%</span>` : '';
      return `<div class="ticker-item"><a href="${url}" target="_blank" rel="noreferrer noopener"><span class="price">${priceText}</span><span>${it.product}</span>${badge}${savedText?`<span class="saved">${savedText}</span>`:''}</a></div>`;
    });
    track.innerHTML = parts.join('') + parts.join('');
    const duration = Math.min(40, Math.max(10, items.length * 0.9 + 8));
    track.style.animationDuration = `${duration}s`;
    setTimeout(()=>track.classList.add('scrolling'), 50);
  }

  // Filters & apply
  function applyFilters(){
    const search = document.getElementById('search-input').value.toLowerCase();
    const supermarket = document.getElementById('supermarket-filter').value;
    const category = document.getElementById('category-filter').value;
    const minDiscount = parseFloat(document.getElementById('min-discount').value) || 0;
    const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
    const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
    const sort = document.getElementById('sort-by').value;

    filteredData = allData.filter(item=>{
      const ms = !search || (item.product && item.product.toLowerCase().includes(search)) || (item.primaryName && item.primaryName.toLowerCase().includes(search)) || (item.brand && item.brand.toLowerCase().includes(search));
      const msp = !supermarket || item.supermarket === supermarket;
      const mc = !category || item.category === category;
      const md = (item._discount_pct||0) >= minDiscount;
      const mp = (item.currentPrice||0) >= minPrice && (item.currentPrice||0) <= maxPrice;
      return ms && msp && mc && md && mp;
    });

    // if user selected a sort, apply it; otherwise keep pre-sorted by _score
    if(sort==='discount-desc') filteredData.sort((a,b)=> (b._discount_pct||0)-(a._discount_pct||0));
    else if(sort==='price-asc') filteredData.sort((a,b)=> (a.currentPrice||0)-(b.currentPrice||0));

    currentPage = 1;
    renderTable();
    updateStats();
    updatePagination();
    renderBanner();
    renderCarousel();
  }

  function resetFilters(){
    document.getElementById('search-input').value='';
    document.getElementById('supermarket-filter').value='';
    document.getElementById('category-filter').value='';
    document.getElementById('min-discount').value='';
    document.getElementById('min-price').value='';
    document.getElementById('max-price').value='';
    document.getElementById('sort-by').value='';
    applyFilters();
  }

  function exportToCSV(){
    const headers = ['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª','Ø§Ù„Ù…Ù†ØªØ¬','Ø§Ù„ÙØ¦Ø©','Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ','Ø§Ù„Ø®ØµÙ…%','Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)','Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰'];
    const rows = filteredData.map(it => [
      it.supermarket || '',
      `"${(it.product||'').replace(/"/g,'""')}"`,
      it.category || '',
      it.brand || '',
      it.originalPrice || '',
      it.currentPrice || '',
      it._discount_pct || '',
      `"${(it.primaryName||'').replace(/"/g,'""')}"`,
      it.validUntil || ''
    ].join(','));
    const csvData = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvData], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'supermarket_offers.csv'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // chart toggle
  let chart = null;
  function toggleChart(){
    const cont = document.getElementById('chart-container');
    cont.style.display = cont.style.display === 'none' ? 'block' : 'none';
    if(chart) chart.destroy();
    const ctx = document.getElementById('stats-chart').getContext('2d');
    const buckets = {'0-10%':0,'11-20%':0,'21-30%':0,'30+%':0};
    filteredData.forEach(i=>{
      if(i._discount_pct<=10) buckets['0-10%']++;
      else if(i._discount_pct<=20) buckets['11-20%']++;
      else if(i._discount_pct<=30) buckets['21-30%']++;
      else buckets['30+%']++;
    });
    chart = new Chart(ctx, {
      type:'pie',
      data:{ labels: Object.keys(buckets), datasets:[{ data:Object.values(buckets), backgroundColor:['#ff6384','#36a2eb','#ffce56','#4bc0c0'] }]},
      options:{ responsive:true, maintainAspectRatio:false }
    });
  }

  // initialization & data fetch
  async function fetchData(){
    try{
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loading').textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

      const cached = localStorage.getItem(CACHE_KEY);
      const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
      if(cached && cachedTime && (Date.now() - cachedTime) < CACHE_EXPIRY){
        try{
          allData = JSON.parse(LZString.decompressFromUTF16(cached));
        }catch(e){
          console.warn('cache parse failed', e); allData = [];
        }
      }

      if(!allData || !allData.length){
        const res = await fetch(DATA_URL);
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const txt = await res.text();
        const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true, trim:true, dynamicTyping:true });
        allData = parsed.data.map(item=>{
          const raw = item['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || item['Validity Period'] || '';
          const end = parseEndDate(String(raw));
          const validUntilStr = end ? formatDateShort(end) : (String(raw).split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).slice(-1)[0]||'ØºÙŠØ± Ù…ØªØ§Ø­');
          return {
            supermarket: item['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
            product: item['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
            primaryName: item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || '',
            category: item['Ø§Ù„ÙØ¦Ø©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
            brand: item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
            originalPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ']) || 0,
            currentPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0,
            discount: parseFloat(item['Ø§Ù„Ø®ØµÙ… %']) || 0,
            promotion: item['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || '',
            rawPeriod: raw, endDate: end, validUntil: validUntilStr,
            currency: item['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP',
            solution_key: (item['solution_key']||item['solution key']||item['Solution_key']||item['solutionKey']||'')
          };
        });

        try{ localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData))); localStorage.setItem(`${CACHE_KEY}_time`, Date.now()); }catch(e){ console.warn('cache save failed', e); }
      }

      // compute and sort by combined criteria
      computeSavedAndDiscount(allData);
      computeCombinedScore(allData);
      allData.sort((a,b)=>{
        if((b._score||0)!==(a._score||0)) return (b._score||0)-(a._score||0);
        if((b._saved||0)!==(a._saved||0)) return (b._saved||0)-(a._saved||0);
        return (b._discount_pct||0)-(a._discount_pct||0);
      });

      // init filters and render
      initializeFilters();
      applyFilters();

      document.getElementById('loading').style.display = 'none';
      document.getElementById('data-table').style.display = 'block';
    }catch(err){
      console.error(err);
      document.getElementById('loading').textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}`;
    }
  }

  // initialize filters dropdowns and search/autocomplete
  function initializeFilters(){
    const supermarketSelect = document.getElementById('supermarket-filter');
    supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
    const supermarkets = [...new Set(allData.map(i=>i.supermarket))].filter(Boolean);
    supermarkets.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; supermarketSelect.appendChild(o); });

    const categorySelect = document.getElementById('category-filter');
    categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
    const categories = [...new Set(allData.map(i=>i.category))].filter(Boolean);
    categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; categorySelect.appendChild(o); });

    const search = document.getElementById('search-input');
    search.addEventListener('input', showAutocomplete);
    document.addEventListener('click', (e)=>{ const list = document.getElementById('autocomplete-list'); if(list) list.innerHTML=''; });
    document.getElementById('sort-by').addEventListener('change', applyFilters);

    // setup carousel controls
    document.getElementById('carousel-prev').addEventListener('click', ()=>{ const inner=document.getElementById('carousel-inner'); if(!inner) return; carouselIndex=(carouselIndex-1+inner.children.length)%Math.max(1,inner.children.length); inner.style.transform=`translateX(-${carouselIndex*100}%)`; });
    document.getElementById('carousel-next').addEventListener('click', ()=>{ const inner=document.getElementById('carousel-inner'); if(!inner) return; carouselIndex=(carouselIndex+1)%Math.max(1,inner.children.length); inner.style.transform=`translateX(-${carouselIndex*100}%)`; });
  }

  function showAutocomplete(){
    // minimal inline autocomplete (keeps small and mobile friendly)
    const val = document.getElementById('search-input').value.toLowerCase();
    let list = document.getElementById('autocomplete-list');
    if(!list){
      list = document.createElement('div'); list.id='autocomplete-list';
      list.style.position='absolute'; list.style.zIndex=9999; list.style.background='white'; list.style.borderRadius='8px'; list.style.boxShadow='0 6px 18px rgba(0,0,0,0.12)'; list.style.marginTop='6px';
      document.body.appendChild(list);
    }
    list.innerHTML='';
    if(!val) return;
    const suggestions = [...new Set(allData.map(i=>i.product).concat(allData.map(i=>i.primaryName||'')))]
                        .filter(s=>s && s.toLowerCase().includes(val)).slice(0,8);
    suggestions.forEach(s=>{
      const d = document.createElement('div');
      d.textContent = s; d.style.padding='8px 10px'; d.style.cursor='pointer';
      d.addEventListener('click', ()=>{ document.getElementById('search-input').value = s; list.innerHTML=''; applyFilters(); });
      list.appendChild(d);
    });
    // position under input
    const rect = document.getElementById('search-input').getBoundingClientRect();
    list.style.left = `${rect.left}px`;
    list.style.top = `${rect.bottom + window.scrollY}px`;
    list.style.minWidth = `${rect.width}px`;
  }

  // initial DOM ready
  document.addEventListener('DOMContentLoaded', fetchData);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ renderBanner(); renderCarousel(); } });

  </script>
</body>
</html>