<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (styles unchanged for brevity - kept the same as before) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }
        header { text-align:center; margin-bottom:30px; padding:20px; background: rgba(255,255,255,0.9); border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        h1 { color:#333; margin-bottom:10px; }
        .invite-card { position: fixed; top: 24px; right: 24px; z-index:1200; background: rgba(255,255,255,0.95); border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.2); padding:12px; display:flex; align-items:center; gap:8px; direction:rtl; }
        .invite-btn { background:#ff7a00; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:bold; }
        .invite-btn:hover { filter:brightness(0.95); }
        .invite-text { font-size:14px; color:#333; }
        .modal { display:none; position:fixed; z-index:1300; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6); align-items:center; justify-content:center; padding:20px; }
        .modal[aria-hidden="false"] { display:flex; }
        .modal-content { background:white; border-radius:12px; width:100%; max-width:420px; padding:20px; box-shadow:0 8px 30px rgba(0,0,0,0.3); direction:rtl; text-align:right; }
        .modal-content h2 { margin-bottom:12px; color:#333; }
        .modal-content label { display:block; margin-top:10px; font-size:14px; color:#555; }
        .modal-content input, .modal-content select { width:100%; padding:10px 12px; margin-top:6px; border:1px solid #ddd; border-radius:8px; font-size:14px; }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:16px; }
        .btn-primary { background:#28a745; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
        .btn-secondary { background:#f0f0f0; color:#333; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
        .error { color:#c0392b; font-size:13px; margin-top:8px; }
        .success-msg { color:#155724; background:#d4edda; padding:10px; border-radius:8px; margin-top:12px; }
        .carousel { position: relative; max-width:100%; margin-bottom:20px; overflow:hidden; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
        .carousel-inner { display:flex; transition:transform 0.5s ease; }
        .carousel-item { min-width:100%; text-align:center; padding:30px; background:white; }
        .carousel-item h3 { margin-bottom:10px; color:#333; }
        .carousel-prev, .carousel-next { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border:none; padding:15px; cursor:pointer; font-size:24px; }
        .carousel-prev { left:10px; } .carousel-next { right:10px; }
        .controls { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin:20px 0; }
        select,input,button { padding:12px 20px; border:2px solid #ddd; border-radius:8px; font-size:16px; background:white; }
        button { background:#4CAF50; color:white; border:none; cursor:pointer; transition:background 0.3s; } button:hover { background:#45a049; }
        #search-input { width:100%; max-width:300px; direction:rtl; }
        #autocomplete-list { position:absolute; background:white; border:1px solid #ddd; max-height:200px; overflow-y:auto; z-index:1000; width:300px; direction:rtl; }
        #autocomplete-list div { padding:10px; cursor:pointer; } #autocomplete-list div:hover { background:#f0f0f0; }
        #price-range { display:flex; gap:10px; } .stats { display:flex; flex-wrap:wrap; gap:15px; margin:20px 0; }
        .stat-card { flex:1; min-width:200px; background:white; padding:15px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
        .stat-card h3 { color:#666; font-size:14px; margin-bottom:5px; } .stat-card .value { font-size:24px; font-weight:bold; color:#333; }
        #chart-container { margin:20px 0; display:none; background:white; padding:20px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
        #data-table { width:100%; background:white; border-radius:15px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.2); margin-top:20px; }
        #data-table table { width:100%; border-collapse:collapse; } #data-table th { background:#4CAF50; color:white; padding:15px; text-align:left; position:sticky; top:0; } #data-table td { padding:12px 15px; border-bottom:1px solid #eee; } #data-table tr:hover { background:#f0f8ff; cursor:pointer; }
        .highlight { background:#ffffcc !important; } .discount-badge { background:#ff4444; color:white; padding:3px 8px; border-radius:4px; font-size:12px; animation:pulse 1s infinite; }
        @keyframes pulse { 0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);} }
        .pagination { display:flex; justify-content:center; gap:10px; margin-top:20px; } .pagination button { padding:8px 16px; background:white; color:#333; border:1px solid #ddd; } .pagination button.active { background:#4CAF50; color:white; }
        .loading { text-align:center; padding:40px; color:white; font-size:18px; }
        @media (max-width:768px) { .controls { flex-direction:column; } .stats { flex-direction:column; } #data-table { overflow-x:auto; } .invite-card { right:12px; left:12px; top:12px; justify-content:center; } }
    </style>
</head>
<body dir="rtl">
    <div class="container">
        <header>
            <h1>ğŸ›’ Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</h1>
            <p>Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Google</p>
        </header>

        <!-- Floating invite card -->
        <div class="invite-card" id="invite-card" aria-live="polite">
            <div class="invite-text" id="invite-text">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
            <button class="invite-btn" id="invite-btn" onclick="openRegisterModal()">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</button>
        </div>

        <!-- Registration modal -->
        <div class="modal" id="register-modal" role="dialog" aria-labelledby="register-title" aria-hidden="true">
            <div class="modal-content" role="document">
                <h2 id="register-title">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <form id="register-form" onsubmit="event.preventDefault(); submitRegistration();">
                    <label for="reg-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input id="reg-name" name="name" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>

                    <label for="reg-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input id="reg-email" name="email" type="email" placeholder="example@domain.com" required>

                    <label for="reg-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input id="reg-password" name="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" required>

                    <label for="reg-password-confirm">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input id="reg-password-confirm" name="passwordConfirm" type="password" placeholder="Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>

                    <label for="reg-supermarket">Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª Ù…ÙØ¶Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <select id="reg-supermarket" name="supermarket">
                        <option value="">-- Ø§Ø®ØªØ± --</option>
                    </select>

                    <div id="register-error" class="error" role="alert" aria-live="assertive" style="display:none"></div>
                    <div id="register-success" class="success-msg" style="display:none"></div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeRegisterModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" class="btn-primary">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="carousel" id="carousel">
            <div class="carousel-inner" id="carousel-inner"></div>
            <button class="carousel-prev" onclick="prevSlide()">â€¹</button>
            <button class="carousel-next" onclick="nextSlide()">â€º</button>
        </div>

        <div class="controls">
            <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..." aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«">
            <div id="autocomplete-list" role="listbox" aria-label="Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø¨Ø­Ø«"></div>

            <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª">
                <option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
            </select>

            <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©">
                <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
            </select>

            <div id="price-range">
                <input type="number" id="min-price" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±">
                <input type="number" id="max-price" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±">
            </div>

            <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
                <option value="">ÙØ±Ø² Ø­Ø³Ø¨</option>
                <option value="discount-desc">Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø£ÙƒØ¨Ø± Ù„Ù„Ø£ØµØºØ±</option>
                <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰</option>
            </select>

            <input type="number" id="min-discount" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…">

            <button onclick="applyFilters()">ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
            <button onclick="resetFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
            <button onclick="exportToCSV()">ğŸ“¥ ØªØµØ¯ÙŠØ± CSV</button>
            <button onclick="toggleChart()">ğŸ“Š Ø¹Ø±Ø¶ Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        </div>

        <div class="stats" role="region" aria-label="Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</h3>
                <div class="value" id="total-offers">0</div>
            </div>
            <div class="stat-card">
                <h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</h3>
                <div class="value" id="avg-discount">0%</div>
            </div>
            <div class="stat-card">
                <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</h3>
                <div class="value" id="supermarket-count">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„ÙØ¦Ø§Øª</h3>
                <div class="value" id="category-count">0</div>
            </div>
        </div>

        <div id="chart-container" aria-label="Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">
            <canvas id="stats-chart"></canvas>
        </div>

        <div class="loading" id="loading" role="alert">
            Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Google...
        </div>

        <div id="data-table" style="display: none;" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶">
            <table id="offers-table">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„ÙØ¦Ø©</th>
                        <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
                        <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</th>
                        <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                        <th>Ø§Ù„Ø®ØµÙ…</th>
                        <th>Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©</th>
                        <th>Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
                </tbody>
            </table>

            <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙØ­Ø§Øª Ù‡Ù†Ø§ -->
            </div>
        </div>
    </div>

    <script>
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
        const CACHE_KEY = 'offersData';
        const CACHE_EXPIRY = 3600000; // 1 hour

        const supermarketUrls = {
            "2B": "https://2b.com.eg/",
            "Ø§Ù„Ø±Ø§ÙŠØ©": "https://alrayah.com/",
            "Ø§Ù„Ø±Ø§ÙŠØ© Ù…Ø§Ø±ÙƒØª": "https://alrayah.com/",
            "Ø§Ù„Ø±Ø§ÙŠÙ‡ Ù…Ø§Ø±ÙƒØª": "https://alrayah.com/",
            "Al Rayah": "https://alrayah.com/",
            "Al Rayah Market": "https://alrayah.com/",
            "Raya Market": "https://alrayah.com/",
            "Alfa Market": "https://alfamarket.com.eg/",
            "Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨": "https://awladragab.com/",
            "Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨ Awlad Ragab": "https://awladragab.com/",
            "Awlad Ragab": "https://awladragab.com/",
            "Awlad Ragab Retail Stores": "https://awladragab.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø©": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© - BEIT EL GOMLIA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© (BEIT EL GOMLÃ„)": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© / BEIT EL GOMLA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© / BEIT EL GOMLÃ„": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© / BEIT EL GOMLIA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© BEIT EL GOMLA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© BEIT EL GOMLÃ„": "https://beitelgomla.com/",
            "BEIT EL GOMLA": "https://beitelgomla.com/",
            "BEIT EL GOMLIA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© | BEIT EL GOMLA": "https://beitelgomla.com/",
            "BIM": "https://bim.com.tr/",
            "Carrefour": "https://carrefour.com.eg/",
            "Carrefour Market": "https://carrefour.com.eg/",
            "elezaby pharmacy": "https://elezaby.com/",
            "Ø£Ø³ÙˆØ§Ù‚ ÙØªØ­ Ø§Ù„Ù„Ù‡": "https://fathalla.com/",
            "Fathalla": "https://fathalla.com/",
            "Fathalla House": "https://fathalla.com/",
            "FATHALLA MARKET": "https://fathalla.com/",
            "HYPER 1": "https://hyperone.com.eg/",
            "HYPER1": "https://hyperone.com.eg/",
            "Imtenan": "https://imtenan.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ†": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† - Ù…Ø§Ø±ÙƒØª": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† - Ù…Ø§Ø±ÙƒØª -": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† ÙØ±ÙŠØ´": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† Ù…Ø§Ø±ÙƒØª": "https://kazyon.com/",
            "kazyon Market": "https://kazyon.com/",
            "kazyon -Market-": "https://kazyon.com/",
            "Ø®ÙŠØ± Ø²Ù…Ø§Ù†": "https://kheirzaman.com/",
            "Ø²Ù…Ø§Ù†": "https://kheirzaman.com/",
            "Kheir Zaman": "https://kheirzaman.com/",
            "LuLu": "https://ae.luluhypermarket.com/",
            "LuLu HYPERMARKET": "https://ae.luluhypermarket.com/",
            "LuLu Hypermarket": "https://ae.luluhypermarket.com/",
            "Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ EL MAHALAWY STORES": "https://mahalawy.com/",
            "Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ Ø³ØªÙˆØ±Ø²": "https://mahalawy.com/",
            "Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ Ù…Ø§Ø±ÙƒØª": "https://mahalawy.com/",
            "Mahalawy Market": "https://mahalawy.com/",
            "Mahalawy Stores": "https://mahalawy.com/",
            "Hyper El Mahlawy": "https://mahalawy.com/",
            "EL MAHALAWY STORES": "https://mahalawy.com/",
            "Mahmoud El Far Market": "https://mahmoudelfar.com/",
            "Mahmoud El Farmarket": "https://mahmoudelfar.com/",
            "MAHMOUD ELFAR": "https://mahmoudelfar.com/",
            "Mahmoud Elfar Market": "https://mahmoudelfar.com/",
            "Mahmoud ElFarmarket": "https://mahmoudelfar.com/",
            "METRO": "https://www.metro-markets.com/",
            "ØµÙŠØ¯Ù„ÙŠØ§Øª Ù…ØµØ±": "https://misp.com.eg/",
            "ØµÙŠØ¯Ù„ÙŠØ§Øª Ù…ØµØ± MISR PHARMACIES": "https://misp.com.eg/",
            "Misr Pharmacies": "https://misp.com.eg/",
            "OSCAR": "https://oscar.com.eg/",
            "Ø§Ù„Ø¹Ø«ÙŠÙ…": "https://othaim.com/",
            "Othaim": "https://othaim.com/",
            "Ø¨Ù†Ø¯Ù‡ Panda": "https://panda.com.eg/",
            "Panda": "https://panda.com.eg/",
            "Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ø© ÙˆØ£ÙˆÙ„Ø§Ø¯Ù‡": "https://samysalama.com/",
            "Ø¬Ø²Ø§Ø±Ø© Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ù‡": "https://samysalama.com/",
            "Samy Salama Sons": "https://samysalama.com/",
            "Ù‡Ø§ÙŠØ¨Ø± S Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ø© ÙˆØ£ÙˆÙ„Ø§Ø¯Ù‡": "https://samysalama.com/",
            "Ø³Ù†ØªØ± Ø´Ø§Ù‡ÙŠÙ†": "https://shaheeneg.com/",
            "Shaheen Center": "https://shaheeneg.com/",
            "Spinneys": "https://spinneys.com.eg/",
            "Spinneys Extra": "https://spinneys.com.eg/",
            "Spinneys Plus": "https://spinneys.com.eg/",
            "Supeco": "https://supeco.com.eg/",
            "Supeco Ø³ÙˆÙŠØ¨ÙŠÙƒÙˆ": "https://supeco.com.eg/",
            "Supeco Ø³ÙˆØ¨ÙŠÙƒÙˆ": "https://supeco.com.eg/",
            "Ø¬Ù…Ù„Ø© Ù…Ø§Ø±ÙƒØª": "https://gomlamarket.com/",
            "GOMLA MARKET": "https://gomlamarket.com/",
            "Gomla Market": "https://gomlamarket.com/",
            "Ø±ÙˆÙŠØ§Ù„ Ù‡Ø§ÙˆØ³": "https://royalhouse.com.eg/",
            "Royal House": "https://royalhouse.com.eg/",
            "Seoudi": "https://seoudi.com/",
            "Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©": "https://mazarastores.com/",
            "Ù‡Ø§ÙŠØ¨Ø± Ù…ÙˆØ³Ù‰": "https://hypermoussa.com/",
            "Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠ": "https://elmorshedy.com/",
            "Ù…Ø§ÙŠ ÙˆØ§ÙŠ": "https://myway.com.eg/",
            "my way": "https://myway.com.eg/",
            "Ø±Ù†ÙŠÙ†": "https://raneen.com/",
            "Ø¹Ø±ÙØ©": "https://arafa.com/",
            "Arafa": "https://arafa.com/",
            "Ø£Ø¨ÙˆØ¹ÙˆÙ": "https://abuauf.com/",
            "Abu Auf": "https://abuauf.com/",
            "Ø£Ø¨Ùˆ Ø¹ÙˆÙ": "https://abuauf.com/",
            "Ù†ÙˆÙ†": "https://noon.com/",
            "Noon": "https://noon.com/",
            "Ø²Ù‡Ø±Ø§Ù† Ù…Ø§Ø±ÙƒØª": "https://zahran.com/",
            "Zahran Market": "https://zahran.com/",
            "Ø£ÙˆÙ„Ø§Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ": "https://almahalawy.com/",
            "Almahalawy Sons": "https://almahalawy.com/"
        };

        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let chart = null;
        let carouselIndex = 0;

        // helper to safely parse "ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶" into a readable string
        function parseValidUntil(raw) {
            // if already a Date (some inputs may be Date objects), format it
            try {
                if (raw && typeof raw.getFullYear === 'function') {
                    const d = raw;
                    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
            } catch (e) {
                // continue to other checks
            }

            if (raw == null || raw === '') return 'ØºÙŠØ± Ù…ØªØ§Ø­';

            // if it's a number, it might be an Excel serial (days since 1899-12-30)
            if (typeof raw === 'number' && isFinite(raw)) {
                // convert Excel serial to JS Date (handles typical Excel serials)
                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                const d = new Date(excelEpoch.getTime() + raw * 24 * 3600 * 1000);
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }

            // if it's a string, try to extract sensible part
            const s = String(raw).trim();
            // if contains " to " keep the second part as before
            if (s.includes(' to ')) {
                const parts = s.split(' to ').map(p => p.trim());
                if (parts[1]) return parts[1];
            }
            // if contains '-' or '/' look for a date-like substring
            const dateMatch = s.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})/);
            if (dateMatch) return dateMatch[0];
            // fallback: return the whole string
            return s || 'ØºÙŠØ± Ù…ØªØ§Ø­';
        }

        // registration helpers (unchanged)
        function openRegisterModal() { const modal = document.getElementById('register-modal'); modal.setAttribute('aria-hidden','false'); setTimeout(()=>document.getElementById('reg-name').focus(),100); }
        function closeRegisterModal() { const modal = document.getElementById('register-modal'); modal.setAttribute('aria-hidden','true'); document.getElementById('register-error').style.display='none'; document.getElementById('register-success').style.display='none'; }
        function loadRegisteredUser() { try { const raw = localStorage.getItem('eg_user'); if (!raw) return null; return JSON.parse(raw); } catch(e){ return null; } }
        function updateInviteCard() { const user = loadRegisteredUser(); const text = document.getElementById('invite-text'); const btn = document.getElementById('invite-btn'); if (user && user.name) { text.textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ${user.name}`; btn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'; btn.onclick = ()=>{ localStorage.removeItem('eg_user'); updateInviteCard(); }; } else { text.textContent = 'Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ø¹Ø±ÙˆØ¶'; btn.textContent = 'Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†'; btn.onclick = openRegisterModal; } }
        function validateEmail(email) { const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return re.test(email); }
        function submitRegistration() {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-password').value;
            const passConfirm = document.getElementById('reg-password-confirm').value;
            const pref = document.getElementById('reg-supermarket').value;
            const errEl = document.getElementById('register-error');
            const successEl = document.getElementById('register-success');
            errEl.style.display='none'; successEl.style.display='none';
            if (!name) { errEl.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„.'; errEl.style.display='block'; return; }
            if (!validateEmail(email)) { errEl.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­.'; errEl.style.display='block'; return; }
            if (pass.length < 6) { errEl.textContent='ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'; errEl.style.display='block'; return; }
            if (pass !== passConfirm) { errEl.textContent='ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.'; errEl.style.display='block'; return; }
            const user = { name, email, preferredSupermarket: pref || null, registeredAt: new Date().toISOString() };
            try { localStorage.setItem('eg_user', JSON.stringify(user)); } catch(e){ console.error('Failed to save user locally', e); }
            successEl.innerHTML='ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø©.'; successEl.style.display='block';
            updateInviteCard();
            setTimeout(()=>closeRegisterModal(),1200);
        }
        function populateRegisterSupermarketOptions() {
            const select = document.getElementById('reg-supermarket');
            const keys = Object.keys(supermarketUrls).slice(0, 40);
            keys.forEach(k=>{ const option = document.createElement('option'); option.value=k; option.textContent=k; select.appendChild(option); });
        }

        // --- Data fetching and processing with defensive parsing to avoid calling date methods on non-dates ---
        async function fetchData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').innerHTML = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Google...';

                const cached = localStorage.getItem(CACHE_KEY);
                const cachedTimeRaw = localStorage.getItem(`${CACHE_KEY}_time`);
                const cachedTime = cachedTimeRaw ? parseInt(cachedTimeRaw, 10) : 0;

                if (cached && cachedTime && Date.now() - cachedTime < CACHE_EXPIRY) {
                    try {
                        const decompressed = LZString.decompressFromUTF16(cached);
                        allData = JSON.parse(decompressed);
                        // ensure currentPrice is numeric and filter invalid ones
                        allData = allData.map(row => {
                            // coerce currentPrice to number safely
                            let cp = Number(row.currentPrice);
                            if (!isFinite(cp)) cp = 0;
                            return Object.assign({}, row, { currentPrice: cp, validUntil: parseValidUntil(row.validUntil) });
                        }).filter(item => item.currentPrice && item.currentPrice > 0);
                    } catch (e) {
                        console.warn('Failed to read cached data, clearing cache and refetching', e);
                        localStorage.removeItem(CACHE_KEY);
                        localStorage.removeItem(`${CACHE_KEY}_time`);
                        // fall through to fetch fresh
                    }
                }

                if (!allData || allData.length === 0) {
                    const response = await fetch(DATA_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const dataText = await response.text();

                    // turn off dynamicTyping to avoid unexpected automatic conversions (we'll parse numbers explicitly)
                    const parsed = Papa.parse(dataText, {
                        header: true,
                        skipEmptyLines: true,
                        trim: true,
                        dynamicTyping: false
                    });

                    const data = parsed.data || [];
                    allData = data.map(item => {
                        // safe extraction with coercion
                        const original = item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ'];
                        const current = item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ'];
                        const discountRaw = item['Ø§Ù„Ø®ØµÙ… %'];

                        const originalPrice = parseFloat(String(original).replace(/,/g, '')) || 0;
                        const currentPrice = parseFloat(String(current).replace(/,/g, '')) || 0;
                        const discount = parseFloat(String(discountRaw).replace('%','').replace(/,/g,'').trim()) || 0;

                        return {
                            supermarket: item['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            product: item['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            category: item['Ø§Ù„ÙØ¦Ø©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            brand: item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            originalPrice,
                            currentPrice,
                            discount,
                            promotion: item['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
                            validUntil: parseValidUntil(item['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶']),
                            currency: item['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP'
                        };
                    });

                    // filter rows: Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ must be > 0 and not null
                    allData = allData.filter(row => Number(row.currentPrice) && Number(row.currentPrice) > 0);

                    try {
                        localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData)));
                        localStorage.setItem(`${CACHE_KEY}_time`, String(Date.now()));
                    } catch (e) {
                        console.log('Caching failed (data too large)', e);
                    }
                }

                initializeFilters();
                applyFilters();
                updateStats();
                renderCarousel();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-table').style.display = 'block';

            } catch (error) {
                console.error('Error fetching data:', error);
                // show full error message (Arabic)
                document.getElementById('loading').innerHTML = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error && error.message ? error.message : String(error)}`;
            }
        }

        // rest of app functions (mostly unchanged) ...
        function renderCarousel() {
            const inner = document.getElementById('carousel-inner');
            inner.innerHTML = '';
            const hotDeals = allData.filter(item => item.discount > 20).slice(0, 5);
            if (hotDeals.length === 0) {
                inner.innerHTML = '<div class="carousel-item"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3></div>';
                return;
            }
            hotDeals.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('carousel-item');
                div.innerHTML = `
                    <h3>${item.product}</h3>
                    <p><strong>${item.supermarket}</strong> â€” Ø®ØµÙ… ${item.discount}%</p>
                    <p>ÙƒØ§Ù† ${item.originalPrice} ${item.currency} â†’ Ø§Ù„Ø¢Ù† ${item.currentPrice} ${item.currency}</p>
                    <p>${item.promotion}</p>
                `;
                inner.appendChild(div);
            });
            showSlide(carouselIndex);
        }
        function showSlide(index) { const inner = document.getElementById('carousel-inner'); const items = inner.children; if (items.length === 0) return; carouselIndex = (index + items.length) % items.length; inner.style.transform = `translateX(-${carouselIndex * 100}%)`; }
        function prevSlide() { showSlide(carouselIndex - 1); }
        function nextSlide() { showSlide(carouselIndex + 1); }

        function initializeFilters() {
            const supermarketSelect = document.getElementById('supermarket-filter');
            supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
            const supermarkets = [...new Set(allData.map(item => item.supermarket))].filter(Boolean);
            supermarkets.forEach(supermarket => { const option = document.createElement('option'); option.value = supermarket; option.textContent = supermarket; supermarketSelect.appendChild(option); });

            const categorySelect = document.getElementById('category-filter');
            categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
            const categories = [...new Set(allData.map(item => item.category))].filter(Boolean);
            categories.forEach(category => { const option = document.createElement('option'); option.value = category; option.textContent = category; categorySelect.appendChild(option); });

            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', showAutocomplete);
            document.addEventListener('click', (e) => {
                const list = document.getElementById('autocomplete-list');
                if (!document.getElementById('search-input').contains(e.target)) list.innerHTML = '';
            });

            document.getElementById('sort-by').addEventListener('change', applyFilters);
        }

        function showAutocomplete() {
            const val = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';
            if (!val) return;
            const suggestions = [...new Set(allData.map(item => item.product).concat(allData.map(item => item.brand)))].filter(s => s && s.toLowerCase().includes(val)).slice(0, 10);
            suggestions.forEach(s => {
                const div = document.createElement('div');
                div.textContent = s;
                div.addEventListener('click', () => {
                    document.getElementById('search-input').value = s;
                    list.innerHTML = '';
                    applyFilters();
                });
                list.appendChild(div);
            });
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const supermarket = document.getElementById('supermarket-filter').value;
            const category = document.getElementById('category-filter').value;
            const minDiscount = parseFloat(document.getElementById('min-discount').value) || 0;
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
            const sort = document.getElementById('sort-by').value;

            filteredData = allData.filter(item => {
                // ensure currentPrice valid (>0)
                if (!item.currentPrice || Number(item.currentPrice) <= 0) return false;
                const matchesSearch = !search || (item.product && item.product.toLowerCase().includes(search)) || (item.brand && item.brand.toLowerCase().includes(search));
                const matchesSupermarket = !supermarket || item.supermarket === supermarket;
                const matchesCategory = !category || item.category === category;
                const matchesDiscount = item.discount >= minDiscount;
                const matchesPrice = Number(item.currentPrice) >= minPrice && Number(item.currentPrice) <= maxPrice;
                return matchesSearch && matchesSupermarket && matchesCategory && matchesDiscount && matchesPrice;
            });

            if (sort === 'discount-desc') filteredData.sort((a,b)=>b.discount - a.discount);
            else if (sort === 'price-asc') filteredData.sort((a,b)=>Number(a.currentPrice) - Number(b.currentPrice));

            currentPage = 1;
            renderTable();
            updateStats();
            updatePagination();
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('supermarket-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('min-discount').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            document.getElementById('sort-by').value = '';
            applyFilters();
        }

        function renderTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach(item => {
                const row = document.createElement('tr');
                const url = supermarketUrls[item.supermarket] || (item.supermarket && supermarketUrls[item.supermarket.trim()]);
                if (url) { row.style.cursor = 'pointer'; row.title = `Ø²ÙŠØ§Ø±Ø© Ù…ÙˆÙ‚Ø¹ ${item.supermarket}`; row.onclick = () => window.open(url, '_blank'); }
                row.innerHTML = `
                    <td>${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.originalPrice ? `${item.originalPrice} ${item.currency}` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.currentPrice ? `${item.currentPrice} ${item.currency}` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.discount ? `<span class="discount-badge">${item.discount}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.promotion || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                    <td>${item.validUntil || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                `;
                if (item.discount && item.discount > 20) row.classList.add('highlight');
                tableBody.appendChild(row);
            });
        }

        function updateStats() {
            document.getElementById('total-offers').textContent = filteredData.length;
            const discounts = filteredData.filter(item => item.discount).map(item => item.discount);
            const avgDiscount = discounts.length > 0 ? Math.round(discounts.reduce((a,b)=>a+b)/discounts.length) : 0;
            document.getElementById('avg-discount').textContent = `${avgDiscount}%`;
            const supermarkets = [...new Set(filteredData.map(item=>item.supermarket).filter(Boolean))];
            document.getElementById('supermarket-count').textContent = supermarkets.length;
            const categories = [...new Set(filteredData.map(item=>item.category).filter(Boolean))];
            document.getElementById('category-count').textContent = categories.length;
        }

        function toggleChart() {
            const container = document.getElementById('chart-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            if (chart) chart.destroy();
            const ctx = document.getElementById('stats-chart').getContext('2d');
            const discountRanges = { '0-10%':0,'11-20%':0,'21-30%':0,'30+%':0 };
            filteredData.forEach(item => {
                if (item.discount <= 10) discountRanges['0-10%']++;
                else if (item.discount <= 20) discountRanges['11-20%']++;
                else if (item.discount <= 30) discountRanges['21-30%']++;
                else discountRanges['30+%']++;
            });
            chart = new Chart(ctx, {
                type: 'pie',
                data: { labels: Object.keys(discountRanges), datasets: [{ data: Object.values(discountRanges), backgroundColor: ['#ff6384','#36a2eb','#ffce56','#4bc0c0'] }] },
                options: { responsive:true }
            });
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (totalPages <= 1) return;
            const prevButton = document.createElement('button');
            prevButton.textContent = 'â†'; prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); updatePagination(); } };
            pagination.appendChild(prevButton);
            for (let i=1;i<=totalPages;i++){
                const button = document.createElement('button'); button.textContent = i;
                if (i===currentPage) button.classList.add('active');
                button.onclick = ()=>{ currentPage = i; renderTable(); updatePagination(); };
                pagination.appendChild(button);
            }
            const nextButton = document.createElement('button');
            nextButton.textContent = 'â†’'; nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = ()=>{ if (currentPage < totalPages) { currentPage++; renderTable(); updatePagination(); } };
            pagination.appendChild(nextButton);
        }

        function exportToCSV() {
            const headers = ['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª','Ø§Ù„Ù…Ù†ØªØ¬','Ø§Ù„ÙØ¦Ø©','Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ','Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ','Ø§Ù„Ø®ØµÙ…','Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©','Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰'];
            const csvData = [ headers.join(','), ...filteredData.map(item => [
                item.supermarket,
                `"${(item.product || '').replace(/"/g,'""')}"`,
                item.category,
                item.brand,
                item.originalPrice,
                item.currentPrice,
                item.discount,
                `"${(item.promotion || '').replace(/"/g,'""')}"`,
                item.validUntil
            ].join(',')) ].join('\n');
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'supermarket_offers.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // initial setup
        document.addEventListener('DOMContentLoaded', () => {
            populateRegisterSupermarketOptions();
            updateInviteCard();
            fetchData();
        });

        // close modal when clicking outside content
        document.getElementById('register-modal').addEventListener('click', function (e) {
            if (e.target === this) closeRegisterModal();
        });
    </script>
</body>
</html>