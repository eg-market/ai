<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supermarket Offers Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .carousel {
            position: relative;
            max-width: 100%;
            margin-bottom: 20px;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .carousel-inner {
            display: flex;
            transition: transform 0.5s ease;
        }

        .carousel-item {
            min-width: 100%;
            text-align: center;
            padding: 30px;
            background: white;
        }

        .carousel-item h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .carousel-prev, .carousel-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 15px;
            cursor: pointer;
            font-size: 24px;
        }

        .carousel-prev { left: 10px; }
        .carousel-next { right: 10px; }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        select, input, button {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        #search-input {
            width: 100%;
            max-width: 300px;
        }

        #autocomplete-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 300px;
        }

        #autocomplete-list div {
            padding: 10px;
            cursor: pointer;
        }

        #autocomplete-list div:hover {
            background: #f0f0f0;
        }

        #price-range {
            display: flex;
            gap: 10px;
        }

        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        #chart-container {
            margin: 20px 0;
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #data-table {
            width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }

        #data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        #data-table th {
            background: #4CAF50;
            color: white;
            padding: 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        #data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        #data-table tr:hover {
            background: #f0f8ff;
            cursor: pointer;
        }

        .highlight {
            background: #ffffcc !important;
        }

        .discount-badge {
            background: #ff4444;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .pagination button.active {
            background: #4CAF50;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .stats {
                flex-direction: column;
            }

            #data-table {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ›’ Supermarket Offers Dashboard</h1>
            <p>Dynamic data retrieval from Google Sheets</p>
        </header>

        <div class="carousel" id="carousel">
            <div class="carousel-inner" id="carousel-inner"></div>
            <button class="carousel-prev" onclick="prevSlide()">â€¹</button>
            <button class="carousel-next" onclick="nextSlide()">â€º</button>
        </div>

        <div class="controls">
            <input type="text" id="search-input" placeholder="Search products or brands..." aria-label="Search Input">
            <div id="autocomplete-list"></div>
            
            <select id="supermarket-filter" aria-label="Supermarket Filter">
                <option value="">All Supermarkets</option>
            </select>
            
            <select id="category-filter" aria-label="Category Filter">
                <option value="">All Categories</option>
            </select>
            
            <div id="price-range">
                <input type="number" id="min-price" placeholder="Min Price" aria-label="Minimum Price">
                <input type="number" id="max-price" placeholder="Max Price" aria-label="Maximum Price">
            </div>
            
            <select id="sort-by" aria-label="Sort By">
                <option value="">Sort By</option>
                <option value="discount-desc">Discount High to Low</option>
                <option value="price-asc">Price Low to High</option>
            </select>
            
            <input type="number" id="min-discount" placeholder="Min Discount %" aria-label="Minimum Discount">
            
            <button onclick="applyFilters()">ğŸ” Apply Filters</button>
            <button onclick="resetFilters()">ğŸ”„ Reset</button>
            <button onclick="exportToCSV()">ğŸ“¥ Export CSV</button>
            <button onclick="toggleChart()">ğŸ“Š Show Stats Chart</button>
        </div>

        <div class="stats" role="region" aria-label="Statistics Cards">
            <div class="stat-card">
                <h3>Total Offers</h3>
                <div class="value" id="total-offers">0</div>
            </div>
            <div class="stat-card">
                <h3>Average Discount</h3>
                <div class="value" id="avg-discount">0%</div>
            </div>
            <div class="stat-card">
                <h3>Supermarkets</h3>
                <div class="value" id="supermarket-count">0</div>
            </div>
            <div class="stat-card">
                <h3>Categories</h3>
                <div class="value" id="category-count">0</div>
            </div>
        </div>

        <div id="chart-container">
            <canvas id="stats-chart"></canvas>
        </div>

        <div class="loading" id="loading" role="alert">
            Loading data from Google Sheets...
        </div>

        <div id="data-table" style="display: none;" role="region" aria-label="Offers Table">
            <table id="offers-table">
                <thead>
                    <tr>
                        <th>Supermarket</th>
                        <th>Product</th>
                        <th>Category</th>
                        <th>Brand</th>
                        <th>Original Price</th>
                        <th>Current Price</th>
                        <th>Discount</th>
                        <th>Promotion</th>
                        <th>Valid Until</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
            
            <div class="pagination" id="pagination" role="navigation" aria-label="Pagination">
                <!-- Pagination will be inserted here -->
            </div>
        </div>
    </div>
    <script>
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
        const CACHE_KEY = 'offersData';
        const CACHE_EXPIRY = 3600000; // 1 hour

        const supermarketUrls = {
            "2B": "https://2b.com.eg/",
            "Ø§Ù„Ø±Ø§ÙŠØ©": "https://alrayah.com/",
            "Ø§Ù„Ø±Ø§ÙŠØ© Ù…Ø§Ø±ÙƒØª": "https://alrayah.com/",
            "Ø§Ù„Ø±Ø§ÙŠÙ‡ Ù…Ø§Ø±ÙƒØª": "https://alrayah.com/",
            "Al Rayah": "https://alrayah.com/",
            "Al Rayah Market": "https://alrayah.com/",
            "Raya Market": "https://alrayah.com/",
            "Alfa Market": "https://alfamarket.com.eg/",
            "Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨": "https://awladragab.com/",
            "Ø£ÙˆÙ„Ø§Ø¯ Ø±Ø¬Ø¨ Awlad Ragab": "https://awladragab.com/",
            "Awlad Ragab": "https://awladragab.com/",
            "Awlad Ragab Retail Stores": "https://awladragab.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø©": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© - BEIT EL GOMLIA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© (BEIT EL GOMLÃ„)": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© / BEIT EL GOMLA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© / BEIT EL GOMLÃ„": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© / BEIT EL GOMLIA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© BEIT EL GOMLA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© BEIT EL GOMLÃ„": "https://beitelgomla.com/",
            "BEIT EL GOMLA": "https://beitelgomla.com/",
            "BEIT EL GOMLIA": "https://beitelgomla.com/",
            "Ø¨ÙŠØª Ø§Ù„Ø¬Ù…Ù„Ø© | BEIT EL GOMLA": "https://beitelgomla.com/",
            "BIM": "https://bim.com.tr/",
            "Carrefour": "https://carrefour.com.eg/",
            "Carrefour Market": "https://carrefour.com.eg/",
            "elezaby pharmacy": "https://elezaby.com/",
            "Ø£Ø³ÙˆØ§Ù‚ ÙØªØ­ Ø§Ù„Ù„Ù‡": "https://fathalla.com/",
            "Fathalla": "https://fathalla.com/",
            "Fathalla House": "https://fathalla.com/",
            "FATHALLA MARKET": "https://fathalla.com/",
            "HYPER 1": "https://hyperone.com.eg/",
            "HYPER1": "https://hyperone.com.eg/",
            "Imtenan": "https://imtenan.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ†": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† - Ù…Ø§Ø±ÙƒØª": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† - Ù…Ø§Ø±ÙƒØª -": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† ÙØ±ÙŠØ´": "https://kazyon.com/",
            "ÙƒØ§Ø²ÙŠÙˆÙ† Ù…Ø§Ø±ÙƒØª": "https://kazyon.com/",
            "kazyon Market": "https://kazyon.com/",
            "kazyon -Market-": "https://kazyon.com/",
            "Ø®ÙŠØ± Ø²Ù…Ø§Ù†": "https://kheirzaman.com/",
            "Ø²Ù…Ø§Ù†": "https://kheirzaman.com/",
            "Kheir Zaman": "https://kheirzaman.com/",
            "LuLu": "https://ae.luluhypermarket.com/",
            "LuLu HYPERMARKET": "https://ae.luluhypermarket.com/",
            "LuLu Hypermarket": "https://ae.luluhypermarket.com/",
            "Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ EL MAHALAWY STORES": "https://mahalawy.com/",
            "Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ Ø³ØªÙˆØ±Ø²": "https://mahalawy.com/",
            "Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ Ù…Ø§Ø±ÙƒØª": "https://mahalawy.com/",
            "Mahalawy Market": "https://mahalawy.com/",
            "Mahalawy Stores": "https://mahalawy.com/",
            "Hyper El Mahlawy": "https://mahalawy.com/",
            "EL MAHALAWY STORES": "https://mahalawy.com/",
            "Mahmoud El Far Market": "https://mahmoudelfar.com/",
            "Mahmoud El Farmarket": "https://mahmoudelfar.com/",
            "MAHMOUD ELFAR": "https://mahmoudelfar.com/",
            "Mahmoud Elfar Market": "https://mahmoudelfar.com/",
            "Mahmoud ElFarmarket": "https://mahmoudelfar.com/",
            "METRO": "https://www.metro-markets.com/",
            "ØµÙŠØ¯Ù„ÙŠØ§Øª Ù…ØµØ±": "https://misp.com.eg/",
            "ØµÙŠØ¯Ù„ÙŠØ§Øª Ù…ØµØ± MISR PHARMACIES": "https://misp.com.eg/",
            "Misr Pharmacies": "https://misp.com.eg/",
            "OSCAR": "https://oscar.com.eg/",
            "Ø§Ù„Ø¹Ø«ÙŠÙ…": "https://othaim.com/",
            "Othaim": "https://othaim.com/",
            "Ø¨Ù†Ø¯Ù‡ Panda": "https://panda.com.eg/",
            "Panda": "https://panda.com.eg/",
            "Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ø© ÙˆØ£ÙˆÙ„Ø§Ø¯Ù‡": "https://samysalama.com/",
            "Ø¬Ø²Ø§Ø±Ø© Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ù‡": "https://samysalama.com/",
            "Samy Salama Sons": "https://samysalama.com/",
            "Ù‡Ø§ÙŠØ¨Ø± S Ø³Ø§Ù…ÙŠ Ø³Ù„Ø§Ù…Ø© ÙˆØ£ÙˆÙ„Ø§Ø¯Ù‡": "https://samysalama.com/",
            "Ø³Ù†ØªØ± Ø´Ø§Ù‡ÙŠÙ†": "https://shaheeneg.com/",
            "Shaheen Center": "https://shaheeneg.com/",
            "Spinneys": "https://spinneys.com.eg/",
            "Spinneys Extra": "https://spinneys.com.eg/",
            "Spinneys Plus": "https://spinneys.com.eg/",
            "Supeco": "https://supeco.com.eg/",
            "Supeco Ø³ÙˆÙŠØ¨ÙŠÙƒÙˆ": "https://supeco.com.eg/",
            "Supeco Ø³ÙˆØ¨ÙŠÙƒÙˆ": "https://supeco.com.eg/",
            "Ø¬Ù…Ù„Ø© Ù…Ø§Ø±ÙƒØª": "https://gomlamarket.com/",
            "GOMLA MARKET": "https://gomlamarket.com/",
            "Gomla Market": "https://gomlamarket.com/",
            "Ø±ÙˆÙŠØ§Ù„ Ù‡Ø§ÙˆØ³": "https://royalhouse.com.eg/",
            "Royal House": "https://royalhouse.com.eg/",
            "Seoudi": "https://seoudi.com/",
            "Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©": "https://mazarastores.com/",
            "Ù‡Ø§ÙŠØ¨Ø± Ù…ÙˆØ³Ù‰": "https://hypermoussa.com/",
            "Ø§Ù„Ù…Ø±Ø´Ø¯ÙŠ": "https://elmorshedy.com/",
            "Ù…Ø§ÙŠ ÙˆØ§ÙŠ": "https://myway.com.eg/",
            "my way": "https://myway.com.eg/",
            "Ø±Ù†ÙŠÙ†": "https://raneen.com/",
            "Ø¹Ø±ÙØ©": "https://arafa.com/",
            "Arafa": "https://arafa.com/",
            "Ø£Ø¨ÙˆØ¹ÙˆÙ": "https://abuauf.com/",
            "Abu Auf": "https://abuauf.com/",
            "Ø£Ø¨Ùˆ Ø¹ÙˆÙ": "https://abuauf.com/",
            "Ù†ÙˆÙ†": "https://noon.com/",
            "Noon": "https://noon.com/",
            "Ø²Ù‡Ø±Ø§Ù† Ù…Ø§Ø±ÙƒØª": "https://zahran.com/",
            "Zahran Market": "https://zahran.com/",
            "Ø£ÙˆÙ„Ø§Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§ÙˆÙŠ": "https://almahalawy.com/",
            "Almahalawy Sons": "https://almahalawy.com/"
        };

        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let chart = null;
        let carouselIndex = 0;

        async function fetchData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').innerHTML = 'Loading data from Google Sheets...';

                const cached = localStorage.getItem(CACHE_KEY);
                const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
                if (cached && cachedTime && Date.now() - cachedTime < CACHE_EXPIRY) {
                    allData = JSON.parse(LZString.decompressFromUTF16(cached));
                } else {
                    const response = await fetch(DATA_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const dataText = await response.text();
                    const parsed = Papa.parse(dataText, {
                        header: true,
                        skipEmptyLines: true,
                        trim: true,
                        dynamicTyping: true
                    });
                    const data = parsed.data;
                    
                    allData = data.map(item => ({
                        supermarket: item['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || 'N/A',
                        product: item['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || 'N/A',
                        category: item['Ø§Ù„ÙØ¦Ø©'] || 'N/A',
                        brand: item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || 'N/A',
                        originalPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ']) || 0,
                        currentPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0,
                        discount: parseFloat(item['Ø§Ù„Ø®ØµÙ… %']) || 0,
                        promotion: item['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || 'N/A',
                        validUntil: String(item['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || '').split(' to ')[1] || 'N/A',
                        currency: item['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP'
                    }));
                    
                    try {
                        localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData)));
                        localStorage.setItem(`${CACHE_KEY}_time`, Date.now());
                    } catch (e) {
                        console.log('Caching failed (data too large)', e);
                    }
                }
                
                initializeFilters();
                applyFilters();
                updateStats();
                renderCarousel();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-table').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loading').innerHTML = `Error loading data: ${error.message}`;
            }
        }
        
        function renderCarousel() {
            const inner = document.getElementById('carousel-inner');
            inner.innerHTML = '';
            const hotDeals = allData.filter(item => item.discount > 20).slice(0, 5);
            if (hotDeals.length === 0) {
                inner.innerHTML = '<div class="carousel-item"><h3>No hot deals currently</h3></div>';
                return;
            }
            hotDeals.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('carousel-item');
                div.innerHTML = `
                    <h3>${item.product}</h3>
                    <p><strong>${item.supermarket}</strong> â€” ${item.discount}% off</p>
                    <p>Was ${item.originalPrice} ${item.currency} â†’ Now ${item.currentPrice} ${item.currency}</p>
                    <p>${item.promotion}</p>
                `;
                inner.appendChild(div);
            });
            showSlide(carouselIndex);
        }

        function showSlide(index) {
            const inner = document.getElementById('carousel-inner');
            const items = inner.children;
            if (items.length === 0) return;
            carouselIndex = (index + items.length) % items.length;
            inner.style.transform = `translateX(-${carouselIndex * 100}%)`;
        }

        function prevSlide() { showSlide(carouselIndex - 1); }
        function nextSlide() { showSlide(carouselIndex + 1); }

        function initializeFilters() {
            const supermarkets = [...new Set(allData.map(item => item.supermarket))].filter(Boolean);
            const supermarketSelect = document.getElementById('supermarket-filter');
            supermarkets.forEach(supermarket => {
                const option = document.createElement('option');
                option.value = supermarket;
                option.textContent = supermarket;
                supermarketSelect.appendChild(option);
            });
            
            const categories = [...new Set(allData.map(item => item.category))].filter(Boolean);
            const categorySelect = document.getElementById('category-filter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', showAutocomplete);
            document.addEventListener('click', () => document.getElementById('autocomplete-list').innerHTML = '');

            document.getElementById('sort-by').addEventListener('change', applyFilters);
        }

        function showAutocomplete() {
            const val = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';
            if (!val) return;
            const suggestions = [...new Set(allData.map(item => item.product).concat(allData.map(item => item.brand)))].filter(s => s.toLowerCase().includes(val)).slice(0, 10);
            suggestions.forEach(s => {
                const div = document.createElement('div');
                div.textContent = s;
                div.addEventListener('click', () => {
                    document.getElementById('search-input').value = s;
                    list.innerHTML = '';
                    applyFilters();
                });
                list.appendChild(div);
            });
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const supermarket = document.getElementById('supermarket-filter').value;
            const category = document.getElementById('category-filter').value;
            const minDiscount = parseFloat(document.getElementById('min-discount').value) || 0;
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
            const sort = document.getElementById('sort-by').value;
            
            filteredData = allData.filter(item => {
                const matchesSearch = !search || item.product.toLowerCase().includes(search) || item.brand.toLowerCase().includes(search);
                const matchesSupermarket = !supermarket || item.supermarket === supermarket;
                const matchesCategory = !category || item.category === category;
                const matchesDiscount = item.discount >= minDiscount;
                const matchesPrice = item.currentPrice >= minPrice && item.currentPrice <= maxPrice;
                return matchesSearch && matchesSupermarket && matchesCategory && matchesDiscount && matchesPrice;
            });
            
            if (sort === 'discount-desc') {
                filteredData.sort((a, b) => b.discount - a.discount);
            } else if (sort === 'price-asc') {
                filteredData.sort((a, b) => a.currentPrice - b.currentPrice);
            }
            
            currentPage = 1;
            renderTable();
            updateStats();
            updatePagination();
        }
        
        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('supermarket-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('min-discount').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            document.getElementById('sort-by').value = '';
            applyFilters();
        }
        
        function renderTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            pageData.forEach(item => {
                const row = document.createElement('tr');
                
                const url = supermarketUrls[item.supermarket] || supermarketUrls[item.supermarket.trim()];
                if (url) {
                    row.style.cursor = 'pointer';
                    row.title = `Visit ${item.supermarket} website`;
                    row.onclick = () => window.open(url, '_blank');
                }
                
                row.innerHTML = `
                    <td>${item.supermarket || 'N/A'}</td>
                    <td>${item.product || 'N/A'}</td>
                    <td>${item.category || 'N/A'}</td>
                    <td>${item.brand || 'N/A'}</td>
                    <td>${item.originalPrice ? `${item.originalPrice} ${item.currency}` : 'N/A'}</td>
                    <td>${item.currentPrice ? `${item.currentPrice} ${item.currency}` : 'N/A'}</td>
                    <td>${item.discount ? `<span class="discount-badge">${item.discount}%</span>` : 'N/A'}</td>
                    <td>${item.promotion || 'N/A'}</td>
                    <td>${item.validUntil || 'N/A'}</td>
                `;
                
                if (item.discount && item.discount > 20) {
                    row.classList.add('highlight');
                }
                
                tableBody.appendChild(row);
            });
        }
        
        function updateStats() {
            document.getElementById('total-offers').textContent = filteredData.length;
            
            const discounts = filteredData.filter(item => item.discount).map(item => item.discount);
            const avgDiscount = discounts.length > 0 ? 
                Math.round(discounts.reduce((a, b) => a + b) / discounts.length) : 0;
            document.getElementById('avg-discount').textContent = `${avgDiscount}%`;
            
            const supermarkets = [...new Set(filteredData.map(item => item.supermarket).filter(Boolean))];
            document.getElementById('supermarket-count').textContent = supermarkets.length;
            
            const categories = [...new Set(filteredData.map(item => item.category).filter(Boolean))];
            document.getElementById('category-count').textContent = categories.length;
        }
        
        function toggleChart() {
            const container = document.getElementById('chart-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            if (chart) chart.destroy();
            const ctx = document.getElementById('stats-chart').getContext('2d');
            const discountRanges = {
                '0-10%': 0,
                '11-20%': 0,
                '21-30%': 0,
                '30+%': 0
            };
            filteredData.forEach(item => {
                if (item.discount <= 10) discountRanges['0-10%']++;
                else if (item.discount <= 20) discountRanges['11-20%']++;
                else if (item.discount <= 30) discountRanges['21-30%']++;
                else discountRanges['30+%']++;
            });
            chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(discountRanges),
                    datasets: [{ data: Object.values(discountRanges), backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0'] }]
                },
                options: { responsive: true }
            });
        }
        
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            if (totalPages <= 1) return;
            
            const prevButton = document.createElement('button');
            prevButton.textContent = 'â†';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    updatePagination();
                }
            };
            pagination.appendChild(prevButton);
            
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                if (i === currentPage) {
                    button.classList.add('active');
                }
                button.onclick = () => {
                    currentPage = i;
                    renderTable();
                    updatePagination();
                };
                pagination.appendChild(button);
            }
            
            const nextButton = document.createElement('button');
            nextButton.textContent = 'â†’';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    updatePagination();
                }
            };
            pagination.appendChild(nextButton);
        }
        
        function exportToCSV() {
            const headers = ['Supermarket', 'Product', 'Category', 'Brand', 'Original Price', 'Current Price', 'Discount', 'Promotion', 'Valid Until'];
            const csvData = [
                headers.join(','),
                ...filteredData.map(item => [
                    item.supermarket,
                    `"${item.product}"`,
                    item.category,
                    item.brand,
                    item.originalPrice,
                    item.currentPrice,
                    item.discount,
                    `"${item.promotion}"`,
                    item.validUntil
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'supermarket_offers.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>