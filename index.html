<!DOCTYPE html>
<html dir="rtl" lang="ar">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª - Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</title>
    <!-- External libs used by original file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"

defer="defer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"

defer="defer"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts for Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&amp;display=swap"

      rel="stylesheet">
    <style>
  :root{
    --primary-blue: #00539F;  /* Carrefour blue */
    --accent-orange: #FF6B00; /* Hyper Panda orange */
    --success-green: #28A745; /* Ok Market green */
    --warning-yellow: #FFC107;
    --danger-red: #DC3545;
    --info-teal: #17a2b8;
    --purple: #6f42c1;
    --pink: #e83e8c;
    --light-bg: #F8F9FA;
    --card-shadow: 0 8px 30px rgba(0,0,0,0.08);
    --border-radius: 16px;
    --transition: all 0.3s ease;
    
    --bg-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    --card-bg:#fff;
    --muted:#666;
    --accent:#4caf50;
    --danger:#ff4444;
    --gap:12px;
    --radius:12px;
    --text:#222;
    --control-height:46px;
    --base-font:15px;
    --ticker-bg:#0b3b6f;
    --ticker-text:#fff;
    --ticker-accent:#ffd54f;
    
    /* Dark mode variables */
    --dark-bg: #1a1a1a;
    --dark-card: #2d2d2d;
    --dark-text: #f0f0f0;
  }
  
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: 'Cairo', 'Segoe UI', Roboto, Arial, sans-serif;
    background: var(--light-bg);
    color:var(--text);
    padding:0;
    -webkit-font-smoothing:antialiased;
    line-height: 1.6;
  }
  
  .container{ max-width:1400px; margin:0 auto; padding:0 16px; }
  
  /* Hero Banner */
  .hero-banner {
    background: linear-gradient(rgba(0,83,159,0.85), rgba(0,83,159,0.75)), 
                url('https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-1.2.1&auto=format&fit=crop&w=1400&q=80');
    background-size: cover;
    background-position: center;
    color: white;
    padding: 40px 20px;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    position: relative;
    overflow: hidden;
  }
  
  .hero-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
    opacity: 0.3;
  }
  
  .hero-content {
    position: relative;
    z-index: 2;
  }
  
  .hero-banner h1 {
    margin: 0 0 10px 0;
    font-size: 2.5rem;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .hero-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
    margin-bottom: 25px;
  }
  
  /* Stats Dashboard - UPDATED: Horizontal layout */
  .stats-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin: 25px 0;
  }
  
  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    border: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 12px;
    min-height: 80px;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  }
  
  .stat-icon {
    font-size: 1.8rem;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
  }
  
  .stat-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex: 1;
    min-width: 0;
  }
  
  .stat-value {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 2px;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .stat-label {
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Quick Filter Chips - Colored */
  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
    padding: 10px 0;
  }
  
  .chip {
    padding: 10px 18px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 50px;
    font-family: 'Cairo', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
  }
  
  .chip::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: currentColor;
    opacity: 0;
    transition: var(--transition);
    z-index: 0;
  }
  
  .chip > * {
    position: relative;
    z-index: 1;
  }
  
  .chip:hover {
    border-color: currentColor;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .chip.active {
    color: white;
    border-color: transparent;
  }
  
  .chip.active::after {
    opacity: 1;
  }
  
  /* Specific chip colors */
  .chip[data-filter="all"] {
    color: var(--primary-blue);
  }
  .chip[data-filter="all"]::after {
    background: var(--primary-blue);
  }
  
  .chip[data-filter="hot"] {
    color: var(--danger-red);
  }
  .chip[data-filter="hot"]::after {
    background: var(--danger-red);
  }
  
  .chip[data-filter="ending"] {
    color: var(--warning-yellow);
  }
  .chip[data-filter="ending"]::after {
    background: var(--warning-yellow);
  }
  
  .chip[data-filter="discount"] {
    color: var(--success-green);
  }
  .chip[data-filter="discount"]::after {
    background: var(--success-green);
  }
  
  .chip[data-filter="carrefour"] {
    color: #004080;
  }
  .chip[data-filter="carrefour"]::after {
    background: #004080;
  }
  
  .chip[data-filter="hyperone"] {
    color: var(--accent-orange);
  }
  .chip[data-filter="hyperone"]::after {
    background: var(--accent-orange);
  }
  
  .chip[data-filter="food"] {
    color: var(--info-teal);
  }
  .chip[data-filter="food"]::after {
    background: var(--info-teal);
  }
  
  .chip[data-filter="recent"] {
    color: var(--purple);
  }
      
      
      
  .chip[data-filter="recent"]::after {
    background: var(--purple);
  }
  
  /* View Toggle - Updated with colors */
  .view-toggle {
    display: flex;
    background: white;
    border-radius: 12px;
    padding: 5px;
    width: fit-content;
    margin: 20px 0;
    box-shadow: var(--card-shadow);
    border: 1px solid #f0f0f0;
    overflow: hidden;
  }
  
  .view-btn {
    padding: 10px 20px;
    border: 2px solid #e0e0e0;
    background: white;
    font-family: 'Cairo', sans-serif;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--primary-blue);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }
  
  .view-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--primary-blue);
    opacity: 0;
    transition: var(--transition);
    z-index: 0;
  }
  
  .view-btn > * {
    position: relative;
    z-index: 1;
  }
  
  .view-btn:hover {
    border-color: var(--primary-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .view-btn.active {
    color: white;
    border-color: transparent;
  }
  
  .view-btn.active::after {
    opacity: 1;
  }
  
  /* Specific colors for view buttons */
  #view-grid-btn {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    border-right: none;
  }
  
  #view-table-btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    border-left: none;
  }
  
  /* Products Grid */
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
    margin: 25px 0;
  }
  
  .product-card {
    background: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    position: relative;
    border: 1px solid #f0f0f0;
  }
  
  .product-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
  }
  
  .product-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--danger-red);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    z-index: 2;
  }
  
  .product-image {
    height: 180px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }
  
  .product-image::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.05));
  }
  
  .product-image i {
    font-size: 4rem;
    color: rgba(0,0,0,0.1);
  }
  
  .product-info {
    padding: 20px;
  }
  
  .product-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0 0 10px 0;
    color: #333;
    height: 52px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  
  .product-unit {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .price-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 15px 0;
  }
  
  .current-price {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary-blue);
  }
  
  .discount-badge {
    background: var(--danger-red);
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 700;
  }
  
  .product-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
  }
  
  .supermarket-logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #555;
  }
  
  .countdown {
    background: rgba(255,107,0,0.1);
    color: var(--accent-orange);
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  
  .btn {
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    font-family: 'Cairo', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn-primary {
    background: var(--primary-blue);
    color: white;
  }
  
  .btn-primary:hover {
    background: #004080;
  }
  
  .btn-secondary {
    background: #f0f0f0;
    color: #555;
  }
  
  .btn-secondary:hover {
    background: #e0e0e0;
  }
  
  .favorite-btn {
    position: absolute;
    top: 15px;
    left: 15px;
    background: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #ccc;
    cursor: pointer;
    z-index: 2;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: var(--transition);
  }
  
  .favorite-btn:hover, .favorite-btn.active {
    color: var(--danger-red);
  }
  
  /* Ticker banner */
  .ticker-wrap{
    width:100%;
    background:var(--ticker-bg);
    color:var(--ticker-text);
    border-radius:10px;
    overflow:hidden;
    display:flex;
    align-items:center;
    padding:6px 12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    margin-top:8px;
  }
  .ticker-label{ 
    flex:0 0 auto; 
    font-weight:700; 
    margin-left:12px; 
    color:var(--ticker-accent); 
    background:rgba(255,255,255,0.1); 
    padding:6px 12px; 
    border-radius:8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .ticker-viewport{ flex:1 1 auto; overflow:hidden; position:relative; height:36px; display:flex; align-items:center; }
  .ticker-track{ display:inline-flex; white-space:nowrap; will-change:transform; align-items:center; gap:28px; }
  .ticker-item{ display:inline-flex; gap:12px; align-items:center; padding:6px 10px; background:transparent; color:var(--ticker-text); font-size:15px; }
  .ticker-item .badge{ background:var(--ticker-accent); color:#000; padding:4px 8px; border-radius:6px; font-weight:700; }
  
  .ticker-track.animate{ animation: ticker-scroll linear infinite; animation-duration: var(--ticker-duration, 18s); }
  @keyframes ticker-scroll {
    from { transform: translateX(0); }
    to { transform: translateX(-50%); }
  }
  
  /* Controls */
  .controls{ 
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--card-shadow);
    border: 1px solid #f0f0f0;
  }
  
  .controls .row{ 
    display:flex; 
    gap:12px; 
    align-items:center; 
    flex-wrap:wrap; 
    margin-bottom: 15px;
  }
  
  input,select,button{ 
    height:var(--control-height); 
    padding:0 16px; 
    border-radius:10px; 
    border:2px solid #e0e0e0; 
    background:white; 
    font-size:15px;
    font-family: 'Cairo', sans-serif;
    transition: var(--transition);
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(0,83,159,0.1);
  }
  
  #search-input {
    flex: 1;
    min-width: 200px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 16px;
    padding-right: 45px;
  }
  
  button{ 
    cursor:pointer; 
    font-weight: 600;
    background: var(--primary-blue);
    color: white;
    border: none;
  }
  
  button:hover {
    background: #004080;
  }
  
  #reset-btn {
    background: #f0f0f0;
    color: #666;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  #reset-btn:hover {
    background: #e0e0f0;
  }
  
  .price-controls{ 
    display:flex; 
    gap:8px; 
    align-items:center;
    background: #f8f9fa;
    padding: 5px;
    border-radius: 10px;
  }
  
  .price-controls button{ 
    width:36px; 
    height:36px; 
    padding:0; 
    font-size:18px; 
    line-height:1;
    background: white;
    color: #333;
    border: 1px solid #ddd;
  }
  
  .price-controls button:hover {
    background: #f0f0f0;
  }
  
  /* Table */
  #data-table{ 
    background:white; 
    border-radius:var(--border-radius); 
    box-shadow:var(--card-shadow); 
    overflow:hidden; 
    margin-top:20px; 
    padding:0;
    border: 1px solid #f0f0f0;
  }
  
  table{ 
    width:100%; 
    border-collapse:collapse; 
    font-size:14px; 
  }
  
  thead th{ 
    background:var(--primary-blue); 
    color:#fff; 
    padding:16px; 
    text-align:right; 
    position:sticky; 
    top:0; 
    font-weight: 600; 
    border-bottom: 2px solid rgba(255,255,255,0.1);
  }
  
  tbody td{ 
    padding:14px 16px; 
    border-bottom:1px solid #f0f0f0; 
  }
  
  tbody tr:hover { 
    background: #f8f9fa; 
  }
  
  .highlight{ 
    background:#fff3b0 !important; 
  }
  
  .card-list{ display:none }
  
  #loading{ 
    text-align:center; 
    padding:40px; 
    color:#666; 
    font-size:1.2rem; 
  }
  
  /* Autocomplete */
  #autocomplete-list{ 
    position:absolute; 
    z-index:9999; 
    background:white; 
    border-radius:8px; 
    box-shadow:0 6px 18px rgba(0,0,0,0.12); 
    max-height:240px; 
    overflow:auto;
    border: 1px solid #e0e0e0;
  }
  
  #autocomplete-list div {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: var(--transition);
  }
  
  #autocomplete-list div:hover {
    background: #f8f9fa;
  }
  
  /* Mobile Navigation */
  .mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 12px 16px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    z-index: 1000;
    justify-content: space-around;
    border-top: 1px solid #e0e0e0;
  }
  
  .mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #666;
    font-size: 0.8rem;
    gap: 5px;
  }
  
  .mobile-nav-item i {
    font-size: 1.2rem;
  }
  
  .mobile-nav-item.active {
    color: var(--primary-blue);
  }
  
  /* Comparison Panel */
  .comparison-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    z-index: 1001;
    padding: 20px;
    display: none;
    border-top: 3px solid var(--primary-blue);
  }
  
  .comparison-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .comparison-items {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 10px 0;
  }
  
  .comparison-item {
    min-width: 200px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e0e0e0;
  }
  
  /* Unit badge */
  .unit-badge {
    background: #e9ecef;
    color: #495057;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  /* Share button */
  .share-btn {
    position: absolute;
    bottom: 15px;
    left: 15px;
    background: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #666;
    cursor: pointer;
    z-index: 2;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: var(--transition);
  }
  
  .share-btn:hover {
    background: var(--primary-blue);
    color: white;
  }
  
  /* Compare button */
  .compare-btn {
    position: absolute;
    top: 65px;
    left: 15px;
    background: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #666;
    cursor: pointer;
    z-index: 2;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: var(--transition);
  }
  
  .compare-btn:hover {
    background: var(--success-green);
    color: white;
  }
  
  /* User Guide Banner */
  .user-guide-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 15px 0;
    text-align: center;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    animation: pulse 2s infinite;
  }
  
  .user-guide-banner i {
    font-size: 1.2rem;
  }
  
  /* Responsive */
  @media (max-width: 900px){
    .container {
      padding: 0 12px;
    }
    
    .hero-banner {
      padding: 30px 15px;
      margin-bottom: 20px;
    }
    
    .hero-banner h1 {
      font-size: 1.8rem;
    }
    
    .hero-subtitle {
      font-size: 1rem;
    }
    
    .stats-dashboard {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .products-grid {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
    }
    
    .controls .row {
      flex-direction: column;
      align-items: stretch;
    }
    
    #data-table {
      overflow-x: auto;
      display: block;
    }
    
    table {
      min-width: 800px;
    }
    
    .mobile-nav {
      display: flex;
    }
    
    .ticker-label{ display:none; }
    
    .user-guide-banner {
      font-size: 0.85rem;
      padding: 8px 12px;
    }
  }
  
  @media (max-width: 600px){
    .products-grid {
      grid-template-columns: 1fr;
    }
    
    .stat-card {
      padding: 12px 10px;
      gap: 10px;
      min-height: 70px;
    }
    
    .stat-icon {
      font-size: 1.5rem;
      width: 35px;
      height: 35px;
    }
    
    .stat-value {
      font-size: 1.2rem;
    }
    
    .stat-label {
      font-size: 0.75rem;
    }
    
    .filter-chips {
      overflow-x: auto;
      padding-bottom: 10px;
      flex-wrap: nowrap;
    }
    
    .chip {
      white-space: nowrap;
    }
    
    .view-btn {
      padding: 8px 12px;
      font-size: 0.9rem;
    }
    
    .stats-dashboard {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .user-guide-banner {
      font-size: 0.8rem;
      padding: 6px 10px;
    }
  }
  
  @media (max-width: 400px){
    .stats-dashboard {
      grid-template-columns: 1fr;
    }
    
    .stat-card {
      padding: 10px;
    }
  }
  
  /* Animation for discount badges */
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .discount-badge.pulse {
    animation: pulse 2s infinite;
  }
</style> </head>
  <body>
    <div class="container"> <!-- Hero Banner -->
      <div class="hero-banner">
        <div class="hero-content">
          <h1>ğŸ›’ Ø£ÙØ¶Ù„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
          <p class="hero-subtitle">Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨ÙŠÙ† ÙƒØ§Ø±ÙÙˆØ±ØŒ Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†ØŒ Ø³Ø¹ÙˆØ¯ÙŠ
            Ù…Ø§Ø±ÙƒØª ÙˆØºÙŠØ±Ù‡Ø§ - ÙˆÙØ± Ø­ØªÙ‰ 70%</p>
          <!-- Ticker banner -->
          <div class="ticker-wrap" aria-live="polite" aria-atomic="true" role="region"

            aria-label="Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶">
            <div class="ticker-label"><i class="fas fa-bolt"></i> Ø¹Ø±ÙˆØ¶ Ù…Ù…ÙŠØ²Ø©</div>
            <div class="ticker-viewport" id="ticker-viewport">
              <div class="ticker-track" id="ticker-track" aria-hidden="false">
                <div class="ticker-item">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- User Guide Banner -->
      <div class="user-guide-banner" id="user-guide"> <i class="fas fa-info-circle"></i>
        <span>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù†ØªØ¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„" Ù„Ø¹Ø±Ø¶
          Ø§Ù„Ø§ØµÙ†Ø§Ù ÙÙŠ Ø¬Ø¯ÙˆÙ„ - ÙˆØ²Ø±"Ø¹Ø±Ø¶ Ø´Ø¨ÙƒÙŠ" Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ </span> </div>
      <!-- Stats Dashboard -->
      <div class="stats-dashboard">
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-content">
            <div id="total-offers" class="stat-value">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“‰</div>
          <div class="stat-content">
            <div id="avg-discount" class="stat-value">0%</div>
            <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ”¥</div>
          <div class="stat-content">
            <div id="hot-deals" class="stat-value">0</div>
            <div class="stat-label">Ø¹Ø±ÙˆØ¶ Ø³Ø§Ø®Ù†Ø©</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â°</div>
          <div class="stat-content">
            <div id="ending-soon" class="stat-value">0</div>
            <div class="stat-label">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
          </div>
        </div>
        <!-- Changed from total-savings to total-supermarkets -->
        <div class="stat-card">
          <div class="stat-icon">ğŸ›’</div>
          <div class="stat-content">
            <div id="total-supermarkets" class="stat-value">0</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØ§Øª</div>
          </div>
        </div>
      </div>
      <!-- Quick Filter Chips -->
      <div class="filter-chips" id="filter-chips"> <button class="chip active"

          data-filter="all"><i class="fas fa-fire"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶</button> <button

          class="chip" data-filter="hot"><i class="fas fa-bolt"></i> Ø§Ù„Ø¹Ø±ÙˆØ¶
          Ø§Ù„Ø³Ø§Ø®Ù†Ø©</button> <button class="chip" data-filter="ending"><i class="fas fa-clock"></i>
          ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</button> <button class="chip" data-filter="discount"><i

            class="fas fa-percentage"></i> Ø®ØµÙˆÙ…Ø§Øª ÙƒØ¨ÙŠØ±Ø©</button> <button class="chip"

          data-filter="carrefour"><i class="fas fa-shopping-cart"></i> ÙƒØ§Ø±ÙÙˆØ±</button>
        <button class="chip" data-filter="hyperone"><i class="fas fa-store"></i>
          Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†</button> <button class="chip" data-filter="food"><i class="fas fa-utensils"></i>
          Ù…Ù†ØªØ¬Ø§Øª ØºØ°Ø§Ø¦ÙŠØ©</button> <button class="chip" data-filter="recent"><i class="fas fa-calendar-day"></i>
          Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ø¢Ø®Ø± ÙŠÙˆÙ…ÙŠÙ†)</button> </div>
      <!-- View Toggle -->
      <div class="view-toggle"> <button class="view-btn active" id="view-grid-btn"><i

            class="fas fa-th-large"></i> Ø¹Ø±Ø¶ Ø´Ø¨ÙƒÙŠ</button> <button class="view-btn"

          id="view-table-btn"><i class="fas fa-table"></i> Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„</button> </div>
      <!-- Products Grid -->
      <div class="products-grid" id="products-grid"></div>
      <!-- Controls -->
      <div class="controls" role="region" aria-label="Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…">
        <div class="row" style="flex:1;"> <input id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..."

            aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«" type="text">
          <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª">
            <option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
          </select>
          <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©">
            <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
          </select>
          <select id="brand-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©">
            <option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</option>
          </select>
        </div>
        <div class="row" style="width:100%; gap:8px;">
          <!-- Min price with controls -->
          <div class="price-controls" style="align-items:center;"> <button id="min-decrease"

              type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">âˆ’</button> <input id="min-price"

              placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5"

              min="0" type="number"> <button id="min-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰">+</button>
          </div>
          <!-- Max price with controls -->
          <div class="price-controls" style="align-items:center;"> <button id="max-decrease"

              type="button" aria-label="Ù†Ù‚Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">âˆ’</button> <input id="max-price"

              placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" step="0.5"

              min="0" type="number"> <button id="max-increase" type="button" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">+</button>
          </div>
          <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
            <option value="best-deals" selected="selected">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù…Ø±ÙƒØ¨)</option>
            <option value="discount-desc">Ø§Ù„Ø®ØµÙ… % - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="saved-desc">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆÙÙŠØ± - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± - ØªØµØ§Ø¹Ø¯ÙŠ</option>
            <option value="price-desc">Ø§Ù„Ø³Ø¹Ø± - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
            <option value="name-asc">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
            <option value="name-desc">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
          </select>
          <input id="min-discount" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…"

            type="number">
          <div style="display:flex;gap:8px;"> <button id="reset-btn" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†">ğŸ”„
              Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button> <button id="share-app" aria-label="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"><i

                class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ©</button> <button id="compare-mode-btn"

              aria-label="ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©"><i class="fas fa-balance-scale"></i>
              Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</button> </div>
        </div>
      </div>
      <!-- Data Table -->
      <div id="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
      <div id="data-table" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶" style="display:none;">
        <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶">
          <thead>
            <tr>
              <th>ğŸª Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
              <th>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</th>
              <th>ğŸ“¦ Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>ğŸ“‚ Ø§Ù„ÙØ¦Ø©</th>
              <th>ğŸ·ï¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
              <th>ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
              <th>ğŸ“‰ Ø§Ù„Ø®ØµÙ…</th>
              <th>ğŸ’° Ø§Ù„ØªÙˆÙÙŠØ±</th>
              <th>â° Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
            </tr>
          </thead>
          <tbody id="table-body">
          </tbody>
        </table>
        <div class="card-list" id="card-list" aria-hidden="true"></div>
        <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª"></div>
      </div>
    </div>
    <!-- Comparison Panel -->
    <div class="comparison-panel" id="comparison-panel">
      <div class="comparison-header">
        <h3 style="margin:0;"><i class="fas fa-balance-scale"></i> Ù…Ù‚Ø§Ø±Ù†Ø©
          Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (<span id="comparison-count">0</span>/4)</h3>
        <div> <button id="clear-comparison" style="margin-left:10px; background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
            <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ </button> <button id="close-comparison"

            style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">
            <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚ </button> </div>
      </div>
      <div class="comparison-items" id="comparison-items">
        <!-- Comparison items will be added here --> </div>
    </div>
    <!-- Mobile Navigation -->
    <div class="mobile-nav"> <a href="#" class="mobile-nav-item active"> <i class="fas fa-home"></i>
        <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span> </a> <a href="#" class="mobile-nav-item"> <i class="fas fa-percentage"></i>
        <span>Ø§Ù„Ø¹Ø±ÙˆØ¶</span> </a> <a href="#" class="mobile-nav-item"> <i class="fas fa-search"></i>
        <span>Ø¨Ø­Ø«</span> </a> <a href="#" class="mobile-nav-item"> <i class="fas fa-heart"></i>
        <span>Ø§Ù„Ù…ÙØ¶Ù„Ø©</span> </a> <a href="#" class="mobile-nav-item"> <i class="fas fa-user"></i>
        <span>Ø­Ø³Ø§Ø¨ÙŠ</span> </a> </div>
    <script>
/* ================= Configuration ================= */
const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
const CACHE_KEY = 'offersData';
const CACHE_EXPIRY = 3600000; // 1 hour

// Weight constants for combined sorting
const WEIGHT_DISCOUNT = 0.6;  // 60% importance to discount percentage
const WEIGHT_SAVINGS = 0.4;   // 40% importance to savings amount
/* ================================================= */

let allData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;
let debounceTimer = null;
let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
let comparisonItems = JSON.parse(localStorage.getItem('comparison')) || [];
let currentView = 'grid';
let activeChipFilter = 'all'; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù†Ø´Ø· Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
let latestTwoDates = []; // Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ®ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
let supermarketFilterCache = {}; // Ù„Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ ÙÙ„ØªØ± Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª

/* Initialize the app */
      
function normalizeDate(d){
  if (!d) return null;

  // Excel serial number
  if (typeof d === 'number') {
    return new Date(Math.round((d - 25569) * 86400 * 1000));
  }

  // String or Date
  const parsed = new Date(d);
  return isNaN(parsed.getTime()) ? null : parsed;
}
      
      
function initApp() {
  try {
    wireEventListeners();
    fetchData();
  } catch (error) {
    console.error('Error in initApp:', error);
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ' + error.message);
  }
}

/* Wire all event listeners */
function wireEventListeners() {
  try {
    // View toggle
    document.getElementById('view-grid-btn').addEventListener('click', () => switchView('grid'));
    document.getElementById('view-table-btn').addEventListener('click', () => switchView('table'));
    
    // Filter chips - MODIFIED to handle sorting for hot and discount
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', function() {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        activeChipFilter = this.dataset.filter;
        
        // If it's hot or discount filter, set the sort type
        if (activeChipFilter === 'hot') {
          document.getElementById('sort-by').value = 'saved-desc'; // Sort by biggest discount value
        } else if (activeChipFilter === 'discount') {
          document.getElementById('sort-by').value = 'discount-desc'; // Sort by biggest discount percentage
        }
        
        applyAllFilters();
      });
    });
    
    // Rest of the code remains the same...
  } catch (error) {
    console.error('Error in wireEventListeners:', error);
  }
}

/* Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ®ÙŠÙ† Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
function findLatestTwoDates(data) {
  try {
    const allDates = [];
    
    data.forEach(item => {
      let dateFound = null;
      
      if (item.updateDate) {
        dateFound = item.updateDate;
      }
      else if (item.endDate) {
        dateFound = item.endDate;
      }
      else if (item.validUntil && item.validUntil !== 'ØºÙŠØ± Ù…ØªØ§Ø­') {
        const parsedDate = parseEndDate(item.validUntil);
        if (parsedDate) {
          dateFound = parsedDate;
        }
      }
      
      if (dateFound && dateFound instanceof Date && !isNaN(dateFound.getTime())) {
        const year = dateFound.getFullYear();
        const month = String(dateFound.getMonth() + 1).padStart(2, '0');
        const day = String(dateFound.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        allDates.push({
          date: dateFound,
          dateStr: dateStr,
          item: item
        });
      }
    });
    
    if (allDates.length === 0) return [];
    
    allDates.sort((a, b) => b.date - a.date);
    
    const uniqueDateStrs = [];
    const uniqueDates = [];
    
    for (const dateObj of allDates) {
      if (!uniqueDateStrs.includes(dateObj.dateStr)) {
        uniqueDateStrs.push(dateObj.dateStr);
        uniqueDates.push(dateObj.dateStr);
      }
      
      if (uniqueDates.length >= 2) break;
    }
    
    console.log('Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ®ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', uniqueDates);
    console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨ØªØ§Ø±ÙŠØ®:', allDates.length);
    
    return uniqueDates;
  } catch (error) {
    console.error('Error in findLatestTwoDates:', error);
    return [];
  }
}

/* Comparison Mode */
function toggleComparisonPanel() {
  try {
    const panel = document.getElementById('comparison-panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    updateComparisonPanel();
  } catch (error) {
    console.error('Error in toggleComparisonPanel:', error);
  }
}

function closeComparisonPanel() {
  try {
    document.getElementById('comparison-panel').style.display = 'none';
  } catch (error) {
    console.error('Error in closeComparisonPanel:', error);
  }
}

function toggleComparison(productId) {
  try {
    const product = allData.find(p => p.product === productId);
    if (!product) return;
    
    const index = comparisonItems.findIndex(i => i.product === productId);
    if (index === -1) {
      if (comparisonItems.length >= 4) {
        alert('ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù‚Ø§Ø±Ù†Ø© 4 Ù…Ù†ØªØ¬Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰');
        return;
      }
      comparisonItems.push(product);
    } else {
      comparisonItems.splice(index, 1);
    }
    
    localStorage.setItem('comparison', JSON.stringify(comparisonItems));
    updateComparisonPanel();
    
    document.querySelectorAll(`.compare-btn[data-id="${productId}"]`).forEach(btn => {
      btn.classList.toggle('active', index === -1);
    });
  } catch (error) {
    console.error('Error in toggleComparison:', error);
  }
}

function clearComparison() {
  try {
    comparisonItems = [];
    localStorage.setItem('comparison', JSON.stringify(comparisonItems));
    updateComparisonPanel();
    
    document.querySelectorAll('.compare-btn').forEach(btn => {
      btn.classList.remove('active');
    });
  } catch (error) {
    console.error('Error in clearComparison:', error);
  }
}

function updateComparisonPanel() {
  try {
    const panel = document.getElementById('comparison-panel');
    const itemsContainer = document.getElementById('comparison-items');
    const countElement = document.getElementById('comparison-count');
    
    countElement.textContent = comparisonItems.length;
    
    itemsContainer.innerHTML = '';
    
    comparisonItems.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'comparison-item';
      itemEl.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <h4 style="margin: 0 0 10px 0; font-size: 0.9rem;">${item.product || ''}</h4>
          <button onclick="removeFromComparison('${item.product}')" style="background: none; border: none; color: #dc3545; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">${item.supermarket || ''}</div>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <span style="font-weight: 700; color: var(--primary-blue);">${item.currentPrice || 0} ${item.currency||'EGP'}</span>
        </div>
        ${item._discount_pct ? `<div style="background: var(--danger-red); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-align: center;">Ø®ØµÙ… ${item._discount_pct}%</div>` : ''}
      `;
      itemsContainer.appendChild(itemEl);
    });
    
    if (comparisonItems.length > 0) {
      panel.style.display = 'block';
    }
  } catch (error) {
    console.error('Error in updateComparisonPanel:', error);
  }
}

function removeFromComparison(productId) {
  try {
    comparisonItems = comparisonItems.filter(item => item.product !== productId);
    localStorage.setItem('comparison', JSON.stringify(comparisonItems));
    updateComparisonPanel();
    
    document.querySelectorAll(`.compare-btn[data-id="${productId}"]`).forEach(btn => {
      btn.classList.remove('active');
    });
  } catch (error) {
    console.error('Error in removeFromComparison:', error);
  }
}

/* Switch between grid and table view */
function switchView(view) {
  try {
    currentView = view;
    const gridBtn = document.getElementById('view-grid-btn');
    const tableBtn = document.getElementById('view-table-btn');
    const productsGrid = document.getElementById('products-grid');
    const dataTable = document.getElementById('data-table');
    
    gridBtn.classList.toggle('active', view === 'grid');
    tableBtn.classList.toggle('active', view === 'table');
    
    if (view === 'grid') {
      productsGrid.style.display = 'grid';
      dataTable.style.display = 'none';
      renderProductsGrid();
    } else {
      productsGrid.style.display = 'none';
      dataTable.style.display = 'block';
      renderTable();
    }
  } catch (error) {
    console.error('Error in switchView:', error);
  }
}

/* Apply ALL filters together - UPDATED with improved combined sorting */
/* Apply ALL filters together - UPDATED with improved combined sorting */
function applyAllFilters() {
  try {
    const search = (document.getElementById('search-input').value || '').trim().toLowerCase();
    const supermarket = document.getElementById('supermarket-filter').value || '';
    const category = document.getElementById('category-filter').value || '';
    const brand = document.getElementById('brand-filter').value || '';
    const minDiscount = parseFloat(document.getElementById('min-discount').value) || 0;
    const minPriceRaw = document.getElementById('min-price').value;
    const maxPriceRaw = document.getElementById('max-price').value;
    const minPrice = minPriceRaw === '' ? 0 : (parseFloat(minPriceRaw) || 0);
    const maxPrice = maxPriceRaw === '' ? Infinity : (parseFloat(maxPriceRaw) || Infinity);
    const sort = document.getElementById('sort-by').value || 'best-deals';

    if(isFinite(minPrice) && isFinite(maxPrice) && minPrice > maxPrice){
      const tmp = document.getElementById('min-price').value;
      document.getElementById('min-price').value = document.getElementById('max-price').value;
      document.getElementById('max-price').value = tmp;
    }

    filteredData = allData.filter(item => {
      try {
        if (activeChipFilter !== 'all') {
          let chipFilterPass = false;
          switch(activeChipFilter) {
            case 'hot':
              // REMOVED: chipFilterPass = item._discount_pct > 30;
              // Now we just return true and let sorting handle it
              chipFilterPass = true;
              break;
            case 'ending':
              if (item.endDate) {
                const now = new Date();
                const diffDays = Math.ceil((item.endDate - now) / (1000 * 60 * 60 * 24));
                chipFilterPass = diffDays <= 3 && diffDays >= 0;
              }
              break;
            case 'discount':
              // REMOVED: chipFilterPass = item._discount_pct > 50;
              // Now we just return true and let sorting handle it
              chipFilterPass = true;
              break;
            case 'food':
              if (item.category) {
                const category = String(item.category || '').trim().toLowerCase();
                chipFilterPass = category.includes('Ø·Ø¹Ø§Ù…') || 
                                category.includes('ØºØ°Ø§Ø¦') ||
                                category.includes('Ø£Ø·Ø¹Ù…Ø©') ||
                                category.includes('Ù…Ø£ÙƒÙˆÙ„Ø§Øª');
              }
              break;
            case 'recent':
              if (latestTwoDates.length === 0) {
                chipFilterPass = false;
              } else {
                let itemDate = null;
                
                if (item.updateDate) {
                  itemDate = item.updateDate;
                }
                else if (item.endDate) {
                  itemDate = item.endDate;
                }
                else if (item.validUntil && item.validUntil !== 'ØºÙŠØ± Ù…ØªØ§Ø­') {
                  itemDate = parseEndDate(item.validUntil);
                }
                
                if (itemDate) {
                  const year = itemDate.getFullYear();
                  const month = String(itemDate.getMonth() + 1).padStart(2, '0');
                  const day = String(itemDate.getDate()).padStart(2, '0');
                  const itemDateStr = `${year}-${month}-${day}`;
                  
                  chipFilterPass = latestTwoDates.includes(itemDateStr);
                } else {
                  chipFilterPass = false;
                }
              }
              break;
              
try {
    filteredItems = allItems.filter(item => {
        let chipFilterPass = true;

        switch (activeChipFilter) {

case 'recent_extended': {

    if (!latestTwoDates || latestTwoDates.length === 0) {
        return false;
    }

    const newestRaw = new Date(const newestRaw = new Date(latestTwoDates.at(-1));
);
    if (isNaN(newestRaw)) return false;

    const newestDate = stripTime(newestRaw);

    let itemDate = null;
    if (item.updateDate) itemDate = normalizeDate(item.updateDate);
    else if (item.endDate) itemDate = normalizeDate(item.endDate);
    else if (item.validUntil && item.validUntil !== 'ØºÙŠØ± Ù…ØªØ§Ø­') {
        itemDate = normalizeDate(parseEndDate(item.validUntil));
    }

    if (!itemDate) return false;

    itemDate = stripTime(itemDate);

    const diffDays =
      (newestDate - itemDate) / (1000 * 60 * 60 * 24);

    // âœ… Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… Ø­Ù‚ÙŠÙ‚ÙŠØ©
    return diffDays >= 0 && diffDays <= 7;
}


                   
              case 'recent_day':
              // Logic: Check if item is within 1 days of the newest date in the dataset
              if (latestTwoDates.length === 0) {
                 chipFilterPass = false;
              } else {
                 // Get the newest date from your existing logic (first item in latestTwoDates)
                 const newestDateInDB2 = new Date(latestTwoDates[0]);
                 let itemDate = null;
                 // Extract date from item (same logic as above)
                 if (item.updateDate) itemDate = item.updateDate;
                 else if (item.endDate) itemDate = item.endDate;
                 else if (item.validUntil && item.validUntil !== 'ØºÙŠØ± Ù…ØªØ§Ø­') itemDate = parseEndDate(item.validUntil);
                 if (itemDate && !isNaN(newestDateInDB2.getTime())) {
                    // Calculate difference in days
                 const diffTime = newestDateInDB2 - itemDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    
                    // Pass if within 1 days
                    chipFilterPass = diffDays <= 1;
                 } else {
                    chipFilterPass = false;
                 }
              }
              break;
                
              
            case 'carrefour':
              if (!supermarketFilterCache.carrefour) {
                supermarketFilterCache.carrefour = allData.filter(i => {
                  const carrefourName = String(i.supermarket || '').toLowerCase();
                  return carrefourName.includes('ÙƒØ§Ø±ÙÙˆØ±') || 
                         carrefourName.includes('carrefour');
                }).map(i => i.product);
              }
              chipFilterPass = supermarketFilterCache.carrefour.includes(item.product);
              break;
            case 'hyperone':
              if (!supermarketFilterCache.hyperone) {
                supermarketFilterCache.hyperone = allData.filter(i => {
                  const hyperoneName = String(i.supermarket || '').toLowerCase();
                  return hyperoneName.includes('Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†') || 
                         hyperoneName.includes('Ù‡Ø§ÙŠØ¨Ø±ÙˆØ§Ù†') ||
                         hyperoneName.includes('Ù‡Ø§ÙŠØ¨Ø±') ||
                         hyperoneName.includes('hyper one') ||
                         hyperoneName.includes('hyperone') ||
                         hyperoneName.includes('hyper');
                }).map(i => i.product);
              }
              chipFilterPass = supermarketFilterCache.hyperone.includes(item.product);
              break;
            default:
              chipFilterPass = true;
          }
          if (!chipFilterPass) return false;
        }
        
        // Rest of the filtering logic remains the same...
        const prod = String(item.product || '').toLowerCase();
        const primary = String(item.primaryName || '').toLowerCase();
        const itemBrand = String(item.brand || '').toLowerCase();
        
        if (supermarket && String(item.supermarket || '') !== supermarket) return false;
        
        if (category && String(item.category || '') !== category) return false;
        
        if (brand && String(item.brand || '') !== brand) return false;
        
        const priceVal = Number(item.currentPrice) || 0;
        if (priceVal < minPrice || priceVal > maxPrice) return false;
        
        if ((item._discount_pct||0) < minDiscount) return false;
        
        if (search && !prod.includes(search) && !primary.includes(search) && 
            !itemBrand.includes(search) && !String(item.supermarket || '').toLowerCase().includes(search)) {
          return false;
        }
        
        return true;
      } catch (filterError) {
        console.error('Error filtering item:', filterError, item);
        return false;
      }
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨ - UPDATED with improved combined sorting
    // The sorting logic remains the same, it will use the sort value set by the chips
    
    // ... rest of the sorting code remains the same


    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨ - UPDATED with improved combined sorting
    if(sort === 'best-deals') {
      // Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶: Ù…Ø²ÙŠØ¬ Ù…Ø±Ø¬Ø­ Ù…Ù† Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù†Ø³Ø¨ÙŠ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆÙÙŠØ±
      const maxSavings = Math.max(...filteredData.map(i => i._saved || 0), 500);
      
      filteredData.sort((a,b)=> {
        // Normalize discount percentage (0-100%)
        const discountA = Math.min((a._discount_pct || 0), 100) / 100;
        const discountB = Math.min((b._discount_pct || 0), 100) / 100;
        
        // Normalize savings amount
        const savedA = (a._saved || 0) / maxSavings;
        const savedB = (b._saved || 0) / maxSavings;
        
        // Calculate weighted scores
        const scoreA = (discountA * WEIGHT_DISCOUNT) + (savedA * WEIGHT_SAVINGS);
        const scoreB = (discountB * WEIGHT_DISCOUNT) + (savedB * WEIGHT_SAVINGS);
        
        // Sort by combined score (descending)
        const scoreDiff = scoreB - scoreA;
        if (Math.abs(scoreDiff) > 0.0001) {
          return scoreDiff;
        }
        
        // If scores are very close, prioritize higher discount
        const discountDiff = discountB - discountA;
        if (Math.abs(discountDiff) > 0.01) {
          return discountDiff;
        }
        
        // Finally, sort alphabetically
        const nameA = String(a.product || '');
        const nameB = String(b.product || '');
        return nameA.localeCompare(nameB, 'ar');
      });
    } else if(sort === 'discount-desc') {
      filteredData.sort((a,b)=> (b._discount_pct||0)-(a._discount_pct||0));
    } else if(sort === 'saved-desc') {
      filteredData.sort((a,b)=> (b._saved||0)-(a._saved||0));
    } else if(sort === 'price-asc') {
      filteredData.sort((a,b)=> (a.currentPrice||0)-(b.currentPrice||0));
    } else if(sort === 'price-desc') {
      filteredData.sort((a,b)=> (b.currentPrice||0)-(a.currentPrice||0));
    } else if(sort === 'name-asc') {
      filteredData.sort((a,b)=> {
        const nameA = String(a.product || '');
        const nameB = String(b.product || '');
        return nameA.localeCompare(nameB, 'ar');
      });
    } else if(sort === 'name-desc') {
      filteredData.sort((a,b)=> {
        const nameA = String(a.product || '');
        const nameB = String(b.product || '');
        return nameB.localeCompare(nameA, 'ar');
      });
    }

    currentPage = 1;
    renderContent();
    updateStats();
  } catch (error) {
    console.error('Error in applyAllFilters:', error);
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±: ' + error.message);
  }
}

/* Share app */
function shareApp() {
  try {
    if (navigator.share) {
      navigator.share({
        title: 'Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª',
        text: 'Ø§ÙƒØªØ´Ù Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ØªØ®ÙÙŠØ¶Ø§Øª Ù…Ù† ÙƒØ§Ø±ÙÙˆØ± ÙˆÙ‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù† ÙˆØ³Ø¹ÙˆØ¯ÙŠ Ù…Ø§Ø±ÙƒØª!',
        url: window.location.href,
      });
    } else {
      navigator.clipboard.writeText(window.location.href);
      alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ø§Ù„Ø¢Ù†.');
    }
  } catch (error) {
    console.error('Error in shareApp:', error);
  }
}

/* Debounce helper */
function debounce(fn, wait=250){
  return function(...args){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>fn.apply(this,args), wait);
  };
}

/* Date parsing helpers */
function parseEndDate(period){
  try {
    if (!period) return null;
    const s = String(period);
    const parts = s.split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).map(p=>p.trim()).filter(Boolean);
    let candidate = parts.length>1 ? parts[parts.length-1] : parts[0];
    candidate = candidate.replace(/^(Ù…Ù†|Ø¥Ù„Ù‰|Ø­ØªÙ‰)\s*/i,'').trim();
    let d = new Date(candidate);
    if (isNaN(d)) {
      const dm = candidate.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/);
      if (dm){
        let day=dm[1].padStart(2,'0'), month=dm[2].padStart(2,'0'), year=dm[3];
        if (year.length===2) year='20'+year;
        d = new Date(`${year}-${month}-${day}`);
      } else {
        const ym = candidate.match(/(\d{4})[\/\.-](\d{1,2})[\/\.-](\d{1,2})/);
        if (ym) d = new Date(`${ym[1]}-${ym[2].padStart(2,'0')}-${ym[3].padStart(2,'0')}`);
      }
    }
    return (d instanceof Date && !isNaN(d.getTime())) ? d : null;
  } catch (error) {
    console.error('Error in parseEndDate:', error, period);
    return null;
  }
}

function isValidDate(d){ 
  try {
    return d instanceof Date && !isNaN(d.getTime()); 
  } catch {
    return false;
  }
}

function formatDateShort(d){ 
  try {
    if(!isValidDate(d)) return 'ØºÙŠØ± Ù…ØªØ§Ø­'; 
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); 
    return `${y}-${m}-${day}`;
  } catch {
    return 'ØºÙŠØ± Ù…ØªØ§Ø­';
  }
}

/* Compute saved & discount */
function computeSavedAndDiscount(arr){
  try {
    arr.forEach(item=>{


      const orig = Number(item.originalPrice) || 0;
      const curr = Number(item.currentPrice) || 0;
      let saved = 0;
      if (orig>0 && curr>0) saved = orig - curr;
      else if (orig>0 && item.discount) saved = orig * (Number(item.discount)/100);
      else if (curr>0 && item.discount) saved = curr * (Number(item.discount)/100);
      item._saved = Math.max(0, Number((saved||0).toFixed(2)));
      item._discount_pct = (item.discount && !isNaN(item.discount)) ? Number(item.discount) : (orig>0 && curr>0 ? Math.round(((orig-curr)/orig)*100) : 0);
    });
  } catch (error) {
    console.error('Error in computeSavedAndDiscount:', error);
  }
}

function computeCombinedScore(arr){
  try {
    if(!arr || !arr.length) return;
    const savedVals = arr.map(i=>i._saved||0), pctVals = arr.map(i=>i._discount_pct||0);
    const maxSaved = Math.max(...savedVals,0), minSaved = Math.min(...savedVals,0);
    const maxPct = Math.max(...pctVals,0), minPct = Math.min(...pctVals,0);
    const savedRange = (maxSaved - minSaved) || 1;
    const pctRange = (maxPct - minPct) || 1;
    arr.forEach(item=>{
      const ns = ((item._saved||0)-minSaved)/savedRange;
      const np = ((item._discount_pct||0)-minPct)/pctRange;
      item._score = Math.max(ns, np);
    });
  } catch (error) {
    console.error('Error in computeCombinedScore:', error);
  }
}

/* Ticker: populate top discounted items and animate */
function populateTicker(){
  try {
    const track = document.getElementById('ticker-track');
    track.innerHTML = '';
    const maxSavings = Math.max(...allData.map(i => i._saved || 0), 500);
    
    const top = [...allData].filter(i=>i._discount_pct>0).sort((a,b)=>{
      // Use combined weighted score for ticker
      const discountA = Math.min((a._discount_pct || 0), 100) / 100;
      const discountB = Math.min((b._discount_pct || 0), 100) / 100;
      
      const savedA = (a._saved || 0) / maxSavings;
      const savedB = (b._saved || 0) / maxSavings;
      
      const scoreA = (discountA * WEIGHT_DISCOUNT) + (savedA * WEIGHT_SAVINGS);
      const scoreB = (discountB * WEIGHT_DISCOUNT) + (savedB * WEIGHT_SAVINGS);
      
      return scoreB - scoreA;
    }).slice(0,12);

    if(!top.length){
      track.innerHTML = '<div class="ticker-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ù…ÙŠØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
      return;
    }

    const supermarketIcons = {
      'ÙƒØ§Ø±ÙÙˆØ±': 'ğŸ›’',
      'Ù‡Ø§ÙŠØ¨Ø± ÙˆØ§Ù†': 'ğŸª',
      'Ù‡Ø§ÙŠØ¨Ø±': 'ğŸª',
      'Ø³Ø¹ÙˆØ¯ÙŠ': 'ğŸ›ï¸',
      'Ø³ÙˆØ¨Ø±': 'ğŸ¬',
      'Ù…Ø§Ø±ÙƒØª': 'ğŸª'
    };

    const fragment = document.createDocumentFragment();
    top.forEach(item=>{
      const el = document.createElement('div');
      el.className = 'ticker-item';
      const name = String(item.product || 'Ù…Ù†ØªØ¬');
      const market = String(item.supermarket || '');
      const discount = item._discount_pct ? `${item._discount_pct}%` : '';
      const saved = item._saved ? `${item._saved} ${item.currency||'EGP'}` : '';
      
      let icon = 'ğŸ·ï¸';
      for (const [key, value] of Object.entries(supermarketIcons)) {
        if (market.includes(key)) {
          icon = value;
          break;
        }
      }
      
      el.innerHTML = `<span class="badge">${discount}</span> <span>${icon} ${name}</span> <span style="opacity:.85">â€” ${market}</span> <span style="color:var(--ticker-accent); margin-inline-start:8px;">ÙˆÙØ± ${saved}</span>`;
      fragment.appendChild(el);
    });

    track.appendChild(fragment.cloneNode(true));
    track.appendChild(fragment.cloneNode(true));

    requestAnimationFrame(()=>{
      const viewport = document.getElementById('ticker-viewport');
      const trackWidth = track.scrollWidth;
      const viewportWidth = viewport.clientWidth || 600;
      const speed = 80;
      const duration = Math.max(8, Math.round(trackWidth / speed));
      track.style.setProperty('--ticker-duration', duration + 's');
      track.classList.add('animate');
    });
  } catch (error) {
    console.error('Error in populateTicker:', error);
  }
}

/* Render products grid */
function renderProductsGrid() {
  try {
    const grid = document.getElementById('products-grid');
    grid.innerHTML = '';
    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
    
    const start = (currentPage-1)*itemsPerPage;
    const pageData = filteredData.slice(start, start+itemsPerPage);
    
    if (pageData.length === 0) {
      grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
          <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
          <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø©</h3>
          <p>Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØµØ·Ù„Ø­Ø§Øª Ø¨Ø­Ø« Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø¥Ø²Ø§Ù„Ø© Ø¨Ø¹Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ±</p>
          ${activeChipFilter === 'recent' ? '<p style="color: var(--purple); margin-top: 10px;"><i class="fas fa-info-circle"></i> Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙ„ØªØ± "Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±ÙˆØ¶" ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ®ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>' : ''}
        </div>
      `;
      return;
    }
    
    pageData.forEach(item => {
      try {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        const isFavorite = favorites.includes(item.product);
        const isInComparison = comparisonItems.some(i => i.product === item.product);
        
        let productIcon = 'fa-box';
        if (item.category) {
          const category = String(item.category || '').toLowerCase();
          if (category.includes('ØºØ°Ø§Ø¦ÙŠ') || category.includes('Ø·Ø¹Ø§Ù…')) productIcon = 'fa-utensils';
          else if (category.includes('Ù…Ø´Ø±ÙˆØ¨')) productIcon = 'fa-wine-bottle';
          else if (category.includes('ØªÙ†Ø¸ÙŠÙ')) productIcon = 'fa-soap';
          else if (category.includes('ØµØ­ÙŠ')) productIcon = 'fa-heart';
        }
        
        let countdownHtml = '';
        if (item.endDate) {
          const now = new Date();
          const diffDays = Math.ceil((item.endDate - now) / (1000 * 60 * 60 * 24));
          if (diffDays <= 7 && diffDays >= 0) {
            countdownHtml = `<div class="countdown"><i class="fas fa-clock"></i> ${diffDays} ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ</div>`;
          }
        }
        
        let marketIcon = 'fa-store';
        if (item.supermarket) {
          const market = String(item.supermarket || '').toLowerCase();
          if (market.includes('ÙƒØ§Ø±ÙÙˆØ±')) marketIcon = 'fa-shopping-cart';
          else if (market.includes('Ù‡Ø§ÙŠØ¨Ø±')) marketIcon = 'fa-store-alt';
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© "Ø¬Ø¯ÙŠØ¯" Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
        let newBadge = '';
        if (activeChipFilter === 'recent' && (item.updateDate || item.endDate)) {
          newBadge = '<div class="product-badge" style="background: var(--purple);"><i class="fas fa-star"></i> Ø­Ø¯ÙŠØ«</div>';
        }
        
        // Add "Best Deal" badge for top combined offers
        let bestDealBadge = '';
        const sortBy = document.getElementById('sort-by').value;
        if (sortBy === 'best-deals' && pageData.indexOf(item) < 3 && (item._discount_pct > 30 || item._saved > 20)) {
          bestDealBadge = '<div class="product-badge" style="background: linear-gradient(135deg, #FF6B00, #FF0000);"><i class="fas fa-crown"></i> Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶</div>';
        }
        
        card.innerHTML = `
          ${bestDealBadge}
          ${item._discount_pct > 50 ? '<div class="product-badge"><i class="fas fa-fire"></i> Ø¹Ø±ÙˆØ¶ Ø³Ø§Ø®Ù†Ø©</div>' : ''}
          ${newBadge}
          <div class="favorite-btn ${isFavorite ? 'active' : ''}" data-id="${item.product}">
            <i class="fas fa-heart"></i>
          </div>
          <div class="compare-btn ${isInComparison ? 'active' : ''}" data-id="${item.product}">
            <i class="fas fa-balance-scale"></i>
          </div>
          <div class="share-btn" title="Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶">
            <i class="fas fa-share-alt"></i>
          </div>
          <div class="product-image">
            <i class="fas ${productIcon}"></i>
          </div>
          <div class="product-info">
            <h3 class="product-title">${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</h3>
            ${item.primaryName ? `<div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">${item.primaryName}</div>` : ''}
            ${item.unit ? `<div class="product-unit"><i class="fas fa-weight"></i> ${item.unit}</div>` : ''}
            <div class="price-container">
              <div style="display: flex; flex-direction: column; gap: 3px;">
                <span class="current-price">${item.currentPrice ? `${item.currentPrice} ${item.currency||'EGP'}` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</span>
                ${item._saved > 0 ? `<span style="font-size: 0.9rem; color: var(--success-green); font-weight: 600;"><i class="fas fa-coins"></i> ÙˆÙØ± ${item._saved} ${item.currency||'EGP'}</span>` : ''}
              </div>
              ${item._discount_pct ? `<span class="discount-badge pulse">-${item._discount_pct}%</span>` : ''}
            </div>
            <div class="product-meta">
              <div class="supermarket-logo">
                <i class="fas ${marketIcon}"></i>
                <span>${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</span>
              </div>
              ${countdownHtml}
            </div>
            ${activeChipFilter === 'recent' && (item.updateDate || item.endDate) ? `
              <div style="font-size: 0.8rem; color: var(--purple); margin-top: 10px; padding: 5px; background: rgba(111, 66, 193, 0.1); border-radius: 5px;">
                <i class="fas fa-calendar-alt"></i> ${item.updateDate ? `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${formatDateShort(item.updateDate)}` : `ØªÙ†ØªÙ‡ÙŠ: ${item.validUntil}`}
              </div>
            ` : ''}
            <div class="action-buttons">
              <button class="btn btn-secondary view-details-btn" data-id="${item.product}">
                <i class="fas fa-eye"></i> ØªÙØ§ØµÙŠÙ„
              </button>
              <button class="btn btn-primary buy-now-btn" data-id="${item.product}">
                <i class="fas fa-shopping-cart"></i> Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†
              </button>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      } catch (itemError) {
        console.error('Error rendering product card:', itemError, item);
      }
    });
    
    attachCardEventListeners();
    updatePagination();
  } catch (error) {
    console.error('Error in renderProductsGrid:', error);
  }
}

function attachCardEventListeners() {
  try {
    document.querySelectorAll('.favorite-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const productId = this.dataset.id;
        toggleFavorite(productId);
        this.classList.toggle('active');
      });
    });
    
    document.querySelectorAll('.compare-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const productId = this.dataset.id;
        toggleComparison(productId);
        this.classList.toggle('active');
      });
    });
    
    document.querySelectorAll('.view-details-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const productId = this.dataset.id;
        const product = allData.find(p => p.product === productId);
        if (product) {
          let details = `
            <strong>Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„ÙÙ„Ø§ÙŠØ±:</strong> ${product.pageNo || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${product.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</strong> ${product.primaryName || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„ÙˆØ­Ø¯Ø©:</strong> ${product.unit || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª:</strong> ${product.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„ÙØ¦Ø©:</strong> ${product.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©:</strong> ${product.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> ${product.currentPrice ? `${product.currentPrice} ${product.currency||'EGP'}` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„Ø®ØµÙ…:</strong> ${product._discount_pct ? `${product._discount_pct}%` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø§Ù„ØªÙˆÙÙŠØ±:</strong> ${product._saved ? `${product._saved} ${product.currency||'EGP'}` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            <strong>Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰:</strong> ${product.validUntil || 'ØºÙŠØ± Ù…ØªØ§Ø­'}<br>
            ${product.updateDate ? `<strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«:</strong> ${formatDateShort(product.updateDate)}<br>` : ''}
          `;
          alert(details);
        }
      });
    });
    
    document.querySelectorAll('.buy-now-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const productId = this.dataset.id;
        const product = allData.find(p => p.product === productId);
        if (product && product.solution_key) {
          const url = `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(product.solution_key)}&c=eg`;

//          alert (product.pageNo || 'producttttttttt');
  //        alert (item.pageNo || 'itemmmmmmmm');
//          const flyerCurrency = product.currency || '';
//          const flyerFileName = product.solution_key || '';
          const flyerPageNo= product.pageNo.indexOf("page_") || '';
          const flyerFileName =  product.pageNo.substring(flyerPageNo);
          

          openWithOverlay(url, flyerFileName);
        }
      });
    });
    
    document.querySelectorAll('.share-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const card = this.closest('.product-card');
        const productName = card.querySelector('.product-title').textContent;
        const price = card.querySelector('.current-price').textContent;
        
        if (navigator.share) {
          navigator.share({
            title: `Ø¹Ø±Ø¶ Ù…Ù…ÙŠØ²: ${productName}`,
            text: `Ø§ÙƒØªØ´Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶: ${productName} Ø¨Ø³Ø¹Ø± ${price}`,
            url: window.location.href,
          });
        } else {
          navigator.clipboard.writeText(`Ø¹Ø±Ø¶ Ù…Ù…ÙŠØ²: ${productName} Ø¨Ø³Ø¹Ø± ${price} - ${window.location.href}`);
          alert('ØªÙ… Ù†Ø³Ø® ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶! Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ.');
        }
      });
    });
  } catch (error) {
    console.error('Error in attachCardEventListeners:', error);
  }
}

function toggleFavorite(productId) {
  try {
    const index = favorites.indexOf(productId);
    if (index === -1) {
      favorites.push(productId);
    } else {
      favorites.splice(index, 1);
    }
    localStorage.setItem('favorites', JSON.stringify(favorites));
  } catch (error) {
    console.error('Error in toggleFavorite:', error);
  }
}

/* Render table */
function renderTable(){
  try {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    const start = (currentPage-1)*itemsPerPage;
    const pageData = filteredData.slice(start, start+itemsPerPage);
    
    if (pageData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3; display: block;"></i>
            <h3 style="margin: 0 0 10px 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø·Ø§Ø¨Ù‚Ø©</h3>
            <p style="margin: 0;">Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØµØ·Ù„Ø­Ø§Øª Ø¨Ø­Ø« Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø¥Ø²Ø§Ù„Ø© Ø¨Ø¹Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ±</p>
            ${activeChipFilter === 'recent' ? '<p style="color: var(--purple); margin-top: 10px;"><i class="fas fa-info-circle"></i> Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙ„ØªØ± "Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±ÙˆØ¶" ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ®ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>' : ''}
          </td>
        </tr>
      `;
      updatePagination();
      return;
    }
    
    pageData.forEach(item=>{
      try {
        const tr = document.createElement('tr');
        const url = item.solution_key ? `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg` : '#';
//        const flyerFileName = item.solution_key || '';
 
        const flyerPageNo= item.pageNo.indexOf("page_") || '';
        const flyerFileName =  item.pageNo.substring(flyerPageNo);
       
        if(url && url!=='#'){ 
          tr.style.cursor='pointer'; 
          tr.title='Ø§Ù†Ù‚Ø± Ù„Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶'; 
          tr.onclick = ()=>{ openWithOverlay(url, flyerFileName); };
        }

        if(item._discount_pct && item._discount_pct >= 20) tr.classList.add('highlight');
        if(activeChipFilter === 'recent') tr.style.borderLeft = '3px solid var(--purple)';
        
        tr.innerHTML = `
          <td>${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
          <td><strong>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</strong></td>
          <td>${item.primaryName || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
          <td>${item.unit ? `<span class="unit-badge">${item.unit}</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
          <td>${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
          <td>${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
          <td><strong style="color: var(--primary-blue);">${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</strong></td>
          <td>${item._discount_pct ? `<span class="discount-badge" style="display: inline-block; padding: 3px 8px; background: var(--danger-red); color: white; border-radius: 4px; font-weight: 700;">${item._discount_pct}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
          <td>${item._saved ? `<span style="color: var(--success-green); font-weight: 600;">${item._saved} ${item.currency||'EGP'}</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
          <td>${item.validUntil || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
        `;
        tbody.appendChild(tr);
      } catch (itemError) {
        console.error('Error rendering table row:', itemError, item);
      }
    });
    updatePagination();
  } catch (error) {
    console.error('Error in renderTable:', error);
  }
}

/* Open overlay with specific message */
function openWithOverlay(url, flyerFileName) {
  try {
    const newWin = window.open('', '_blank');
    if (newWin) {
      newWin.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
          <meta charset="utf-8">
          <title>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬</title>
          <style>
            body { margin: 0; padding: 0; overflow: hidden; font-family: 'Cairo', sans-serif; }
            iframe { width: 100vw; height: 100vh; border: none; }
            .overlay { 
              position: fixed; 
              top: 20px; 
              left: 50%; 
              transform: translateX(-50%); 
              background: rgba(255, 255, 255, 0.95); 
              padding: 15px 25px; 
              border-radius: 8px; 
              box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
              z-index: 9999; 
              font-size: 1.1rem; 
              color: #333; 
              display: flex; 
              align-items: center; 
              gap: 10px; 
              animation: slideDown 0.3s ease-out;
            }
            .overlay button { 
              background: #00539F; 
              color: white; 
              border: none; 
              padding: 8px 15px; 
              border-radius: 5px; 
              cursor: pointer; 
              font-weight: 600; 
            }
            .overlay button:hover { background: #004080; }
            @keyframes slideDown {
              from { top: -100px; opacity: 0; }
              to { top: 20px; opacity: 1; }
            }
          </style>
          <script>
            window.addEventListener('load', function() {
              setTimeout(function() {
                document.getElementById('guide-overlay').style.display = 'flex';
              }, 1000);
            });
          <\/script>
        </head>
        <body>
          <iframe src="${url}" onload="document.getElementById('guide-overlay').style.display='flex';"></iframe>
          <div class="overlay" id="guide-overlay" style="display: none;">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø±Ù‚Ù… ${flyerFileName || ''}
            <button onclick="document.getElementById('guide-overlay').style.display='none';">Ø­Ø³Ù†Ø§Ù‹</button>
          </div>
        </body>
        </html>
      `);
      newWin.document.close();
    } else {
      window.open(url, '_blank');
    }
  } catch (error) {
    console.error('Error in openWithOverlay:', error);
    window.open(url, '_blank');
  }
}

function updatePagination(){
  try {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
    
    if (totalPages <= 1) return;
    
    const btn = (text, disabled, onClick) => { 
      const b = document.createElement('button'); 
      b.textContent = text; 
      b.disabled = !!disabled; 
      b.addEventListener('click', onClick); 
      return b; 
    };
    
    pagination.appendChild(btn('Ø§Ù„Ø£ÙˆÙ„Ù‰', currentPage===1, ()=>{ currentPage=1; renderContent(); }));
    pagination.appendChild(btn('Ø§Ù„Ø³Ø§Ø¨Ù‚', currentPage===1, ()=>{ if(currentPage>1){ currentPage--; renderContent(); }}));
    
    const pageNumbers = document.createElement('div'); 
    pageNumbers.style.display='flex'; 
    pageNumbers.style.gap='6px'; 
    pageNumbers.style.overflowX='auto';
    
    const pagesToShow = new Set([1, totalPages]);
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
      pagesToShow.add(i);
    }
    
    let prevPage = 0;
    Array.from(pagesToShow).sort((a, b) => a - b).forEach(i => {
      if (i - prevPage > 1) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.style.padding = '0 10px';
        ellipsis.style.color = '#666';
        ellipsis.style.display = 'flex';
        ellipsis.style.alignItems = 'center';
        pageNumbers.appendChild(ellipsis);
      }
      
      const p = document.createElement('button'); 
      p.textContent = i;
      if(i===currentPage){ 
        p.style.background = 'var(--primary-blue)'; 
        p.style.color='white'; 
        p.style.borderColor = 'var(--primary-blue)';
      }
      p.addEventListener('click', ()=>{ currentPage=i; renderContent(); });
      pageNumbers.appendChild(p);
      prevPage = i;
    });
    
    pagination.appendChild(pageNumbers);
    pagination.appendChild(btn('Ø§Ù„ØªØ§Ù„ÙŠ', currentPage===totalPages, ()=>{ if(currentPage<totalPages){ currentPage++; renderContent(); }}));
    pagination.appendChild(btn('Ø§Ù„Ø£Ø®ÙŠØ±Ø©', currentPage===totalPages, ()=>{ currentPage=totalPages; renderContent(); }));
  } catch (error) {
    console.error('Error in updatePagination:', error);
  }
}

function renderContent() {
  try {
    if (currentView === 'grid') {
      renderProductsGrid();
    } else {
      renderTable();
    }
  } catch (error) {
    console.error('Error in renderContent:', error);
  }
}

/* Stats */
function updateStats(){
  try {
    document.getElementById('total-offers').textContent = filteredData.length.toLocaleString();
    
    const discounts = filteredData.filter(i=>i._discount_pct).map(i=>i._discount_pct);
    const avgDiscount = discounts.length ? Math.round(discounts.reduce((a,b)=>a+b,0)/discounts.length) : 0;
    document.getElementById('avg-discount').textContent = `${avgDiscount}%`;
    
    const hotDeals = filteredData.filter(i=>i._discount_pct > 30).length;
    document.getElementById('hot-deals').textContent = hotDeals.toLocaleString();
    
    const now = new Date();
    const endingSoon = filteredData.filter(i => {
      if (!i.endDate) return false;
      const diffDays = Math.ceil((i.endDate - now) / (1000 * 60 * 60 * 24));
      return diffDays <= 3 && diffDays >= 0;
    }).length;
    document.getElementById('ending-soon').textContent = endingSoon.toLocaleString();
    
    const uniqueSupermarkets = [...new Set(filteredData.map(item => item.supermarket).filter(Boolean))].length;
    document.getElementById('total-supermarkets').textContent = uniqueSupermarkets.toLocaleString();
  } catch (error) {
    console.error('Error in updateStats:', error);
  }
}

/* Autocomplete */
function clearAutocomplete(){
  const list = document.getElementById('autocomplete-list');
  if(list) list.remove();
}

function showAutocomplete(){
  try {
    clearAutocomplete();
    const val = document.getElementById('search-input').value.trim().toLowerCase();
    if(!val) return;
    const list = document.createElement('div');
    list.id = 'autocomplete-list';
    document.body.appendChild(list);
    const suggestions = [...new Set(allData.map(i=>i.product).concat(allData.map(i=>i.primaryName||'')))]
      .filter(s=>s && String(s).toLowerCase().includes(val)).slice(0,8);
    suggestions.forEach(s=>{
      const d = document.createElement('div');
      d.textContent = s;
      d.style.padding='12px 16px';
      d.style.cursor='pointer';
      d.style.borderBottom='1px solid #f0f0f0';
      d.addEventListener('click', ()=>{
        document.getElementById('search-input').value = s;
        clearAutocomplete();
        debouncedApplyAllFilters();
      });
      d.addEventListener('mouseenter', () => d.style.background='#f8f9fa');
      d.addEventListener('mouseleave', () => d.style.background='white');
      list.appendChild(d);
    });
    const rect = document.getElementById('search-input').getBoundingClientRect();
    list.style.left = `${Math.max(8, rect.left + window.scrollX)}px`;
    list.style.top = `${rect.bottom + window.scrollY}px`;
    list.style.minWidth = `${rect.width}px`;
  } catch (error) {
    console.error('Error in showAutocomplete:', error);
  }
}

const debouncedApplyAllFilters = debounce(()=>applyAllFilters(), 250);

/* Price controls wiring and helpers */
function parseNumberInput(el){
  try {
    const v = parseFloat(el.value);
    return isFinite(v) ? v : NaN;
  } catch {
    return NaN;
  }
}

function adjustNumberInput(el, delta){
  try {
    const step = parseFloat(el.step) || 1;
    const cur = parseNumberInput(el);
    const base = isNaN(cur) ? 0 : cur;
    const next = Math.max(0, +(base + delta * step).toFixed(2));
    el.value = next;
    debouncedApplyAllFilters();
  } catch (error) {
    console.error('Error in adjustNumberInput:', error);
  }
}

function normalizeMinMax(minEl, maxEl){
  try {
    const minV = parseNumberInput(minEl);
    const maxV = parseNumberInput(maxEl);
    if(!isNaN(minV) && !isNaN(maxV) && minV > maxV){
      const tmp = minEl.value;
      minEl.value = maxEl.value;
      maxEl.value = tmp;
    }
  } catch (error) {
    console.error('Error in normalizeMinMax:', error);
  }
}

function wirePriceControls(){
  try {
    const minEl = document.getElementById('min-price');
    const maxEl = document.getElementById('max-price');
    const minDec = document.getElementById('min-decrease');
    const minInc = document.getElementById('min-increase');
    const maxDec = document.getElementById('max-decrease');
    const maxInc = document.getElementById('max-increase');

    minDec.addEventListener('click', ()=>{ adjustNumberInput(minEl, -1); });
    minInc.addEventListener('click', ()=>{ adjustNumberInput(minEl, +1); });
    maxDec.addEventListener('click', ()=>{ adjustNumberInput(maxEl, -1); });
    maxInc.addEventListener('click', ()=>{ adjustNumberInput(maxEl, +1); });

    ['input','change','keyup'].forEach(evt=>{
      minEl.addEventListener(evt, ()=>{
        normalizeMinMax(minEl, maxEl);
        debouncedApplyAllFilters();
      });
      maxEl.addEventListener(evt, ()=>{
        normalizeMinMax(minEl, maxEl);
        debouncedApplyAllFilters();
      });
    });

    minEl.addEventListener('blur', ()=>{ if(parseNumberInput(minEl) < 0 || isNaN(parseNumberInput(minEl))) minEl.value=''; debouncedApplyAllFilters(); });
    maxEl.addEventListener('blur', ()=>{ if(parseNumberInput(maxEl) < 0 || isNaN(parseNumberInput(maxEl))) maxEl.value=''; debouncedApplyAllFilters(); });
  } catch (error) {
    console.error('Error in wirePriceControls:', error);
  }
}

/* Initialize filters and event wiring */
function initializeFilters(){
  try {
    const supermarketSelect = document.getElementById('supermarket-filter');
    supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
    let supermarkets = [...new Set(allData.map(i=>i.supermarket))].filter(Boolean);
    
    supermarkets.sort((a, b) => {
      const strA = String(a || '');
      const strB = String(b || '');
      return strA.localeCompare(strB, 'ar');
    });
    
    supermarkets.forEach(s=>{ 
      const o=document.createElement('option'); 
      o.value=s; 
      o.textContent=String(s || ''); 
      supermarketSelect.appendChild(o); 
    });

    const categorySelect = document.getElementById('category-filter');
    categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
    let categories = [...new Set(allData.map(i=>i.category))].filter(Boolean);
    
    categories.sort((a, b) => {
      const strA = String(a || '');
      const strB = String(b || '');
      return strA.localeCompare(strB, 'ar');
    });
    
    categories.forEach(c=>{ 
      const o=document.createElement('option'); 
      o.value=c; 
      o.textContent=String(c || ''); 
      categorySelect.appendChild(o); 
    });

    const brandSelect = document.getElementById('brand-filter');
    brandSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</option>';
    let brands = [...new Set(allData.map(i=>i.brand))].filter(Boolean);
    
    brands.sort((a, b) => {
      const strA = String(a || '');
      const strB = String(b || '');
      return strA.localeCompare(strB, 'ar');
    });
    
    brands.forEach(b=>{ 
      const o=document.createElement('option'); 
      o.value=b; 
      o.textContent=String(b || ''); 
      brandSelect.appendChild(o); 
    });

    const search = document.getElementById('search-input');
    search.addEventListener('input', ()=>{ showAutocomplete(); debouncedApplyAllFilters(); });
    search.addEventListener('keydown', (e)=>{ 
      if(e.key === 'Enter'){ 
        e.preventDefault(); 
        clearAutocomplete(); 
        applyAllFilters(); 
      } 
    });

    document.addEventListener('click', (e)=>{
      const list = document.getElementById('autocomplete-list');
      const input = document.getElementById('search-input');
      if(!list) return;
      if(e.target.closest && (e.target.closest('#autocomplete-list') || e.target === input)) return;
      clearAutocomplete();
    });

    supermarketSelect.addEventListener('change', debouncedApplyAllFilters);
    categorySelect.addEventListener('change', debouncedApplyAllFilters);
    brandSelect.addEventListener('change', debouncedApplyAllFilters);
    document.getElementById('sort-by').addEventListener('change', debouncedApplyAllFilters);
    document.getElementById('min-discount').addEventListener('input', debouncedApplyAllFilters);

    document.getElementById('reset-btn').addEventListener('click', ()=>{ resetAllFilters(); });

    wirePriceControls();
  } catch (error) {
    console.error('Error in initializeFilters:', error);
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ±: ' + error.message);
  }
}

/* Reset ALL filters */
/* Reset ALL filters */
function resetAllFilters(){
  try {
    document.getElementById('search-input').value='';
    document.getElementById('supermarket-filter').value='';
    document.getElementById('category-filter').value='';
    document.getElementById('brand-filter').value='';
    document.getElementById('min-discount').value='';
    document.getElementById('min-price').value='';
    document.getElementById('max-price').value='';
    document.getElementById('sort-by').value='best-deals'; // Reset sort to default
    
    activeChipFilter = 'all';
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    const allChip = document.querySelector('.chip[data-filter="all"]');
    if (allChip) allChip.classList.add('active');
    
    applyAllFilters();
  } catch (error) {
    console.error('Error in resetAllFilters:', error);
  }
}

/* Fetch and prepare data - UPDATED with combined sorting */
async function fetchData(){
  try {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading').innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center;">
        <i class="fas fa-spinner fa-spin" style="font-size: 2.5rem; margin-bottom: 20px; color: var(--primary-blue);"></i>
        <h3>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶...</h3>
        <p>Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø¬Ø±</p>
      </div>
    `;

    const cached = localStorage.getItem(CACHE_KEY);
    const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
    if(cached && cachedTime && (Date.now() - cachedTime) < CACHE_EXPIRY){
      try { 
        allData = JSON.parse(LZString.decompressFromUTF16(cached)) || []; 
      } catch(e){ 
        console.warn('cache parse failed', e); 
        allData = []; 
      }
    }

    if(!allData || !allData.length){
      const res = await fetch(DATA_URL);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true, trim:true, dynamicTyping:true });
      
      console.log('Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', parsed.meta.fields);
      
      allData = parsed.data.map(item=>{
        try {
          const raw = item['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || item['Validity Period'] || '';
          const end = parseEndDate(String(raw));
          const validUntilStr = end ? formatDateShort(end) : (String(raw).split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).slice(-1)[0]||'ØºÙŠØ± Ù…ØªØ§Ø­');
          
          const updateDateStr = item['ØªØ§Ø±ÙŠØ® ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ÙÙ„Ø§ÙŠØ±'] || 
                                item['Update Date'] || 
                                item['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«'] ||
                                item['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'] ||
                                item['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'] ||
                                item['ØªØ§Ø±ÙŠØ®'] ||
                                '';
          
          let updateDate = null;
          if (updateDateStr && updateDateStr !== 'ØºÙŠØ± Ù…ØªØ§Ø­' && updateDateStr.trim() !== '') {
            try {
              updateDate = new Date(updateDateStr);
              
              if (isNaN(updateDate.getTime())) {
                const dateMatch = updateDateStr.match(/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}|\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}/);
                if (dateMatch) {
                  updateDate = new Date(dateMatch[0].replace(/\//g, '-'));
                }
              }
              
              if (isNaN(updateDate.getTime())) updateDate = null;
            } catch (e) {
              console.warn('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«:', updateDateStr, e);
              updateDate = null;
            }
          }
          
          return {
            supermarket: String(item['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || item['supermarket'] || 'ØºÙŠØ± Ù…ØªØ§Ø­'),
            product: String(item['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || 'ØºÙŠØ± Ù…ØªØ§Ø­'),
            primaryName: String(item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || ''),
            unit: String(item['Ø§Ù„ÙˆØ­Ø¯Ø©'] || item['unit'] || ''),
            category: String(item['Ø§Ù„ÙØ¦Ø©'] || item['category'] || 'ØºÙŠØ± Ù…ØªØ§Ø­'),
            brand: String(item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || item['brand'] || 'ØºÙŠØ± Ù…ØªØ§Ø­'),
            originalPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ']) || 0,
            currentPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0,
            discount: parseFloat(item['Ø§Ù„Ø®ØµÙ… %']) || 0,
            rawPeriod: raw,
            endDate: end,
            validUntil: validUntilStr,
            pageNo: String(item['Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„ÙÙ„Ø§ÙŠØ±'] || ''),
            currency: String(item['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP'),
            solution_key: String(item['solution_key']||item['solution key']||item['Solution_key']||item['solutionKey']||''),
            updateDate: updateDate,
            rawUpdateDate: updateDateStr
          };
        } catch (itemError) {
          console.error('Error parsing item:', itemError, item);
          return null;
        }
      }).filter(item => item !== null);
      
      // ØªØ³Ø¬ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
      const supermarkets = [...new Set(allData.map(i=>i.supermarket))];
      console.log('Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', supermarkets);
      
      // Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ ÙÙ„Ø§ØªØ± Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª ÙÙŠ Ø§Ù„ÙƒØ§Ø´
      supermarketFilterCache = {};
      
      try { 
        localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData))); 
        localStorage.setItem(`${CACHE_KEY}_time`, Date.now()); 
      } catch(e){ 
        console.warn('cache save failed', e); 
      }
    }

    computeSavedAndDiscount(allData);
    computeCombinedScore(allData);
    
    // Ø­Ø³Ø§Ø¨ Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ®ÙŠÙ† Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    latestTwoDates = findLatestTwoDates(allData);
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØªÙˆØ§Ø±ÙŠØ®ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
    if (latestTwoDates.length === 0) {
      console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙˆØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙˆØ§Ø±ÙŠØ® Ø¨Ø¯ÙŠÙ„Ø©');
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      latestTwoDates = [
        today.toISOString().split('T')[0],
        yesterday.toISOString().split('T')[0]
      ];
    }
    
    console.log('Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ®ÙŠÙ† Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ù…:', latestTwoDates);
    
    // ØªØ³Ø¬ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ©
    const itemsWithDate = allData.filter(item => item.updateDate || item.endDate || (item.validUntil && item.validUntil !== 'ØºÙŠØ± Ù…ØªØ§Ø­')).length;
    console.log(`Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨ØªØ§Ø±ÙŠØ®: ${itemsWithDate} Ù…Ù† ${allData.length}`);
    
    // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù…Ø±ÙƒØ¨ Ù…Ù† Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù†Ø³Ø¨ÙŠ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆÙÙŠØ±)
    allData.sort((a,b)=> {
      // First by discount percentage (descending)
      const discountDiff = (b._discount_pct || 0) - (a._discount_pct || 0);
      if (Math.abs(discountDiff) > 5) { // If discount difference is significant (5% or more)
        return discountDiff;
      }
      
      // If discount percentages are close, sort by savings amount
      const savedDiff = (b._saved || 0) - (a._saved || 0);
      if (Math.abs(savedDiff) > 0) {
        return savedDiff;
      }
      
      // Finally, sort alphabetically
      const nameA = String(a.product || '');
      const nameB = String(b.product || '');
      return nameA.localeCompare(nameB, 'ar');
    });

    initializeFilters();
    applyAllFilters();

    populateTicker();

    document.getElementById('loading').style.display = 'none';
    
    switchView('grid');
    
    updateComparisonPanel();
  } catch(err){
    console.error('Error in fetchData:', err);
    document.getElementById('loading').innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-red); margin-bottom: 20px;"></i>
        <h3>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p>${err.message}</p>
        <button onclick="fetchData()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">
          <i class="fas fa-redo"></i> Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        </button>
      </div>
    `;
    const track = document.getElementById('ticker-track');
    track.innerHTML = '<div class="ticker-item">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>';
  }
}

/* Helper function to show errors */
function showError(message) {
  console.error('App Error:', message);
  const errorDiv = document.createElement('div');
  errorDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--danger-red);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    max-width: 400px;
  `;
  errorDiv.innerHTML = `
    <strong><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£:</strong>
    <p style="margin: 5px 0 0 0; font-size: 0.9rem;">${message}</p>
  `;
  document.body.appendChild(errorDiv);
  
  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 5000);
}

/* Kick off */
document.addEventListener('DOMContentLoaded', initApp);
document.addEventListener('visibilitychange', ()=>{ 
  if(!document.hidden && allData.length === 0){ 
    fetchData(); 
  } 
});
</script><!--    // Add this to your index.html script function checkUrlForSearch() { //     1. Get the URL parameters const urlParams = new    URLSearchParams(window.location.search); // 2. Look for the 'q' parameter we    set in the Carrefour page const query = urlParams.get('q'); // 3. If found,    put it in the search box and trigger the search if (query) { const    searchInput = document.getElementById('search-input'); if (searchInput) { //    Set the value searchInput.value = decodeURIComponent(query); // Trigger the    search logic (assuming you have this function from your previous code) // If    you are using the 'applyAllFilters' function from your provided index.html:    if (typeof applyAllFilters === 'function') { applyAllFilters(); } } } } //    Call this function when the page loads    document.addEventListener('DOMContentLoaded', checkUrlForSearch); -->
    <script>
/**
 * Catch search query from URL (e.g., ?q=milk) 
 * and apply it to the AI page search bar automatically.
 */
function handleUrlSearch() {
    // 1. Parse the URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');

    if (query) {
        // 2. Find the search input in your index.html
        const searchInput = document.getElementById('search-input');
        
        if (searchInput) {
            // 3. Set the text in the box
            searchInput.value = decodeURIComponent(query);
            
            // 4. Trigger the search logic
            // We wait a tiny bit to ensure the data has finished loading
            setTimeout(() => {
                if (typeof applyAllFilters === 'function') {
                    applyAllFilters();
                } else {
                    // Fallback: trigger an 'input' event so existing listeners catch it
                    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }, 500); 
        }
    }
}

// Run the check as soon as the page is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', handleUrlSearch);
} else {
    handleUrlSearch();
}
</script> <script>
document.addEventListener("DOMContentLoaded", function () {
  const params = new URLSearchParams(window.location.search);
  const market = params.get("market");

  if (!market) return;

  const select = document.getElementById("supermarket-filter");
  if (!select) return;

  select.value = market;

  // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ÙÙ„ØªØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  select.dispatchEvent(new Event("change"));
});
    
<!-- </script>
    <script>
document.addEventListener("DOMContentLoaded", function () {
  const params = new URLSearchParams(window.location.search);
  const percent = params.get("discount");

  if (!percent) return;

  const select = document.getElementById("min-discount");
  if (!select) return;

  select.value = percent;

  // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ÙÙ„ØªØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  select.dispatchEvent(new Event("change"));
});
         
  </script>
    <!---&gt; document.querySelectorAll('.chip').forEach(chip =&gt; {    chip.addEventListener('click', () =&gt; {    document.querySelectorAll('.chip').forEach(c =&gt;    c.classList.remove('active')); chip.classList.add('active');    activeChipFilter = chip.dataset.filter; // Set supermarket filter for    specific chips const discount = document.getElementById('min-discount');    applyAllFilters(); }); -->
    <script>
document.addEventListener("DOMContentLoaded", function () {
  const params = new URLSearchParams(window.location.search);
  const weekPercent = params.get("week_percent");

  if (!Array.isArray(allItems) || allItems.length === 0) {
    hideLoadingMessage(); // Ø£Ùˆ whatever hides "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
    return;
}

  
  if (weekPercent) {
    // 1. Set the Discount Percentage Input
    const discountInput = document.getElementById("min-discount");
    if (discountInput) {
        discountInput.value = weekPercent;
    }

    // 2. Set the internal filter variable to our new 7-day mode
    // Note: We are setting the global variable 'activeChipFilter' defined in your main script
    fetchData().then(() => {
    activeChipFilter = 'recent_extended';
    applyAllFilters();
      
      console.log('Filters finished');

});


    // 3. Set sorting to "Best Deals" (to satisfy "display best offers")
    const sortSelect = document.getElementById("sort-by");
    if(sortSelect) {
        sortSelect.value = "best-deals";
    }

    // 4. Visual Feedback: Create a temporary visual "Chip" to show this mode is active
    const chipsContainer = document.getElementById('filter-chips');
    if(chipsContainer){
        // Remove active class from others
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        
        // Add a temporary chip for UI clarity
        const tempChip = document.createElement('button');
        tempChip.className = 'chip active';
        tempChip.innerHTML = '<i class="fas fa-calendar-week"></i> Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù€  7ÙŠÙˆÙ…';
        // Insert it at the beginning
        chipsContainer.insertBefore(tempChip, chipsContainer.firstChild);
    }

    // 5. Trigger the filter update
    // We assume fetchData() will call applyAllFilters() when data loads.
    // However, if data is already cached/loaded, we force an update.
    if (dataLoaded === true) {
    applyAllFilters();  document.getElementById('loading-message')?.style.display = 'none';

}

  }
});
</script> <script>
document.addEventListener("DOMContentLoaded", function () {
  const params = new URLSearchParams(window.location.search);
  const percent2 = params.get("one_day");
  if (percent2) {
   
    const discountInput2 = document.getElementById("updateDateStr");
    if (discountInput2) {
        discountInput2.value = percent2;
    }
    // 2. Set the internal filter variable to our new day mode
    // Note: We are setting the global variable 'activeChipFilter' defined in your main script
    activeChipFilter = 'recent_day';

    // 3. Set sorting to "Best Deals" (to satisfy "display best offers")
    const sortSelect2 = document.getElementById("sort-by");
    if(sortSelect2) {
        sortSelect.value = "best-deals";
    }

    // 4. Visual Feedback: Create a temporary visual "Chip" to show this mode is active
    const chipsContainer2 = document.getElementById('filter-chips');
    if(chipsContainer){
        // Remove active class from others
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        
        // Add a temporary chip for UI clarity
        const tempChip = document.createElement('button');
        tempChip.className = 'chip active';
        tempChip.innerHTML = '<i class="fas fa-calendar-day"></i> Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù€ 1 ÙŠÙˆÙ…';
        // Insert it at the beginning
        chipsContainer.insertBefore(tempChip, chipsContainer.firstChild);
    }

    // 5. Trigger the filter update
    // We assume fetchData() will call applyAllFilters() when data loads.
    // However, if data is already cached/loaded, we force an update.
    setTimeout(() => {
        if (typeof applyAllFilters === 'function') {
            applyAllFilters();
        }
    }, 1000); // Small delay to ensure data is ready
  }
});
</script>
  </body>
</html>
