<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª â€” Ù…ØµØ­Ø­</title>
<!-- External libs kept as in original for CSV parsing and compression -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<style>
  :root{ --bg-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%); --card-bg:#fff; --muted:#666; --accent:#4caf50; --danger:#ff4444; --gap:12px; --radius:12px; --text:#222; --control-height:46px; --base-font:15px; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg-1); color:var(--text); padding:16px; }
  .container{ max-width:1200px; margin:0 auto; }
  header{ background:rgba(255,255,255,0.95); border-radius:12px; padding:12px; margin-bottom:12px; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.12); }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
  input,select,button{ height:var(--control-height); padding:0 12px; border-radius:10px; border:2px solid #eee; background:white; font-size:15px; }
  #data-table{ background:var(--card-bg); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.12); overflow:hidden; margin-top:12px; padding:8px; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  thead th{ background:var(--accent); color:#fff; padding:12px; text-align:left; position:sticky; top:0; }
  tbody td{ padding:10px 12px; border-bottom:1px solid #f0f0f0; }
  .card-list{ display:none }
  .highlight{ background:#fff3b0 !important; }
  #loading{ text-align:center; padding:18px; color:#fff; }
  #query-log{ height:160px; overflow:auto; border:1px solid #ddd; padding:8px; background:#f9f9f9; white-space:pre-wrap; font-family:monospace; font-size:13px; }
  #autocomplete-list{ position:absolute; z-index:9999; background:white; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); max-height:240px; overflow:auto; }
  @media (max-width:900px){ .controls{ flex-direction:column; align-items:stretch } .card-list{ display:flex; flex-direction:column } table{ display:none } }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ğŸ›’ Ù„ÙˆØ­Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª â€” Ù…ØµØ­Ø­</h1>
    <p>Ù†Ø³Ø®Ø© Ù…ÙØ¹Ø¯Ù‘Ù„Ø©: Ø¥ØµÙ„Ø§Ø­ Ø¨Ø­Ø« Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª</p>
  </header>

  <div class="controls" role="region" aria-label="Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…">
    <input id="search-input" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©..." aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«" />
    <select id="supermarket-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª"><option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option></select>
    <select id="category-filter" aria-label="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
    <input id="min-price" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø¹Ø±" />
    <input id="max-price" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø³Ø¹Ø±" />
    <select id="sort-by" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
      <option value="">ÙØ±Ø² Ø­Ø³Ø¨</option>
      <option value="discount-desc">Ø§Ù„Ø®ØµÙ… % - ØªÙ†Ø§Ø²Ù„ÙŠ</option>
      <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± - ØªØµØ§Ø¹Ø¯ÙŠ</option>
    </select>
    <input id="min-discount" type="number" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ… %" aria-label="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø®ØµÙ…" />
    <button id="apply-btn" aria-label="ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±">ğŸ” ØªØ·Ø¨ÙŠÙ‚</button>
    <button id="reset-btn" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
  </div>

  <div class="stats" style="display:flex;gap:12px;margin-bottom:12px;">
    <div style="background:var(--card-bg);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-width:120px;">
      <div style="font-size:13px;color:var(--muted)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
      <div id="total-offers" style="font-weight:700;font-size:18px">0</div>
    </div>
    <div style="background:var(--card-bg);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-width:120px;">
      <div style="font-size:13px;color:var(--muted)">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®ØµÙ…</div>
      <div id="avg-discount" style="font-weight:700;font-size:18px">0%</div>
    </div>
  </div>

  <div id="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

  <div id="data-table" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶" style="display:none;">
    <table aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</th>
          <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>Ø§Ù„ÙØ¦Ø©</th>
          <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ</th>
          <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
          <th>Ø§Ù„Ø®ØµÙ…</th>
          <th>Ø³Ø§Ø±ÙŠ Ø­ØªÙ‰</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>

    <div class="card-list" id="card-list" aria-hidden="true"></div>
    <div class="pagination" id="pagination" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª"></div>
  </div>

  <h3>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª (Query Log)</h3>
  <div id="query-log">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>
</div>

<script>
/* ======= Configuration (keep your DATA_URL) ======= */
const DATA_URL = 'https://script.google.com/macros/s/AKfycbzD-TIVSoc4BxNhfytOM2Sbzs156Iht420hS2XCSRZkAuNIbBPnVYxQhTVEohgv0u-Fsg/exec';
const CACHE_KEY = 'offersData';
const CACHE_EXPIRY = 3600000; // 1 hour
/* ================================================= */

/* State */
let allData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 20;
let carouselInterval = null;

/* Query log */
const logStore = [];
const logEl = document.getElementById('query-log');

/* Utility helpers */
function nowISO(){ return new Date().toISOString(); }
function appendLog(entry){
  logStore.push({ts: nowISO(), ...entry});
  renderLogs();
  console.log('[QueryLog]', JSON.stringify(logStore[logStore.length-1]));
}
function renderLogs(){
  if(!logStore.length){ logEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.'; return; }
  logEl.textContent = logStore.map(l => `${l.ts} | q="${l.query}" supermarket="${l.supermarket}" category="${l.category}" minPrice=${l.minPrice} maxPrice=${l.maxPrice} minDiscount=${l.minDiscount} sort="${l.sort}" results=${l.results}`).join('\\n');
}

/* Debounce */
function debounce(fn, wait=250){
  let t;
  return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); };
}

/* Date helpers (kept from original) */
function parseEndDate(period){
  if (!period) return null;
  const s = String(period);
  const parts = s.split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).map(p=>p.trim()).filter(Boolean);
  let candidate = parts.length>1 ? parts[parts.length-1] : parts[0];
  candidate = candidate.replace(/^(Ù…Ù†|Ø¥Ù„Ù‰|Ø­ØªÙ‰)\\s*/i,'').trim();
  let d = new Date(candidate);
  if (isNaN(d)) {
    const dm = candidate.match(/(\\d{1,2})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{2,4})/);
    if (dm){
      let day=dm[1].padStart(2,'0'), month=dm[2].padStart(2,'0'), year=dm[3];
      if (year.length===2) year='20'+year;
      d = new Date(`${year}-${month}-${day}`);
    } else {
      const ym = candidate.match(/(\\d{4})[\\/\\.-](\\d{1,2})[\\/\\.-](\\d{1,2})/);
      if (ym) d = new Date(`${ym[1]}-${ym[2].padStart(2,'0')}-${ym[3].padStart(2,'0')}`);
    }
  }
  return (d instanceof Date && !isNaN(d.getTime())) ? d : null;
}
function isValidDate(d){ return d instanceof Date && !isNaN(d.getTime()); }
function formatDateShort(d){ if(!isValidDate(d)) return 'ØºÙŠØ± Ù…ØªØ§Ø­'; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

/* Compute saved & discount */
function computeSavedAndDiscount(arr){
  arr.forEach(item=>{
    const orig = Number(item.originalPrice) || 0;
    const curr = Number(item.currentPrice) || 0;
    let saved = 0;
    if (orig>0 && curr>0) saved = orig - curr;
    else if (orig>0 && item.discount) saved = orig * (Number(item.discount)/100);
    else if (curr>0 && item.discount) saved = curr * (Number(item.discount)/100);
    item._saved = Math.max(0, Number((saved||0).toFixed(2)));
    item._discount_pct = (item.discount && !isNaN(item.discount)) ? Number(item.discount) : (orig>0 && curr>0 ? Math.round(((orig-curr)/orig)*100) : 0);
  });
}
function computeCombinedScore(arr){
  if(!arr || !arr.length) return;
  const savedVals = arr.map(i=>i._saved||0), pctVals = arr.map(i=>i._discount_pct||0);
  const maxSaved = Math.max(...savedVals,0), minSaved = Math.min(...savedVals,0);
  const maxPct = Math.max(...pctVals,0), minPct = Math.min(...pctVals,0);
  const savedRange = (maxSaved - minSaved) || 1;
  const pctRange = (maxPct - minPct) || 1;
  arr.forEach(item=>{
    const ns = ((item._saved||0)-minSaved)/savedRange;
    const np = ((item._discount_pct||0)-minPct)/pctRange;
    item._score = Math.max(ns, np);
  });
}

/* Flyer helper */
const supermarketUrls = { "2B":"https://2b.com.eg/", "BIM":"https://www.bim.eg/", "Carrefour":"https://www.carrefouregypt.com/mafegy/ar" };
function flyerFor(item){ if(item.solution_key) return `https://www.yabalashoffers.com/flyer.php?d=${encodeURIComponent(item.solution_key)}&c=eg`; return supermarketUrls[item.supermarket] || '#'; }

/* Rendering */
function renderTable(){
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  const start = (currentPage-1)*itemsPerPage;
  const pageData = filteredData.slice(start, start+itemsPerPage);
  pageData.forEach(item=>{
    const tr = document.createElement('tr');
    const url = flyerFor(item);
    if(url && url!=='#'){ tr.style.cursor='pointer'; tr.title='Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶'; tr.onclick = ()=>window.open(url, '_blank'); }
    if(item._discount_pct && item._discount_pct >= 20) tr.classList.add('highlight');
    tr.innerHTML = `
      <td>${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.category || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.brand || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.originalPrice ? item.originalPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item._discount_pct ? `<span class="discount-badge">${item._discount_pct}%</span>` : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
      <td>${item.validUntil || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
    `;
    tbody.appendChild(tr);
  });
  renderCardList();
}
function renderCardList(){
  const list = document.getElementById('card-list');
  list.innerHTML = '';
  const start = (currentPage-1)*itemsPerPage;
  const pageData = filteredData.slice(start, start+itemsPerPage);
  pageData.forEach(item=>{
    const card = document.createElement('article');
    card.className = 'offer-card';
    const url = flyerFor(item);
    if(item._discount_pct && item._discount_pct >= 20) card.classList.add('highlight-card');
    card.innerHTML = `
      <div class="left">
        <h4>${item.product || 'ØºÙŠØ± Ù…ØªØ§Ø­'}</h4>
        <div class="offer-meta">${item.supermarket || 'ØºÙŠØ± Ù…ØªØ§Ø­'} â€” ${item.category || ''}</div>
        <div style="margin-top:8px">
          <span class="offer-price">${item.currentPrice ? item.currentPrice + ' ' + (item.currency||'EGP') : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</span>
          ${item._saved ? `<span class="offer-saved">ÙˆÙØ± ${item._saved} ${item.currency||'EGP'}</span>` : ''}
          ${item._discount_pct ? `<span style="margin-left:8px" class="discount-badge">${item._discount_pct}%</span>` : ''}
        </div>
      </div>
    `;
    if(url && url!=='#') card.addEventListener('click', ()=> window.open(url, '_blank'));
    list.appendChild(card);
  });
}
function updatePagination(){
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
  const btn = (text, disabled, onClick) => { const b = document.createElement('button'); b.textContent = text; b.disabled = !!disabled; b.addEventListener('click', onClick); return b; };
  pagination.appendChild(btn('Ø§Ù„Ø£ÙˆÙ„Ù‰', currentPage===1, ()=>{ currentPage=1; renderTable(); updatePagination(); }));
  pagination.appendChild(btn('Ø§Ù„Ø³Ø§Ø¨Ù‚', currentPage===1, ()=>{ if(currentPage>1){ currentPage--; renderTable(); updatePagination(); }}));
  const pageNumbers = document.createElement('div'); pageNumbers.style.display='flex'; pageNumbers.style.gap='6px'; pageNumbers.style.overflowX='auto';
  for(let i=1;i<=totalPages;i++){
    const p = document.createElement('button'); p.textContent = i;
    if(i===currentPage){ p.style.background = 'var(--accent)'; p.style.color='white'; }
    p.addEventListener('click', ()=>{ currentPage=i; renderTable(); updatePagination(); });
    pageNumbers.appendChild(p);
  }
  pagination.appendChild(pageNumbers);
  pagination.appendChild(btn('Ø§Ù„ØªØ§Ù„ÙŠ', currentPage===totalPages, ()=>{ if(currentPage<totalPages){ currentPage++; renderTable(); updatePagination(); }}));
  pagination.appendChild(btn('Ø§Ù„Ø£Ø®ÙŠØ±Ø©', currentPage===totalPages, ()=>{ currentPage=totalPages; renderTable(); updatePagination(); }));
}

/* Stats */
function updateStats(){
  document.getElementById('total-offers').textContent = filteredData.length;
  const discounts = filteredData.filter(i=>i._discount_pct).map(i=>i._discount_pct);
  const avgDiscount = discounts.length ? Math.round(discounts.reduce((a,b)=>a+b,0)/discounts.length) : 0;
  document.getElementById('avg-discount').textContent = `${avgDiscount}%`;
}

/* Autocomplete (stable) */
function clearAutocomplete(){
  const list = document.getElementById('autocomplete-list');
  if(list) list.remove();
}
function showAutocomplete(){
  clearAutocomplete();
  const val = document.getElementById('search-input').value.trim().toLowerCase();
  if(!val) return;
  const list = document.createElement('div');
  list.id = 'autocomplete-list';
  document.body.appendChild(list);
  const suggestions = [...new Set(allData.map(i=>i.product).concat(allData.map(i=>i.primaryName||'')))]
    .filter(s=>s && s.toLowerCase().includes(val)).slice(0,8);
  suggestions.forEach(s=>{
    const d = document.createElement('div');
    d.textContent = s;
    d.style.padding='8px 10px';
    d.style.cursor='pointer';
    d.addEventListener('click', ()=>{
      document.getElementById('search-input').value = s;
      clearAutocomplete();
      debouncedApplyFilters();
    });
    list.appendChild(d);
  });
  // position under input (works for RTL too)
  const rect = document.getElementById('search-input').getBoundingClientRect();
  list.style.left = `${Math.max(8, rect.left + window.scrollX)}px`;
  list.style.top = `${rect.bottom + window.scrollY}px`;
  list.style.minWidth = `${rect.width}px`;
}

/* Core filtering function */
function applyFilters(logInvocation = true){
  const search = (document.getElementById('search-input').value || '').trim().toLowerCase();
  const supermarket = document.getElementById('supermarket-filter').value || '';
  const category = document.getElementById('category-filter').value || '';
  const minDiscount = parseFloat(document.getElementById('min-discount').value) || 0;
  const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
  const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
  const sort = document.getElementById('sort-by').value || '';

  filteredData = allData.filter(item=>{
    const prod = (item.product||'').toString().toLowerCase();
    const primary = (item.primaryName||'').toString().toLowerCase();
    const brand = (item.brand||'').toString().toLowerCase();
    const supermarketMatch = !supermarket || (item.supermarket === supermarket);
    const categoryMatch = !category || (item.category === category);
    const priceVal = Number(item.currentPrice) || 0;
    const priceMatch = priceVal >= minPrice && priceVal <= maxPrice;
    const discountMatch = (item._discount_pct||0) >= minDiscount;
    const textMatch = !search || prod.includes(search) || primary.includes(search) || brand.includes(search) || (item.supermarket||'').toString().toLowerCase().includes(search);
    return supermarketMatch && categoryMatch && priceMatch && discountMatch && textMatch;
  });

  if(sort === 'discount-desc') filteredData.sort((a,b)=> (b._discount_pct||0)-(a._discount_pct||0));
  else if(sort === 'price-asc') filteredData.sort((a,b)=> (a.currentPrice||0)-(b.currentPrice||0));

  currentPage = 1;
  renderTable();
  updateStats();
  updatePagination();

  if(logInvocation){
    appendLog({
      query: document.getElementById('search-input').value || '',
      supermarket, category,
      minPrice: isFinite(minPrice) ? minPrice : '',
      maxPrice: isFinite(maxPrice) ? (maxPrice===Infinity ? '' : maxPrice) : '',
      minDiscount, sort,
      results: filteredData.length
    });
  }
}

/* Debounced wrapper */
const debouncedApplyFilters = debounce(()=>applyFilters(true), 250);

/* Initialize filters and event wiring (fix: wire all inputs) */
function initializeFilters(){
  const supermarketSelect = document.getElementById('supermarket-filter');
  supermarketSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>';
  const supermarkets = [...new Set(allData.map(i=>i.supermarket))].filter(Boolean);
  supermarkets.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; supermarketSelect.appendChild(o); });

  const categorySelect = document.getElementById('category-filter');
  categorySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
  const categories = [...new Set(allData.map(i=>i.category))].filter(Boolean);
  categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; categorySelect.appendChild(o); });

  const search = document.getElementById('search-input');
  search.addEventListener('input', ()=>{ showAutocomplete(); debouncedApplyFilters(); });
  search.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); clearAutocomplete(); applyFilters(true); } });

  // --- FIX: wire numeric inputs and discount to trigger filtering consistently ---
  document.getElementById('min-price').addEventListener('input', debouncedApplyFilters);
  document.getElementById('max-price').addEventListener('input', debouncedApplyFilters);
  document.getElementById('min-discount').addEventListener('input', debouncedApplyFilters);

  supermarketSelect.addEventListener('change', debouncedApplyFilters);
  categorySelect.addEventListener('change', debouncedApplyFilters);
  document.getElementById('sort-by').addEventListener('change', debouncedApplyFilters);

  document.getElementById('apply-btn').addEventListener('click', ()=>{ clearAutocomplete(); applyFilters(true); });
  document.getElementById('reset-btn').addEventListener('click', ()=>{ resetFilters(); appendLog({query:'', supermarket:'', category:'', minPrice:'', maxPrice:'', minDiscount:'', sort:'', results:filteredData.length, note:'reset'}); });

  // clear autocomplete only when clicking outside both input and the list
  document.addEventListener('click', (e)=>{
    const list = document.getElementById('autocomplete-list');
    const input = document.getElementById('search-input');
    if(!list) return;
    if(e.target.closest && (e.target.closest('#autocomplete-list') || e.target === input)) return;
    clearAutocomplete();
  });

  // reposition autocomplete on resize/scroll
  window.addEventListener('resize', clearAutocomplete);
  window.addEventListener('scroll', clearAutocomplete);
}

/* Reset filters */
function resetFilters(){
  document.getElementById('search-input').value='';
  document.getElementById('supermarket-filter').value='';
  document.getElementById('category-filter').value='';
  document.getElementById('min-discount').value='';
  document.getElementById('min-price').value='';
  document.getElementById('max-price').value='';
  document.getElementById('sort-by').value='';
  applyFilters(true);
}

/* Fetch and prepare data (keeps original CSV parsing + caching logic) */
async function fetchData(){
  try{
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading').textContent = 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

    const cached = localStorage.getItem(CACHE_KEY);
    const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
    if(cached && cachedTime && (Date.now() - cachedTime) < CACHE_EXPIRY){
      try{ allData = JSON.parse(LZString.decompressFromUTF16(cached)) || []; } catch(e){ console.warn('cache parse failed', e); allData = []; }
    }

    if(!allData || !allData.length){
      const res = await fetch(DATA_URL);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true, trim:true, dynamicTyping:true });
      allData = parsed.data.map(item=>{
        const raw = item['ÙØªØ±Ø© Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø¹Ø±Ø¶'] || item['Validity Period'] || '';
        const end = parseEndDate(String(raw));
        const validUntilStr = end ? formatDateShort(end) : (String(raw).split(/to|Ø¥Ù„Ù‰|Ø­ØªÙ‰|â€“|â€”|-|~/i).slice(-1)[0]||'ØºÙŠØ± Ù…ØªØ§Ø­');
        return {
          supermarket: item['Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª'] || item['supermarket'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          product: item['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          primaryName: item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Product'] || '',
          category: item['Ø§Ù„ÙØ¦Ø©'] || item['category'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          brand: item['Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'] || item['brand'] || 'ØºÙŠØ± Ù…ØªØ§Ø­',
          originalPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ']) || 0,
          currentPrice: parseFloat(item['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0,
          discount: parseFloat(item['Ø§Ù„Ø®ØµÙ… %']) || 0,
          promotion: item['Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ©'] || '',
          rawPeriod: raw,
          endDate: end,
          validUntil: validUntilStr,
          currency: item['Ø§Ù„Ø¹Ù…Ù„Ø©'] || 'EGP',
          solution_key: (item['solution_key']||item['solution key']||item['Solution_key']||item['solutionKey']||'')
        };
      });
      try{ localStorage.setItem(CACHE_KEY, LZString.compressToUTF16(JSON.stringify(allData))); localStorage.setItem(`${CACHE_KEY}_time`, Date.now()); } catch(e){ console.warn('cache save failed', e); }
    }

    computeSavedAndDiscount(allData);
    computeCombinedScore(allData);
    allData.sort((a,b)=>{ if((b._score||0)!==(a._score||0)) return (b._score||0)-(a._score||0); if((b._saved||0)!==(a._saved||0)) return (b._saved||0)-(a._saved||0); return (b._discount_pct||0)-(a._discount_pct||0); });

    initializeFilters();
    applyFilters(true);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('data-table').style.display = 'block';
  } catch(err){
    console.error(err);
    document.getElementById('loading').textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}`;
    appendLog({query:'<load-error>', supermarket:'', category:'', minPrice:'', maxPrice:'', minDiscount:'', sort:'', results:0, error:err.message});
  }
}

/* Kick off */
document.addEventListener('DOMContentLoaded', fetchData);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ /* re-render if needed */ } });

</script>
</body>
</html>
